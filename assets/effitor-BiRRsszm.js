import{v as lr,t as hr,g as cr,f as dr,a as ur,b as fr,n as gr}from"./mdast-util-BIpsjw1L.js";var mr=Object.defineProperty,J=(e,t)=>{for(var r in t)mr(e,r,{get:t[r],enumerable:!0})};globalThis.requestIdleCallback?Object.defineProperties(globalThis,{requestIdleCallbackPolyByEffitor:{value:globalThis.requestIdleCallback,writable:!1},cancelIdleCallbackPolyByEffitor:{value:globalThis.cancelIdleCallback,writable:!1}}):Object.defineProperties(globalThis,{requestIdleCallbackPolyByEffitor:{value:(e,t)=>globalThis.setTimeout(e,t?.timeout??500),writable:!1},cancelIdleCallbackPolyByEffitor:{value:e=>{globalThis.clearTimeout(e)},writable:!1}});var pr=navigator.userAgentData?navigator.userAgentData.platform==="macOS":/Mac/.test(navigator.userAgent),Er=navigator.userAgentData?navigator.userAgentData.platform==="Windows":/Win/.test(navigator.userAgent),_r=/Chrome/.test(navigator.userAgent),Ze=/Firefox/.test(navigator.userAgent),Cr=/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent),L={locale:navigator.language,isMac:pr,isWin:Er,isFirefox:Ze,isSafari:Cr,isSupportInsertFromComposition:!_r&&!Ze},he={UNDO_LENGTH:1e3,ALLOW_MOUNT_WHILE_MOUNTED:!1,AUTO_CREATE_FIRST_PARAGRAPH:!0,WITH_EDITOR_DEFAULT_LOGGER:!1,AUTO_REPLACE_FULL_WIDTH_PUNC_WITH_HALF_AFTER_SPACE:!0,INSERT_BR_FOR_LINE_BREAK:!1,USE_HOST_AS_SCROLL_CONTAINER:!1},f={};J(f,{cloneEtElement:()=>kr,cloneEtParagraph:()=>Pr,connectedNodeIndex:()=>Ar,createText:()=>vr,el:()=>yr,elWithAttrs:()=>ht,elementAsEtEl:()=>br,extractElementContents:()=>qr,findEffectParent:()=>Rr,fragmentToHTML:()=>jr,isBrElement:()=>Fr,isElement:()=>De,isElementOrText:()=>Ir,isEmptyContentNode:()=>Wr,isEqualClass:()=>ut,isEqualElement:()=>dt,isEqualHtmlAttrs:()=>ft,isEqualNode:()=>Kr,isEqualProperties:()=>gt,isFragment:()=>xr,isHTMLElement:()=>Mr,isLeadingZWS:()=>Ur,isNodeBeforeTheOther:()=>Lr,isNotEditable:()=>Br,isRawEditElement:()=>Or,isText:()=>Ee,isTrailingZWS:()=>ct,isWithinFirst:()=>Dr,isWithinLast:()=>Hr,nodeIndex:()=>Nr,nodeLength:()=>Sr,prevSiblingCount:()=>Le,pureEditableDiv:()=>wr,removeStatusClassForEl:()=>fe,zwsText:()=>Tr});var q=Symbol("etCode"),Je=Symbol("inEtCode"),Xe=Symbol("notInEtCode"),xe={PlainText:1,RichText:2,Block:4,Paragraph:8,Blockquote:16,Heading:32,Component:64,Embedment:128,Uneditable:256,AllowEmpty:512},Pe=Object.keys(xe).length,Re=new Map,T={Em:xe,get:e=>{let t=Re.get(e);if(t)return t;if(Pe>=30)throw Pe=0,Error("!! etcode has reached the maximum limit. it would cause some problems.");return t=1<<Pe++,Re.set(e,t),t},check:(e,t)=>t===void 0?e[q]!==void 0:!!(e[q]&&e[q]&t),checkIn:(e,t,r=0)=>{typeof e=="object"&&(r=e.notInEtCode,e=e.inEtCode);const n=typeof t=="number"?t:t.etCode;return n===void 0?!0:r&n?!1:!!(e&n)},checkSum:e=>{if(!e.children)return 0;let t=0,r=0;for(const n of e.children)(r=n.etCode)&&(t|=r);return t},parseCode:e=>{const t=new Set;for(const[r,n]of[...Object.entries(xe),...Re.entries()].sort((a,i)=>a[1]-i[1]))e&n&&(e-=e&n,t.add(r));return[...t.keys()]}},Tr=()=>document.createTextNode("​"),vr=e=>document.createTextNode(e),yr=(e,t,r)=>{const n=document.createElement(e);return t&&(n.className=typeof t=="string"?t:t.join(" ")),r&&(typeof r=="string"?n.style.cssText=r:Object.assign(n.style,r)),n},ht=(e,t,r=[])=>{const n=document.createElement(e);if(t.item)for(const a of t)r.includes(a.name)||n.setAttribute(a.name,a.value);else for(const a in t)r.includes(a)||n.setAttribute(a,t[a]);return n},br=(e,t,r=["contenteditable"])=>{const n=ht(e,t.attributes,r);return n.classList.add(t.localName),n},wr=e=>{const t=document.createElement("div");return t.contentEditable=e?"plaintext-only":"true",t.tabIndex=0,t.spellcheck=!1,t.autocorrect=!1,t.autocapitalize="none",t},Sr=e=>Ee(e)?e.length:e.childNodes.length,Nr=e=>e.parentNode?Le(e):-1,Ar=e=>e.isConnected?Le(e):-1,Le=e=>{let t=0;for(e=e.previousSibling;e;)t++,e=e.previousSibling;return t},kr=(e,t)=>{const r=e.cloneNode(t);r.removeAttribute("id");const n=document.createTreeWalker(r,1,a=>(T.check(a)&&(a.removeAttribute("id"),fe(a)),3));for(;n.nextNode(););return fe(r)},Pr=(e,t=[])=>{const r=e.cloneNode(!1);return r.removeAttribute("id"),fe(r,t)},fe=(e,t=[])=>(e.classList.remove(...t,"Et--active","Et--caret-in","Et--selected"),e),Rr=(e,t="et-body")=>{for(;e;){if(e.etCode!==void 0)return e;if(e.localName===t)return null;e=e.parentNode}return null},Ee=e=>e?.nodeType===3,De=e=>e?.nodeType===1,Mr=e=>e instanceof HTMLElement,Ir=e=>e.nodeType===1||e.nodeType===3,xr=e=>e.nodeType===11,Fr=e=>e.localName==="br",Br=e=>{if(["br","svg","img","audio","video"].includes(e.localName))return!0;if(Ee(e)){if(!e.parentElement)return!1;e=e.parentElement}return e.isConnected?!e.isContentEditable:e instanceof HTMLElement?e.contentEditable==="false":!0},Or=e=>e?e.nodeName==="TEXTAREA"||e.nodeName==="INPUT"&&e.type==="text":!1,Lr=(e,t)=>e.compareDocumentPosition(t)&4,Dr=(e,t)=>{let r=t.firstChild;for(;r;){if(r===e)return!0;r=r.firstChild}return!1},Hr=(e,t)=>{let r=t.lastChild;for(;r;){if(r===e)return!0;r=r.lastChild}return!1},Ur=(e,t)=>{if(t<=0)return!1;for(;t--;)if(e[t]!=="​")return!1;return!0},ct=(e,t)=>{if(t>=e.length)return!1;for(;t<e.length;){if(e[t]!=="​")return!1;t++}return!0},Wr=e=>{const t=e.textContent;return!t||ct(t,0)},Kr=(e,t)=>e===t?!0:e.nodeType!==t.nodeType?!1:Ee(e)?!0:T.check(e)?e.isEqualTo(t):De(e)?dt(e,t):!1,dt=(e,t,r=[])=>e.localName===t.localName&&ut(e.className,t.className,r)&&ft(e,t)&&gt(e,t),ut=(e,t,r=[])=>{r.push("","Et--active","Et--selected","Et--caret-in");const n=new Set(e.split(" ")),a=new Set(t.split(" "));for(const i of r)n.delete(i),a.delete(i);return!(n.size!==a.size||n.union(a).size!==n.size)},ft=(e,t)=>(e=e.cloneNode(),t=t.cloneNode(),e.removeAttribute("class"),e.removeAttribute("style"),t.removeAttribute("class"),t.removeAttribute("style"),e.isEqualNode(t)),gt=(e,t)=>{const r={...e},n={...t},a=Object.keys(r);if(a.length!==Object.keys(n).length)return!1;for(const i in a)if(r[i]!==n[i])return!1;return!0},jr=e=>{let t="";for(const r of e.childNodes)t+=De(r)?r.outerHTML:r.textContent;return t},qr=e=>{const t=document.createDocumentFragment();let r;for(;r=e.firstChild;)t.appendChild(r);return t},C={};J(C,{inclusiveClosestEditableAncestor:()=>an,innermostEditableFirstChild:()=>ln,innermostEditableLastChild:()=>hn,innermostFirstChild:()=>Fe,innermostLastChild:()=>Ue,innermostPosition:()=>on,isPositionAtFirstLineOf:()=>Yr,isPositionAtLastLineOf:()=>en,outerElements:()=>sn,outermostAncestorUnderTheNode:()=>tn,outermostAncestorWithSelfAsOnlyChild:()=>rn,outermostAncestorWithSelfAsOnlyChildButUnder:()=>nn,textOffsetOf:()=>Gr,textPositionOf:()=>$r,traverseNode:()=>_e,traverseRange:()=>zr,treeNextEditableText:()=>Jr,treeNextNode:()=>mt,treeNextSibling:()=>Qr,treePrevEditableText:()=>Xr,treePrevNode:()=>He,treePrevSibling:()=>Zr});var Vr=e=>{const{startContainer:t,endContainer:r,commonAncestorContainer:n}=e;if(t===r)return[null,null];let a=null,i=null;if(r!==n)for(i=r;i&&i.parentNode!==n;)i=i.parentNode;if(t!==n)for(a=t;a&&a.parentNode!==n;)a=a.parentNode;return[a,i]},zr=(e,t,{whatToShow:r=5,filter:n=null}={})=>{if(e.collapsed)return;const a=[],{startContainer:i,startOffset:s,endContainer:o,endOffset:l}=e,h=n?E=>{n(E)===1&&t(E)}:E=>{t(E)},u=E=>{f.isText(E)?r&4&&h(E):r&1&&h(E)},[g,m]=Vr(e);if(g===null&&m===null)if(f.isText(i)){r&4&&h(i);return}else for(let E=s;E<l;E++)a.push(i.childNodes.item(E));else{let E=g?g.nextSibling:i.childNodes.item(s);const y=m||o.childNodes.item(l);for(;E&&E!==y;)a.push(E),E=E.nextSibling}let p,b,v=!0,k=!1;if(f.isText(i)?(p=i,v=p.length!==s):(p=i.childNodes.item(s),p||(p=i,v=!1)),f.isText(o)?(b=o,k=b.length!==0):(b=o.childNodes.item(l),b||(b=o,k=!0)),g){const E=N=>{if(f.isText(N))r&4&&h(N);else if(N.childNodes.length===0)r&1&&h(N);else{const A=document.createTreeWalker(N,5,n);do u(A.currentNode);while(A.nextNode())}};let y=p;for(v&&E(p);y&&y!==g;){let N=y.nextSibling;for(;N;)E(N),N=N.nextSibling;y=y.parentNode,r&1&&h(y)}}for(const E of a){const y=document.createTreeWalker(E,5,n);do u(y.currentNode);while(y.nextNode())}if(m){const E=document.createTreeWalker(m,5,n);do{if(E.currentNode===b){k&&u(E.currentNode);break}u(E.currentNode)}while(E.nextNode())}},_e=(e,t,{whatToShow:r=5,filter:n=null}={})=>{const a=document.createTreeWalker(e,r,n);if(t){for(;a.nextNode();)if(t(a.currentNode))return}else if(n)for(;a.nextNode(););},Gr=(e,t)=>{if(!f.isText(t.container))return 0;if(e===t.container)return t.offset;let r=0;return _e(e,n=>{if(n===t.container)return r+=Math.min(t.offset,n.length),!0;r+=n.length},{whatToShow:4}),r},$r=(e,t)=>{let r=0,n=null;return _e(e,a=>{if(r+a.length>=t)return n=a,r=t-r,!0;r+=a.length},{whatToShow:4}),n?{container:n,offset:r}:null},mt=e=>{if(e.firstChild)return e.firstChild;if(e.nextSibling)return e.nextSibling;let t=e.parentNode;for(;t;){if(t.nextSibling)return t.nextSibling;t=t.parentNode}return null},He=e=>{let t=e.previousSibling;if(t){let r=t.lastChild;for(;r;)t=r,r=r.lastChild;return t}return e.parentNode},Qr=e=>{let t=e.nextSibling;if(t)return t;let r=e.parentNode;for(;r;){if(t=r.nextSibling,t)return t;r=r.parentNode}return null},Zr=e=>{let t=e.previousSibling;if(t)return t;let r=e.parentNode;for(;r;){if(t=r.previousSibling,t)return t;r=r.parentNode}return null},Jr=(e,t="et-body")=>{for(;e&&e.localName!==t;){if(e.nodeType===3&&e.parentElement?.isContentEditable)return e;e=mt(e)}return null},Xr=(e,t="et-body")=>{for(;e&&e.localName!==t;){if(e.nodeType===3&&e.parentElement?.isContentEditable)return e;e=He(e)}return null},Yr=(e,t)=>{if(!e.isConnected||!t.container.isConnected||!e.contains(t.container))return!1;let r;if(_e(e,o=>o.length?(r=o,!0):!1,{whatToShow:4}),!r)return!1;const n=document.createRange();n.setStart(r,0);const a=n.getClientRects()[0];if(!a)return!1;const i=document.createRange();i.setStart(t.container,t.offset);const s=i.getClientRects()[0];return s?s.top-a.bottom<2:!1},en=(e,t)=>{if(!e.isConnected||!t.container.isConnected||!e.contains(t.container))return!1;let r=null,n=Ue(e);for(;n&&n!==e;){if(n.nodeType===3&&n.length>0){r=n;break}n=He(n)}if(!r)return!1;const a=document.createRange();a.setStart(r,r.length);const i=a.getClientRects()[0];if(!i)return!1;const s=document.createRange();s.setStart(t.container,t.offset);const o=s.getClientRects()[0];return o?i.top-o.bottom<2:!1},tn=(e,t)=>{if(e===t)return e;let r=e.parentNode;for(;r&&r!==t;)e=r,r=r.parentNode;return e},rn=(e,t,r="et-body")=>{if(e.localName===r)return e;let n=e.parentNode;for(;n&&n.childNodes.length===1&&n.localName!==r&&(!t||!T.check(n,520));)e=n,n=n.parentNode;return e},nn=(e,t,r,n="et-body")=>{if(e===t||e.localName===n)return e;let a=e.parentNode;for(;a&&a.childNodes.length===1&&a!==t&&a.localName!==n&&(!r||!T.check(a,520));)e=a,a=a.parentNode;return e},an=(e,t="et-body")=>{if(f.isHTMLElement(e)&&e.isContentEditable)return e;let r=e.parentElement;for(;r;){if(r.isContentEditable||r.localName===t)return r;r=r.parentElement}return e},sn=(e,t,r="et-body")=>{const n=[];let a=e.nodeType===1?e:e.parentElement;if(t)for(;a&&a.localName!==r;)a.localName===t&&n.push(a),a=a.parentElement;else for(;a&&a.localName!==r;)n.push(a),a=a.parentElement;return n},Fe=e=>{for(;e.hasChildNodes();)e=e.firstChild;return e},Ue=e=>{for(;e.hasChildNodes();)e=e.lastChild;return e},on=(e,t)=>f.isText(e)?{container:e,offset:t}:t===0?(e=Fe(e),{container:e,offset:0}):t===e.childNodes.length?(e=Ue(e),{container:e,offset:f.isText(e)?e.length:1}):{container:Fe(e.childNodes.item(t)),offset:0},ln=e=>{let t=e;for(;t;){if(!f.isElement(t)||t.isContentEditable===void 0||t.getAttribute("contenteditable")==="false")return t;e=t,t=t.firstChild}return e},hn=e=>{let t=e;for(;t;){if(!f.isElement(t)||t.isContentEditable===void 0||t.getAttribute("contenteditable")==="false")return t;e=t,t=t.lastChild}return e},as=e=>e.trim().replaceAll("​",""),is=(e,t,r=!0)=>{let n=r?0:Date.now();return function(...a){const i=Date.now();if(i-n>t)return n=i,e.apply(this,a)}},Be=(e,t={})=>{for(const r of e)for(const n in r)t[n]?t[n].push(r[n]):t[n]=[r[n]];return t},ss=(e,t)=>{const r=Be(e),n={};for(const a in r){const i=r[a];n[a]=(...s)=>{let o;for(const l of i)if(o=l(...s))return o}}return n},We=class{__isInRaw=!1;__connected=!1;isInRaw(){return!1}markConnected(){return this.__connected=!0,this}toTextAffinity(){return this}},S=class O extends We{constructor(t,r,n){super(),this._isTextAffinity=n,this._anchor=t,this._offset=r}_anchor;_offset;get anchor(){return this._anchor}get offset(){return this._offset}get isAnchorIn(){return Number.isFinite(this.offset)}get isAnchorBefore(){return this.offset===-1/0}get isSurroundText(){return f.isText(this.anchor)&&this.offset>0&&this.offset<this.anchor.length}get isConnected(){return this.__connected?!0:this._anchor.isConnected?(this.toReality(),this.__connected=!0):this.__connected=!1}toReality(){if(this.isAnchorIn){this._offset=Math.max(0,Math.min(this.offset,f.nodeLength(this._anchor)));return}if(!this._anchor.parentNode)return;const t=this._anchor;this._anchor=this._anchor.parentNode,this.isAnchorBefore?this._offset=f.prevSiblingCount(t):this._offset=f.prevSiblingCount(t)+1}moved(t){if(t===0)return this;let r=this.offset+t;return r<0?r=0:r>(t=f.nodeLength(this.anchor))&&(r=t),new O(this.anchor,r)}toCaret(){return this}toRange(){if(!this.isConnected)return null;const t=document.createRange();return t.setStart(this.anchor,this.offset),t}adoptToRange(t,r=!0,n=!0){this.isConnected&&(r&&t.setStart(this.anchor,this.offset),n&&t.setEnd(this.anchor,this.offset))}compareTo(t){if(this.anchor===t.anchor)return this.offset-t.offset;let r=f.isText(this.anchor)?this.anchor:this.anchor.childNodes.item(this.offset),n=f.isText(t.anchor)?t.anchor:t.anchor.childNodes.item(t.offset);return r||(r=this.anchor),n||(n=t.anchor),r.compareDocumentPosition(n)&2?-1:1}isCaret(){return!0}isEqualTo(t){return t.isCaret()&&this.anchor===t.anchor&&this.offset===t.offset}isAffinityTo(t){if(this.isEqualTo(t)||this.anchor===t.anchor&&this.anchor.textContent==="​")return!0;if(this.isSurroundText||t.isSurroundText)return!1;const{container:r,offset:n}=C.innermostPosition(this.anchor,this.isAnchorIn?this.offset:this.isAnchorBefore?0:f.nodeLength(this.anchor)),{container:a,offset:i}=C.innermostPosition(t.anchor,t.isAnchorIn?t.offset:t.isAnchorBefore?0:f.nodeLength(t.anchor));if(r===a)return r.textContent==="​"?!0:n===i;let s,o;if(n===0){if(i===0)return!1;s=a,o=r}else{if(i!==0)return!1;s=r,o=a}return s=C.treeNextSibling(s),s?(s=C.innermostPosition(s,0).container,s===o):!1}toTextAffinity(){if(this._isTextAffinity)return this;if(f.isText(this.anchor))return this.offset>=0?(this._isTextAffinity=!0,this):this.isAnchorBefore?new O(this.anchor,0,!0):new O(this.anchor,this.anchor.length,!0);if(!this.anchor.isConnected)return this;if(!this.isAnchorIn){if(this.isAnchorBefore){const a=this.anchor.previousSibling;if(a&&f.isText(a))return new O(a,a.length,!0)}const n=this.anchor.nextSibling;if(n){if(f.isText(n))return new O(n,0,!0);if(f.isBrElement(n))return new O(n.parentNode,f.prevSiblingCount(n),!0)}}let t,r=0;if(f.isHTMLElement(this.anchor)&&this.anchor.isContentEditable){const n=f.nodeLength(this.anchor);if(this.anchor.hasChildNodes()?this.offset<=0?(t=C.innermostEditableFirstChild(this.anchor),r=0):this.offset>=n?(t=C.innermostEditableLastChild(this.anchor),r=f.nodeLength(t)):(t=C.innermostEditableFirstChild(this.anchor.childNodes.item(this.offset)),r=0):(t=this.anchor,r=this.offset),t.localName==="br")if(this._offset===1/0){if(!t.nextSibling)return new O(t.parentNode,f.prevSiblingCount(t)+1,!0);if(f.isBrElement(t.nextSibling))return new O(t.parentNode,f.prevSiblingCount(t)+1,!0);t=C.innermostEditableFirstChild(t.nextSibling),r=0}else{if(!t.previousSibling)return new O(t.parentNode,f.prevSiblingCount(t),!0);t=C.innermostEditableLastChild(t.previousSibling),r=f.nodeLength(t)}return f.isText(t)?new O(t,r,!0):t.isContentEditable?new O(t,r,!0):new O(t,r===0?-1/0:1/0,!0)}return this._offset>0?(t=C.treeNextEditableText(this._anchor),t?r=0:(t=C.treePrevEditableText(this._anchor),t&&(r=t.length))):(t=C.treePrevEditableText(this._anchor),t?r=t.length:(t=C.treeNextEditableText(this._anchor),t&&(r=0))),t?new O(t,r,!0):this}insertNode(t){this.__connected||this.toReality();const r=this.offset;let n=this.anchor,a;if(f.isText(n)){if(r>0&&r<n.length)return!1;a=r<=0?n:n.nextSibling,n=n.parentNode}else a=n.childNodes.item(r);return n?(n.insertBefore(t,a),!0):!1}},cn=class extends We{constructor(e,t,r){super(),this.rawEl=e,this.start=t,this.end=r}__isInRaw=!0;isInRaw(){return!0}isCaret(){return!1}toRange(){if(!this.rawEl.isConnected)return null;const e=document.createRange();return e.setStart(this.rawEl,0),e.setEnd(this.rawEl,0),e}toCaret(e=!0){return e?new S(this.rawEl,this.start):new S(this.rawEl,this.end)}isEqualTo(e){return e.isInRaw()&&this.rawEl===e.rawEl&&this.start===e.start&&this.end===e.end}},ce=class extends We{_startCaret;_endCaret;constructor(e,t,r,n){super(),this._startCaret=new S(e,t),this._endCaret=new S(r,n)}get startAnchor(){return this._startCaret.anchor}get startOffset(){return this._startCaret.offset}get endAnchor(){return this._endCaret.anchor}get endOffset(){return this._endCaret.offset}get isCollapsed(){return this.startAnchor===this.endAnchor&&this.startOffset===this.endOffset}get isConnected(){return this.__connected?!0:this.__connected=this._startCaret.isConnected&&this._endCaret.isConnected}toCaret(e=!0){return e?this._startCaret:this._endCaret}toRange(){if(!this.isConnected)return null;const e=document.createRange();return this._startCaret.adoptToRange(e,!0,!1),this._endCaret.adoptToRange(e,!1,!0),e}isCaret(){return!1}isEqualTo(e){return!e.isCaret()&&!e.isInRaw()&&this.startAnchor===e.startAnchor&&this.startOffset===e.startOffset&&this.endAnchor===e.endAnchor&&this.endOffset===e.endOffset}},ee=class{constructor(e,t){this.startNode=e,this.endNode=t}toRange(){const e=document.createRange();return e.setStartBefore(this.startNode),e.setEndAfter(this.endNode),e}removeAt(){return new S(this.startNode.parentNode,f.nodeIndex(this.startNode))}extractToFragment(){const e=document.createDocumentFragment();if(this.startNode===this.endNode)return e.appendChild(this.startNode),e;let t=this.startNode.nextSibling;for(;t&&(e.appendChild(t),t!==this.endNode);)t=this.startNode.nextSibling;return e.prepend(this.startNode),e}},c={BEFORE_ANCHOR:-1/0,AFTER_ANCHOR:1/0,ANCHOR_IN_END:999999999,fromRange:e=>{let t;return e.collapsed?t=new S(e.startContainer,e.startOffset):t=new ce(e.startContainer,e.startOffset,e.endContainer,e.endOffset),e instanceof Range&&t.markConnected(),t},caret:(e,t)=>new S(e,t),caretIn:(e,t)=>(t<0?t=0:f.isText(e)?t>e.length&&(t=e.length):t>e.childNodes.length&&(t=e.childNodes.length),new S(e,t)),caretInEnd:e=>new S(e,f.nodeLength(e)),caretInEndFuture(e){return new S(e,this.ANCHOR_IN_END)},caretInStart:e=>new S(e,0),caretMoved:(e,t)=>{if(t===0)return e;let r=e.offset+t;return r<0&&(r=0),new S(e.anchor,r)},caretOutEnd:e=>{const t=f.nodeIndex(e);return t===-1?new S(e,1/0):new S(e.parentNode,t+1)},caretOutEndFuture:e=>new S(e,1/0),caretOutStart:e=>{const t=f.nodeIndex(e);return t===-1?new S(e,-1/0):new S(e.parentNode,t)},caretOutStartFuture:e=>new S(e,-1/0),caretEndAuto(e){return f.isText(e)?new S(e,e.length):f.isNotEditable(e)?new S(e,1/0):e.lastChild?this.caretEndAuto(e.lastChild):new S(e,0)},caretStartAuto(e){return f.isText(e)?e.data==="​"?new S(e,1):new S(e,0):f.isBrElement(e)?this.caretOutStart(e):f.isNotEditable(e)?new S(e,-1/0):e.firstChild?this.caretStartAuto(e.firstChild):new S(e,0)},caretInAuto(e){if(f.isText(e))return new S(e,e.length);const t=e.lastChild;return t?f.isText(t)?new S(t,t.length):f.isBrElement(t)?this.caretOutStart(t):this.caretEndAuto(t):this.caretInStart(e)},inRaw(e,t,r=t){return new cn(e,t,r)},range:(e,t,r,n)=>new ce(e,t,r,n),rangeAllIn:e=>new ce(e,0,e,f.nodeLength(e)),spanRange:(e,t)=>{if(!e||!t||e.parentNode!==t.parentNode)return null;let r=!0,n=t.nextSibling;for(;n;){if(n===e){r=!1;break}n=n.nextSibling}return r?new ee(e,t):new ee(t,e)},spanRangeAllIn:e=>e.hasChildNodes()?new ee(e.firstChild,e.lastChild):null,spanRangeFromTo:(e,t,r)=>{if(!e.hasChildNodes())return null;if(t>r){const i=t;t=r,r=i}const n=e.childNodes.item(t),a=r<e.childNodes.length?e.childNodes.item(r):e.lastChild;return!n||!a?null:new ee(n,a)}},G=class extends HTMLElement{static etType=0;static inEtType=0;static notInEtType=0;static elName;static observedAttributes=[];static effectBlocker;static create(){return document.createElement(this.elName)}static is(e){return e?.localName===this.elName}static getNormalized(e){return e}nativeTag;get etCode(){return this[q]}get inEtCode(){return this[Je]}get notInEtCode(){return this[Xe]}get contentText(){let e="";const t=document.createTreeWalker(this,5,r=>r.nodeType===3?(e+=r.data.replaceAll("​",""),2):r[q]?(e+=r.contentText,2):3);for(;t.nextNode(););return e}async contentTextAsync(){let e="";const t=document.createTreeWalker(this,5);let r=t.nextNode();for(;r;){if(r.nodeType===3)e+=r.data.replaceAll("​","");else if(r[q]){e+=await r.contentTextAsync(),r=t.nextSibling();continue}r=t.nextNode()}return e}constructor(){super();const{etType:e,inEtType:t,notInEtType:r}=(this.__proto__??Object.getPrototypeOf(this)).constructor;this[q]=e===void 0?0:e,this[Je]=t===void 0?0:t,this[Xe]=r===void 0?0:r,Promise.resolve().then(()=>{e&256&&this.setAttribute("contenteditable","false"),e&8&&this.classList.add("etp"),this.classList.add("et")})}checkIn(e){return T.checkIn(this.inEtCode,e,this.notInEtCode)}isEmpty(){const e=this.textContent;return e===""||e.length<=2&&(e==="​"||e===`
​`||e===`
`)}innerStartEditingBoundary(){return c.caretInStart(this)}innerEndEditingBoundary(){return c.caretInEnd(this)}isEqualTo(e){return f.isEqualElement(this,e)}mergeWith(e,t){let r=t(this.lastChild,e.firstChild);return r?this.append(...e.childNodes):r=c.caretOutEnd(this),e.remove(),r}focusinCallback(e){this.classList.add("Et--active")}focusoutCallback(e){this.classList.remove("Et--active")}static fromNativeElementTransformerMap;toNativeElement(e,t="style"){let r=this.nativeTag;if(r||(r=(this.etCode|this.inEtCode)&12?"div":"span"),t==="style"){const n=document.createElement(r);return n.style.backgroundColor=this.style.backgroundColor,n.style.color=this.style.color,n}else return f.elementAsEtEl(r,this)}onAfterCopy(e){return this}onBeforePaste(e){return this}static fromMarkdownHandlerMap;static toMarkdownTransformerMap;static toMarkdownHandlerMap},ie=class extends G{static etType=12;createForInsertParagraph(e,t,r){return e.cloneParagraph(this,r)}regressToPlainParagraph(e){const t=e.createPlainParagraph();return t.prepend(this.textContent),t}fromPlainParagraph(e,t,r){const n=document.createElement(this.localName);return n.appendChild(r(e)),n}},os=class extends ie{static elName="et-bq";static etType=super.etType|16;static inEtType=8;static notInEtType=147;get firstParagraph(){return this.firstChild}get lastParagraph(){return this.lastChild}innerStartEditingBoundary(){return this.firstParagraph.innerStartEditingBoundary()}innerEndEditingBoundary(){return this.lastParagraph.innerEndEditingBoundary()}},dn=class extends G{static elName="et-body";static etType=0;static inEtType=8;static create(){return document.createElement("et-body")}connectedCallback(){this.setAttribute("contenteditable",""),this.setAttribute("autocorrect","off"),this.autocapitalize="off",this.spellcheck=!1}focusinCallback(e){if(!e.isCaretIn(this))return;let t=e.selection.focusNode,r=!0;if(t||(t=e.bodyEl.lastChild,r=!1),t&&e.isEtParagraph(t)&&(t.isContentEditable||e.isPlainParagraph(t))){e.setCaretToAParagraph(t,r);return}const n=e.createPlainParagraph();t?e.commandManager.handleInsertNode(n,r?c.caretOutStart(t):c.caretOutEnd(t),c.caretInAuto(n)):(e.commandManager.handleInsertNode(n,c.caretInEnd(this),c.caretInAuto(n)),e.selection.scrollIntoView())}toMdast(e){return e("root",this.childNodes,{})}},ls=class extends ie{static elName="et-comp";static etType=super.etType|64|256;isEqualTo(e){return!1}onAfterCopy(e){return this}},un=class extends G{static elName="et-editor";static etType=260;static create(){return document.createElement("et-editor")}connectedCallback(){}toNativeHTML(e,t,r=""){return t==="style"?`<div>${r}</div>`:f.elementAsEtEl("div",this).outerHTML.slice(0,-6)+r+"</div>"}},hs=class extends G{static elName="et-embed";static etType=384;static notInEtType=-1;isEqualTo(e){return!1}},cs=class extends ie{static elName="et-h";static etType=super.etType|32;static inEtType=1;static notInEtType=-1;innerStartEditingBoundary(){const e=this.firstChild;return e?c.caretStartAuto(e):c.caretInStart(this)}innerEndEditingBoundary(){const e=this.lastChild;return e?c.caretEndAuto(e):c.caretInEnd(this)}},fn=class pt extends ie{nativeTag="p";static elName="et-p";static etType=super.etType;static inEtType=3;static notInEtType=8;static create(){return document.createElement("et-p")}isEqualTo(t){return this.localName===t.localName}innerStartEditingBoundary(){const t=this.firstChild;return t?c.caretStartAuto(t):c.caretInStart(this)}innerEndEditingBoundary(){const t=this.lastChild;return t?t.localName==="br"?c.caretOutStart(t):c.caretEndAuto(t):c.caretInEnd(this)}static fromNativeElementTransformerMap={p:()=>this.create()};toMdast(t){return this.textContent===""?t({type:"paragraph",children:[t({type:"text",value:"​"})]}):t("paragraph",this.childNodes,{})}static fromMarkdownHandlerMap={paragraph:()=>pt.create()}},ds=class extends G{static elName="et-r";static etType=2;static inEtType=3;static notInEtType=140},H={Insert_Composition_Text:1,Insert_Text:2,Delete_Text:4,Replace_Text:8,Insert_Node:16,Remove_Node:32,Replace_Node:64,Insert_Content:128,Remove_Content:256,Functional:512},Et=function(e){if(e.composition.updateCount===1)e.selection.anchorText?this.newInserted=!1:this.newInserted=!0,this.srcCaretRange=e.selection.getCaretRange();else{if(e.selection.anchorText||e.selection.update(),!e.selection.anchorText)return!1;this.text=e.selection.anchorText}return!0},Ce=function(){const e=this.text,t=this.offset;return e.insertData(t,this.data),this.setCaret&&(this.setCaret=!1,this.destCaretRange=c.caret(e,t+this.data.length)),!0},Te=function(){return this.text.deleteData(this.offset,this.data.length),this.setCaret&&(this.setCaret=!1,this.destCaretRange=c.caret(this.text,this.offset)),!0},ge=function(){const{data:e,delLen:t,offset:r}=this;return this.delLen=e.length,this.data=this.text.data.slice(r,r+t),this.text.replaceData(r,t,e),this.setCaret&&(this.setCaret=!1,this.destCaretRange=c.caret(this.text,r+e.length)),!0},ve=function(){const e=this.execAt.toCaret();return e.isSurroundText?!1:(e.insertNode(this.node),this.setCaret&&(this.setCaret=!1,this.destCaretRange=c.caretInStart(this.node)),!0)},ye=function(){return this.execAt||(this.execAt=c.caretOutStart(this.node)),this.setCaret&&(this.setCaret=!1,this.destCaretRange=this.execAt),this.node.remove(),!0},me=function(){const{newNode:e,oldNode:t}=this;return t.replaceWith(e),this.newNode=t,this.oldNode=e,this.setCaret&&(this.setCaret=!1,this.destCaretRange=c.caretInStart(e)),!0},be=function(){const{execAt:e,content:t}=this;return t.childNodes.length?(this.removeRange||(this.removeRange=new ee(t.firstChild,t.lastChild)),e.insertNode(t)):!1},we=function(){const e=this.removeRange;return this.content?this.content=e.extractToFragment():(this.execAt=e.removeAt(),this.content=e.extractToFragment()),!0},_t=function(e){return this.execCallback?.(e),!0},Ct=function(e){return this.undoCallback?.(e),!0},gn={1:Et,2:Ce,4:Te,8:ge,16:ve,32:ye,64:me,128:be,256:we,512:_t},mn={1:()=>{},2:Te,4:Ce,8:ge,16:ye,32:ve,64:me,128:we,256:be,512:Ct},pn=e=>Object.assign(e,{type:1,exec:Et}),En=e=>Object.assign(e,{type:2,exec:Ce,undo:Te}),_n=e=>Object.assign(e,{type:4,exec:Te,undo:Ce}),Cn=e=>Object.assign(e,{type:8,exec:ge,undo:ge}),Tn=e=>Object.assign(e,{type:16,exec:ve,undo:ye}),vn=e=>Object.assign(e,{type:32,exec:ye,undo:ve}),yn=e=>Object.assign(e,{type:64,exec:me,undo:me}),bn=e=>Object.assign(e,{type:128,exec:be,undo:we}),wn=e=>Object.assign(e,{type:256,exec:we,undo:be}),Sn=e=>Object.assign(e,{type:512,exec:_t,undo:Ct}),d=(()=>{const e=(t,r)=>Object.assign(r,{type:t,exec:gn[t],undo:mn[t]});return e.insertCompositionText=pn,e.insertText=En,e.deleteText=_n,e.replaceText=Cn,e.insertNode=Tn,e.removeNode=vn,e.replaceNode=yn,e.insertContent=bn,e.removeContent=wn,e.functional=Sn,e.INS_CT=1,e.INS_T=2,e.DEL_T=4,e.REP_T=8,e.INS_N=16,e.REM_N=32,e.REP_N=64,e.INS_C=128,e.REM_C=256,e.FUNC=512,e.null=function(){return this.functional({execCallback(){},undoCallback(){}})},e.removeText=function(t,r,n,a=!0,i=!0){return d.deleteText({text:t,data:t.data.slice(r,n),offset:r,isBackward:a,setCaret:i})},e.moveNodes=function(t,r,n){return this.functional({meta:{_moveRange:t,_moveTo:r},execCallback(){const{_moveRange:a,_moveTo:i}=this.meta;this.meta._moveTo=a.removeAt(),i.insertNode(a.extractToFragment())},undoCallback(a){this.execCallback(a)},destCaretRange:n})},e})(),de={handle(e,t,r,n){let a=null;for(const i of e)try{i.exec(r)&&(t.push(i),i.destCaretRange!==void 0&&(a=i.destCaretRange))}catch{for(let o=t.length-1;o>=0;o--)t[o].undo(r);return t.length=0,r.assists.logger?.logError(`cmdHandler.handle error, cmdType: ${i.type}`,"cmdHandler"),null}return t.length&&(t[0].srcCaretRange===void 0&&(t[0].srcCaretRange=r.selection.getCaretRange()),n?(t[t.length-1].destCaretRange=n,a=n):n===null?t[t.length-1].destCaretRange=a=null:t[t.length-1].destCaretRange=a),a},handleUndo(e,t){for(let n=e.length-1;n>=0;n--)e[n].undo(t);const r=e[0].srcCaretRange;if(r)return t.setSelection(r)},handleRedo(e,t){for(const n of e)n.exec(t);const r=e[e.length-1].destCaretRange;if(r)return t.setSelection(r)}},Ye=class{cmdList;transactionStack;size;_pos;constructor(e){this.size=e,this._pos=0,this.cmdList=[],this.transactionStack=[]}get length(){return this.transactionStack.length}get isEmptyRecord(){return this.cmdList.length===0}record(e){e.length&&this.cmdList.push(...e)}discard(e){if(!this.cmdList.length)return!1;let t=!1;for(const n of this.cmdList)if(n.type===H.Insert_Composition_Text){t=!0;break}if(t)return this.pushTransaction(e),this.undo(e),!0;const r=[...this.cmdList];return this.cmdList.length=0,de.handleUndo(r,e),!0}commitAll(e){this.transactionStack.forEach(t=>t.tranxFinalCallback?.(e)),this.transactionStack.length=0,this._pos=0}pushTransaction(e){if(this.isEmptyRecord)return!1;const t=Nn(this.cmdList,e);return!t||!t.length?!1:(this.transactionStack[this._pos]=t,this._pos+1>this.size?this.transactionStack.shift()?.tranxFinalCallback?.(e):this._pos++,this.transactionStack.length=this._pos,this.cmdList.length=0,!0)}undo(e){if(this._pos<=0)return!1;const t=this.transactionStack[--this._pos];return de.handleUndo(t.cmds,e),!0}redo(e){if(this._pos>=this.transactionStack.length)return!1;const t=this.transactionStack[this._pos++];return de.handleRedo(t.cmds,e),!0}},Nn=(e,t)=>{const{cmds:r,hasFinal:n}=An(kn(e,t));return r.length===0?null:{cmds:r,length:r.length,srcCaretRange:r[0].srcCaretRange,destCaretRange:r[r.length-1].destCaretRange,tranxFinalCallback:n?a=>{for(const i of r)i.finalCallback?.(a)}:void 0}},An=e=>{const t=[];let r=!1;for(let n=0;n<e.length;n++){const a=e[n];if(a.type===H.Insert_Text){let i=n+1,s=a.data,o=a.offset+a.data.length;for(;i<e.length;){const l=e[i];if(l.type!==H.Insert_Text||l.text!==a.text||l.offset!==o)break;s+=l.data,o=l.offset+l.data.length,a.destCaretRange=l.destCaretRange,i++}if(i!==n+1){a.data=s,t.push(a),n=i-1;continue}}else if(a.type===H.Delete_Text){let i=n+1,s=a.data,o=null,l;for(;i<e.length&&(l=e[i],!(l.type!==H.Delete_Text||l.text!==a.text||l.isBackward!==a.isBackward));)s=l.isBackward?l.data+s:s+l.data,i++,o=l;if(o){a.isBackward&&(a.offset=o.offset),a.data=s,a.destCaretRange=o.destCaretRange,t.push(a),n=i-1;continue}}else if(a.type===H.Functional&&a.merge){let i=a,s=e[n+1];for(;s&&s.type===H.Functional;){const o=i.merge(s);if(!o)break;o!==!0&&(i=d.functional(o)),n++,s=e[n+1]}t.push(i),i.finalCallback&&(r=!0);continue}a.finalCallback&&(r=!0),t.push(a)}return{cmds:t,hasFinal:r}},kn=(e,t)=>{const r=[];for(let n=0;n<e.length;n++){const a=e[n];if(a.type!==H.Insert_Composition_Text){r.push(a);continue}let i=n+1,s=a.data,o=null;for(;i<e.length;){const h=e[i];if(h.type!==H.Insert_Composition_Text||!h.text)break;o=h,s=h.data,i++}const l=a.srcCaretRange?.toCaret();if(!l)return r;if(o){if(n=i-1,s==="")continue;const h=o.text;a.newInserted?r.push(d.insertNode({node:h,execAt:l,srcCaretRange:l,destCaretRange:c.caret(h,h.length)})):r.push(d.insertText({text:h,data:s,offset:l.offset,srcCaretRange:l,destCaretRange:c.caret(h,l.offset+s.length)}))}else{let h=l.anchor;if(h.nodeType===3)r.push(d.insertText({text:h,data:s,offset:l.offset,srcCaretRange:l,destCaretRange:c.caret(h,l.offset+s.length)}));else{if(t.selection.update(),h=t.selection.anchorText,!h||h.nodeType!==3)continue;r.push(d.insertNode({node:h,execAt:l,srcCaretRange:l,destCaretRange:c.caret(h,h.length)}))}}}return r},Pn=class{constructor(e){this._ctx=e,this._undoStack=new Ye(e.editor.config.UNDO_LENGTH)}_cmds=[];_inTransaction=!1;_undoStack;_commitNext=!1;_lastCaretRange=null;_afterHandleCallbacks=[];get lastCaretRange(){return this._lastCaretRange?this._lastCaretRange.toTextAffinity():null}get inTransaction(){return this._inTransaction}get stackLength(){return this._undoStack.length}get hasQueuedCmds(){return this._cmds.length>0}clearQueue(){this._cmds.length=0}reset(){this.closeTransaction(),this.clearQueue(),this._undoStack=new Ye(this._ctx.editor.config.UNDO_LENGTH)}pushByName(e,t){const r=H[e];return r&&t&&this._cmds.push(d(r,t)),this}push(...e){return this._cmds.push(...e),this}pushHandleCallback(e,t){if(!t){this._afterHandleCallbacks.push(e);return}this._afterHandleCallbacks.push(()=>e(t))}_runHandleCallbacks(){if(this._afterHandleCallbacks.length){const e=[...this._afterHandleCallbacks];this._afterHandleCallbacks.length=0;for(const t of e)t()}}_clearHandleCallbacks(){this._afterHandleCallbacks.length=0}_handle(e){if(!this.hasQueuedCmds)return this._lastCaretRange=null,this._clearHandleCallbacks(),!1;const t=[];return this._lastCaretRange=de.handle(this._cmds,t,this._ctx,e),this._undoStack.record(t),this.clearQueue(),!0}handle(e){return this._handle(e)?(this._runHandleCallbacks(),this._checkCommitNext(),!0):!1}handleAndUpdate(e){return this._handle(e)?(this._lastCaretRange&&this._ctx.setSelection(this._lastCaretRange.toTextAffinity()),this._runHandleCallbacks(),this._checkCommitNext(),!0):!1}discard(){return this._inTransaction=!1,this._undoStack.discard(this._ctx)}commit(){return this._inTransaction||this._ctx.composition.inSession?!1:this._undoStack.pushTransaction(this._ctx)}commitNextHandle(e=!1){e&&this.commit(),this._commitNext=!0}_checkCommitNext(){this._commitNext&&(this._commitNext=!1,this.commit())}checkKeydownNeedCommit(e,t){return[" ","Enter","Tab","Backspace","Delete"].includes(e.key)&&!e.repeat&&e.key!==t.currDownKey&&this.commit(),!1}commitAll(){this.closeTransaction(),this._undoStack.commitAll(this._ctx)}startTransaction(){this._inTransaction=!0}closeTransaction(){return this.hasQueuedCmds&&this.handleAndUpdate(),this._inTransaction=!1,this.commit()}withTransaction(e,t){this.closeTransaction(),this.startTransaction();try{return this.push(...e).handleAndUpdate(t),!0}catch{return this.discard(),this._ctx.assists.logger?.logError("withTransaction error","CommandManager"),!1}finally{this.closeTransaction()}}withTransactionFn(e){this.closeTransaction(),this.startTransaction();try{return e(this)&&(!this.hasQueuedCmds||this.handleAndUpdate())?(this.closeTransaction(),!0):(this.discard(),!1)}catch{return this._ctx.assists.logger?.logError("withTransactionFn error","CommandManager"),!1}finally{this.discard(),this.closeTransaction()}}withSrcCaretRange(e,t){this.hasQueuedCmds&&this.handle();const r=d.null();r.srcCaretRange=e,this._cmds.push(r),t(),this.hasQueuedCmds&&this.handleAndUpdate()}withRememberScrollTop(e,t){const r=e.body.scrollContainer.scrollTop;e.commandManager.pushHandleCallback(()=>{e.body.scrollContainer.scrollTop=r});const n=t();return this._clearHandleCallbacks(),n}_prepareUndoRedo(){this.clearQueue(),this.commit()||this.discard()}undoTransaction(){return this._prepareUndoRedo(),this._undoStack.undo(this._ctx)}redoTransaction(){return this._prepareUndoRedo(),this._undoStack.redo(this._ctx)}handleUpdateText(e,t,r,n,a=!1){return!r&&!n?!1:(this.push(d.replaceText({text:e,offset:t,data:n,delLen:typeof r=="string"?r.length:r,setCaret:a===!0})),a?this.handleAndUpdate(a===!0?void 0:a):this.handle())}handleInsertNode(e,t,r=!1){return t.isSurroundText?!1:(this.commitNextHandle(!0),this.push(d.insertNode({node:e,execAt:t,setCaret:r===!0})),r?this.handleAndUpdate(r===!0?void 0:r):this.handle())}handleMoveNode(e,t,r=!1){return this.push(d.removeNode({node:e}),d.insertNode({node:e,execAt:t,setCaret:r===!0})),r?this.handleAndUpdate(r===!0?void 0:r):this.handle()}handleRemoveNode(e,t=!1){return e.isConnected?(this.commitNextHandle(!0),this.push(d.removeNode({node:e,setCaret:t===!0})),t?this.handleAndUpdate(t===!0?void 0:t):this.handle()):!1}handleReplaceNode(e,t,r=!1){return this.commitNextHandle(!0),this.push(d.replaceNode({oldNode:e,newNode:t,setCaret:r===!0})),r?this.handleAndUpdate(r===!0?void 0:r):this.handle()}handleInsertParagraphToBodyStart(){const e=this._ctx.createPlainParagraph();this.handleInsertNode(e,c.caretInStart(this._ctx.bodyEl),c.caretInAuto(e))}handleInsertParagraphToBodyEnd(){const e=this._ctx.createPlainParagraph();this.handleInsertNode(e,c.caretInEnd(this._ctx.bodyEl),c.caretInAuto(e))}},Rn={};J(Rn,{checkRemoveTargetRange:()=>St,checkTargetRangePosition:()=>je,cloneRangeUnselectedContents:()=>qe,expandRemoveInsert:()=>Z,insertContentsAtCaret:()=>ke,insertContentsAtCaretTemporarily:()=>Gn,insertElementAtCaret:()=>Ae,insertElementAtCaretTemporarily:()=>Mt,insertParagraphAtCaret:()=>Ne,insertParagraphAtRange:()=>kt,insertTextAtCaret:()=>X,insertTextAtRange:()=>Ge,removeByTargetRange:()=>x,removeNodesAndChildlessAncestorAndMergeSiblings:()=>U,tryToMoveNodes:()=>z,tryToRemoveNodesBetween:()=>Se});var w={};J(w,{cleanEtFragment:()=>te,cloneAndMergeNodesToEtFragmentAndCaret:()=>Bn,extractNodeContentsToEtFragment:()=>Tt,getMergedEtFragmentAndCaret:()=>Ke,getNormalizedNodeContents:()=>Mn,mergeEtFragments:()=>xn,mergeEtFragmentsWithText:()=>Fn,mergeHtmlElement:()=>wt,mergeHtmlNode:()=>re,normalizeAndCleanEtFragment:()=>vt,normalizeToEtFragment:()=>In,parseEtFragmentToEtHtml:()=>On,parseEtFragmentToNativeHTML:()=>Ln,parseEtHtmlFromPaste:()=>Dn});var et=["svg","img","audio","video","input","textarea"],Tt=e=>{const t=document.createDocumentFragment();let r=e.firstChild;for(;r;)t.appendChild(r),r=e.firstChild;return t},Mn=(e,t,r=!1)=>{r&&(e=e.cloneNode(!0));const n=Tt(e);return n.hasChildNodes()&&vt(n,t,!0),n},vt=(e,t,r=!0)=>{if(e.childNodes.length===0||e.childNodes.length===1&&e.childNodes[0].localName==="br")return e;e.normalize();const{inEtCode:n,notInEtCode:a}=t||{inEtCode:-1,notInEtCode:0},i=[],s=[];C.traverseNode(e,void 0,{filter:o=>{let l=yt(o,s,n,a,r)===2;return l||(l=bt(o,i)===2),l?2:3}});for(const o of s){const l=o.textContent;o.replaceWith((l[0]==="​"?"​":"")+l.replaceAll("​",""))}for(const o of i)o.remove()},In=(e,t,r,n=!0)=>{e.normalize();let a=!1,i=!0;if(C.traverseNode(e,s=>t.isEtParagraph(s)?(a=!0,!0):!1,{whatToShow:1}),a){const s=[];for(const o of e.childNodes){if(!t.isEtParagraph(o)){const l=t.isEtElement(o)?o.contentText:o.textContent;if(!l?.trim())s.push(o);else{const h=t.createPlainParagraph(!1);h.textContent=l,o.replaceWith(h)}continue}i&&!t.isPlainParagraph(o)&&(i=!1)}for(const o of s)o.remove()}if(r){const s=[],{inEtCode:o,notInEtCode:l}=r;C.traverseNode(e,void 0,{filter:h=>t.isPlainParagraph(h)&&!h.textContent?(t.appendBrToElement(h),2):yt(h,s,o,l,n)});for(const h of s){const u=h.textContent;h.replaceWith((u[0]==="​"?"​":"")+u.replaceAll("​",""))}}else e.querySelectorAll(t.schema.paragraph.elName).forEach(s=>{s.textContent||t.appendBrToElement(s)});return{hasParagraph:a,allPlainParagraph:i}},yt=(e,t,r,n,a)=>{if(a&&f.isText(e)){const i=e.data;return e.data=(i[0]==="​"?"​":"")+i.replaceAll("​",""),3}if(r===1)return t.push(e),2;if(r&&T.check(e)){let i=f.findEffectParent(e);if((!i||i===e)&&(i=r),!T.checkIn(i,e.etCode,n))return t.push(e),2}return 3},te=e=>{if(e.childNodes.length===0||e.childNodes.length===1&&e.childNodes[0].localName==="br")return e;e.normalize();const t=[];C.traverseNode(e,void 0,{filter:r=>bt(r,t)});for(const r of t)r.remove();return e},bt=(e,t)=>{if(!f.isElementOrText(e))return t.push(e),2;if(e.localName==="br")return!e.previousSibling&&!e.nextSibling&&t.push(C.outermostAncestorWithSelfAsOnlyChild(e,!1)),2;if(e.nodeType===1){if(T.check(e)){if(f.removeStatusClassForEl(e),T.check(e,192))return 2}else if(et.includes(e.localName))return 2;if(!e.textContent&&(!e.firstElementChild||!et.includes(e.firstElementChild.localName)))return t.push(e),2;e.id&&e.removeAttribute("id")}return 3},xn=(e,t,r=!1,n=!0)=>{if(r&&(e=e.cloneNode(!0),t=t.cloneNode(!0)),n&&(te(e),te(t)),!e.childNodes.length&&!t.childNodes.length)return document.createDocumentFragment();if(t.childNodes.length){if(!e.childNodes.length)return t}else return e;const a=e.lastChild,i=t.firstChild;return re(a,i),e.append(t),e},Fn=(e,t,r,n=!1,a=!0)=>{n&&(e=e.cloneNode(!0),t=t.cloneNode(!0));let i=e.lastChild;return i&&(i=C.innermostEditableLastChild(i)),f.isText(i)?i.data+=r:(i=document.createTextNode(r),e.appendChild(i)),Ke(e,t,!1,a)},Ke=(e,t,r=!1,n=!0,a)=>{if(r&&(e=e.cloneNode(!0),t=t.cloneNode(!0)),n&&(te(e),te(t)),!e.childNodes.length&&!t.childNodes.length)return null;if(t.childNodes.length){if(!e.childNodes.length){let l=t.firstChild;return l=C.innermostEditableFirstChild(l),f.isText(l)?[t,c.caret(l,0)]:[t,c.caretOutStart(l)]}}else{let l=e.lastChild;return l=C.innermostEditableLastChild(l),f.isText(l)?[e,c.caret(l,l.length)]:[e,c.caretOutEnd(l)]}const i=e.lastChild,s=t.firstChild,o=re(i,s,a);return o?(e.append(t),[e,o]):null},Bn=(e,t,r=!0)=>{if(e=e.cloneNode(!0),t=t.cloneNode(!0),!f.isFragment(e)){const n=document.createDocumentFragment();n.appendChild(e),e=n}if(!f.isFragment(t)){const n=document.createDocumentFragment();n.appendChild(t),t=n}return Ke(e,t,!1,r)},re=(e,t,r)=>{if(e&&t){const n=e.nodeType,a=t.nodeType;if(n===3&&a===3){const i=e.length;return e.data+=t.data,t.remove(),c.caret(e,i)}else if(n===3){if(r===!1){const i=C.innermostEditableFirstChild(t);return c.caret(i,0)}return c.caret(e,e.length)}else if(a===3){if(r){const i=C.innermostEditableLastChild(e);return c.caretInEnd(i)}return c.caretInStart(t)}return wt(e,t)}else if(e){const n=C.innermostEditableLastChild(e);return n.nodeType===3?c.caret(n,n.length):c.caretInEnd(e)}else if(t){const n=C.innermostEditableFirstChild(t);return n.nodeType===3?c.caretInStart(n):c.caretInStart(t)}else return null},wt=(e,t,r)=>{if(e.tagName!==t.tagName)return se(e,t);if(T.check(e)){if(!e.isEqualTo(t))return se(e,t);const a=e.mergeWith(t,re);return a?(t.remove(),a):se(e,t)}else if(!f.isEqualElement(e,t))return se(e,t);let n=re(e.lastChild,t.firstChild,r);return n?e.append(...t.childNodes):n=c.caretInEnd(e),t.remove(),n},se=(e,t)=>{let r=null,n,a=!0;return!e&&!t?null:(e?(r=C.innermostEditableLastChild(e),r===e&&t&&(r=C.innermostEditableFirstChild(t),r!==t&&(a=!1))):(r=C.innermostEditableFirstChild(t),a=!1),a?r.nodeType===3?n=c.caretInEnd(r):n=c.caretOutEnd(r):r.nodeType===3?n=c.caretInStart(r):n=c.caretOutStart(r),n)},On=(e,t)=>{const r=[],n=new Map;return C.traverseNode(t,null,{whatToShow:1,filter(a){if(T.check(a)){const i=a.onAfterCopy(e);if(!i)return r.push(a),2;if(i!==a)return n.set(a,i),2;f.removeStatusClassForEl(a)}return 3}}),r.forEach(a=>a.remove()),n.forEach((a,i)=>{i.replaceWith(a)}),f.fragmentToHTML(t)},Ln=(e,t)=>{const r=[],n=new Map,a=new Map;return C.traverseNode(t,null,{whatToShow:1,filter(i){if(T.check(i)){const s=i.toNativeElement(e);if(!s)return r.push(i),2;if(typeof s=="function")return n.set(i,s()),2;a.set(i,s)}return 3}}),r.forEach(i=>i.remove()),n.forEach((i,s)=>{s.replaceWith(i)}),a.forEach((i,s)=>{s.replaceWith(i);let o=s.firstChild;for(;o;)i.appendChild(o),o=o.nextSibling}),f.fragmentToHTML(t)},Dn=(e,t)=>{const r=e.createFragment(t),n=[],a=new Map;return C.traverseNode(r,null,{whatToShow:1,filter(i){if(T.check(i)){const s=i.onBeforePaste(e);if(!s)return n.push(i),2;if(s!==i)return a.set(i,s),2}return 3}}),n.forEach(i=>i.remove()),a.forEach((i,s)=>{s.replaceWith(i)}),r},R=(e,t)=>t,I=e=>e,je=(e,t,r,n,a,i)=>{if(t.collapsed||!t.isValid())return!1;if(t.isTextCommonAncestor())return t.startParagraph?r(e,t,t.startParagraph,t.commonAncestor):!1;const s=t.startParagraph,o=t.endParagraph;return!s||!o?i?i(e,t):e.selection.isRangingBody?e.commonHandler.initEditorContents(!1):e.selection.collapse(!1,!0):s===o?n(e,t,s):a(e,t,s,o)},qe=(e,t,r,n,a=!0)=>{const i=document.createRange(),s=document.createRange();i.setEnd(e.startContainer,e.startOffset),s.setStart(e.endContainer,e.endOffset),n?(i.setStartBefore(t),s.setEndAfter(r)):(i.setStart(t,0),s.setEnd(r,f.isText(r)?r.length:r.childNodes.length));const o=i.cloneContents(),l=s.cloneContents();return a&&(w.cleanEtFragment(o),w.cleanEtFragment(l)),[o,l]},z=(e,t,r,n)=>{const a=c.spanRange(t,r);return a?(n?e.push(d.moveNodes(a,n)):e.push(d.removeContent({removeRange:a})),!0):!1},Se=(e,t,r)=>{if(t.parentNode!==r.parentNode||t.nextSibling===r)return;const n=c.spanRange(t.nextSibling,r.previousSibling);n&&e.push(d.removeContent({removeRange:n}))},U=(e,t,r=t,n)=>{if(t===r)return t=n?C.outermostAncestorWithSelfAsOnlyChildButUnder(t,n,!0):C.outermostAncestorWithSelfAsOnlyChild(t,!0),Me(e,t,t);if(!t.parentNode||t.parentNode!==r.parentNode)return!1;{let a=t.parentNode;return a.firstChild!==t||a.lastChild!==r||(n?a===n:e.isEtParagraph(a))?Me(e,t,r):(a=n?C.outermostAncestorWithSelfAsOnlyChildButUnder(a,n,!0):C.outermostAncestorWithSelfAsOnlyChild(a,!0),Me(e,a,a))}},Me=(e,t,r=t)=>{let n=!1;const a=t.previousSibling,i=r.nextSibling;if(a&&i&&f.isEqualNode(a,i)&&(n=!0),!n){if(t===r)e.commandManager.push(d.removeNode({node:t,setCaret:!0}));else{const l=c.spanRange(t,r);if(!l)return!1;e.commandManager.push(d.removeContent({removeRange:l,destCaretRange:l.removeAt()}))}return!0}const s=c.spanRange(a,i);if(!s)return!1;const o=w.cloneAndMergeNodesToEtFragmentAndCaret(a,i,!0);return o?(e.commandManager.push(d.removeContent({removeRange:s}),d.insertContent({content:o[0],execAt:s.removeAt(),destCaretRange:o[1]})),!0):(e.commandManager.push(d.removeContent({removeRange:s,destCaretRange:s.removeAt()})),!0)},Z=(e,t,r,n,a,i,s,o)=>{let l=c.spanRange(r,n);if(!l)return!1;a&&!a.hasChildNodes()&&(a=null),r=l.startNode,n=l.endNode;let[h,u]=qe(t,r,n,i,!0);if(!h.hasChildNodes()&&!u.hasChildNodes()&&!a)return U(e,r,n);if(s){s=!1;const m=r.previousSibling,p=n.nextSibling,b=h.hasChildNodes()?h.firstChild:a?a.firstChild:u.firstChild,v=u.hasChildNodes()?u.lastChild:a?a.lastChild:h.lastChild,k=m&&b&&f.isEqualNode(m,b),E=p&&v&&f.isEqualNode(v,p);if(k){s=!0,r=m;const y=e.createFragment();y.appendChild(m.cloneNode(!0)),h=w.mergeEtFragments(y,h)}if(E){s=!0,n=p;const y=e.createFragment();y.appendChild(p.cloneNode(!0)),u=w.mergeEtFragments(u,y)}s&&(l=c.spanRange(r,n))}if(!l)return!1;a&&(h=w.mergeEtFragments(h,a));let g;if(o)g=w.mergeEtFragments(h,u,!1,s);else{const m=w.getMergedEtFragmentAndCaret(h,u,!1,s,e.affinityPreference);g=m?.[0],o=m?.[1]}return g?(e.commandManager.push(r===n?d.removeNode({node:r}):d.removeContent({removeRange:l}),d.insertContent({content:g,execAt:l.removeAt(),destCaretRange:o})),!0):U(e,r,n)},St=(e,t,r)=>{if(!t.collapsed)if(x(e,t)&&e.commandManager.handle()){const n=e.commandManager.lastCaretRange;if(!n||(t=e.selection.createTargetRange(n),!t))return!1}else return!1;return r(t.toTargetCaret())},x=(e,t)=>t.collapsed?!1:je(e,t,Nt,Hn,Un)?(e.commandManager.commitNextHandle(!0),!0):!1,Nt=(e,t,r,n)=>t.startOffset>0||t.endOffset<n.length?(e.commandManager.push(d.removeText(n,t.startOffset,t.endOffset)),!0):U(e,n,n,r),Hn=(e,t,r)=>{if(t.isTextCommonAncestor()||!t.isRangeCommonAncestorHasChildNodes())return!1;if(t.startNode===t.endNode){const i=t.startNode.childNodes.item(t.startOffset),s=t.endNode.childNodes.item(t.endOffset-1);return!i||!s?!1:U(e,i,s,r)}const n=t.startAncestor,a=t.endAncestor;return Z(e,t,n,a,null,!0,!0)},Un=(e,t,r,n)=>{if(t.isTextCommonAncestor()||!t.isRangeCommonAncestorHasChildNodes())return!1;const{startAncestor:a,endAncestor:i}=t;return!a||!i?!1:a===r&&i===n?Wn(e,t,r,n):Kn(e,t,r,n,a,i)},Wn=(e,t,r,n)=>{const a=t.getStartPartialNode("paragraph"),i=t.getEndPartialNode("paragraph"),[s,o]=ne(t,a,i),l=!o.hasChildNodes(),h=[];Ve(h,a,r,r);const u=!ze(h,i,n,n,l);Se(h,r,n);let g=a?c.caretOutStart(a):c.caretInEnd(r);return u?(s.hasChildNodes()&&(h.push(d.insertContent({content:s,execAt:g})),g=c.caretEndAuto(s.lastChild)),h.length&&(h[h.length-1].destCaretRange=g,e.commandManager.push(...h)),!0):r.isEqualTo(n)?(g=At(h,r,n,a,i,s,o,e.affinityPreference),g?(h.length&&(h[h.length-1].destCaretRange=g,e.commandManager.push(...h)),!0):!1):(s&&s.hasChildNodes()&&(h.push(d.insertContent({content:s,execAt:g})),g=c.caretEndAuto(s.lastChild)),o&&o.hasChildNodes()&&h.push(d.insertContent({content:o,execAt:c.caretInStart(n)})),h.length&&(h[h.length-1].destCaretRange=g,e.commandManager.push(...h)),!0)},Kn=(e,t,r,n,a,i)=>{const s=t.getStartPartialNode("paragraph"),o=t.getEndPartialNode("paragraph"),[l,h]=ne(t,s,o),u=s?c.caretOutStart(s):c.caretInEnd(r),g=!h.hasChildNodes(),m=[],p=Ve(m,s,r,a);let b=ze(m,o,n,i,g);if(Se(m,a,i),!b){let A=u;return l.hasChildNodes()&&(m.push(d.insertContent({content:l,execAt:u})),A=c.caretEndAuto(l.lastChild)),m.length&&(m[m.length-1].destCaretRange=A,e.commandManager.push(...m)),!0}const v=o?o.nextSibling:n.firstChild,k=f.isEqualElement(a,i),y=(!g||v)&&(k||i===n)&&r.isEqualTo(n);let N;return y?N=At(m,r,n,s,o,l,h,e.affinityPreference):(g||m.push(d.insertContent({content:h,execAt:c.caretInStart(n)})),l.hasChildNodes()?(m.push(d.insertContent({content:l,execAt:u})),N=c.caretEndAuto(l.lastChild)):N=u),k&&(m.push(d.removeNode({node:i})),y&&b===n&&(b=n.nextSibling),z(m,b,i.lastChild,c.caretOutEnd(p))),m.length&&(m[m.length-1].destCaretRange=N,e.commandManager.push(...m)),!0},ne=(e,t,r)=>{const n=document.createRange();let a,i;return t?(n.setStartBefore(t),n.setEnd(e.startContainer,e.startOffset),a=w.cleanEtFragment(n.cloneContents())):a=document.createDocumentFragment(),r?(n.setStart(e.endContainer,e.endOffset),n.setEndAfter(r),i=w.cleanEtFragment(n.cloneContents())):i=document.createDocumentFragment(),[a,i]},Ve=(e,t,r,n)=>{let a;if(n===r)return a=c.spanRange(t,r.lastChild),a&&e.push(d.removeContent({removeRange:a})),r;let i=t;for(t=r;t;){if(i&&(a=c.spanRange(i,t.lastChild),a&&e.push(d.removeContent({removeRange:a}))),t===n){t=i?i.previousSibling:t.lastChild;break}i=t.nextSibling,t=t.parentNode}return t},ze=(e,t,r,n,a)=>{let i,s=t?t.nextSibling:r.firstChild;if(n===r)return!s&&a?(e.push(d.removeNode({node:r})),null):(i=c.spanRange(r.firstChild,t),i&&e.push(d.removeContent({removeRange:i})),r);let o=t;if(t=r,a&&!s)for(;t&&!s;){if(t===n)return e.push(d.removeNode({node:n})),null;o=t,s=t.nextSibling,t=t.parentNode}for(;t;){if(o&&(i=c.spanRange(t.firstChild,o),i&&e.push(d.removeContent({removeRange:i}))),t===n){t=o?o.nextSibling:t.firstChild;break}o=t.previousSibling,t=t.parentNode}return t},At=(e,t,r,n,a,i,s,o)=>{const l=n?n.previousSibling:t.lastChild,h=a?a.nextSibling:r.firstChild;let u=n?c.caretOutStart(n):c.caretInEnd(t),g=null,m;const p=w.getMergedEtFragmentAndCaret(i,s,!1,!1,o??!0);if(p)g=p[0],m=p[1];else if(l&&h&&f.isEqualNode(l,h)){e.push(d.removeNode({node:l}),d.removeNode({node:h}));const b=w.cloneAndMergeNodesToEtFragmentAndCaret(l,h,!1);if(!b)return null;g=b[0],m=b[1],u=c.caretOutStart(l)}else m=l?c.caretEndAuto(l):c.caretInStart(t);return g&&(e.push(d.insertContent({content:g,execAt:u,destCaretRange:m})),u=c.caretMoved(u,g.childNodes.length)),e.push(d.removeNode({node:r})),h&&z(e,h,r.lastChild,u),m},jn=I(function(e,t){if(!t.targetRange.collapsed)return kt(e,t.targetRange);const r=t.targetRange.toTargetCaret();return r.isCaretAtParagraphStart()?this.InsertParagraphAtParagraphStart?.(e,r):r.isCaretAtParagraphEnd()?this.InsertParagraphAtParagraphEnd?.(e,r):Ne(e,r)}),kt=(e,t)=>je(e,t,(r,n,a,i)=>{if(i.parentNode!==a||n.startOffset!==0||n.endOffset!==i.length){if(Nt(r,n,a,i),r.commandManager.handle(),!r.commandManager.lastCaretRange)return!0;const o=r.selection.createTargetCaret(r.commandManager.lastCaretRange);return o?Ne(r,o):!0}r.commandManager.push(d.removeNode({node:i}));const s=r.cloneParagraph(a,!1);return z(r.commandManager,i.nextSibling,a.lastChild,c.caretInStart(s))||r.appendBrToElement(s),r.commandManager.push(d.insertNode({node:s,execAt:c.caretOutEnd(a),destCaretRange:c.caretInStart(s)})),!0},(r,n,a)=>{const i=r.cloneParagraph(a,!1),s=n.getStartPartialNode("paragraph"),o=n.getEndPartialNode("paragraph");if(!s&&!o)return r.appendBrToElement(i),r.commandManager.push(d.insertNode({node:i,execAt:c.caretOutEnd(a),destCaretRange:c.caretInStart(i)})),!0;if(!s||!o)return!0;let l=!1;const h=o.nextSibling;h&&(l=z(r.commandManager,h,a.lastChild,c.caretInStart(i))),z(r.commandManager,s,o,null);const[u,g]=ne(n,s,o);Pt(r.commandManager,u,g,c.caretOutStart(s),c.caretInStart(i));let m=c.caretInStart(i);return g.firstChild&&(l=!0,m=c.caretStartAuto(g.firstChild)),l||(r.appendBrToElement(i),m=c.caretInAuto(i)),r.commandManager.push(d.insertNode({node:i,execAt:c.caretOutEnd(a),destCaretRange:m})),!0},(r,n,a,i)=>{const{startAncestor:s,endAncestor:o}=n;if(!s||!o)return!1;const l=[],h=n.getStartPartialNode("paragraph"),u=n.getEndPartialNode("paragraph"),[g,m]=ne(n,h,u),p=m.hasChildNodes();Ve(l,h,a,s);const b=ze(l,u,i,o,!p);if(Se(l,s,o),h&&g.hasChildNodes()&&l.push(d.insertContent({content:g,execAt:c.caretOutStart(h)})),u&&p&&l.push(d.insertContent({content:m,execAt:c.caretInStart(i)})),b&&l.length)l[l.length-1].destCaretRange=c.caretInStart(i);else{const v=r.cloneParagraph(a,!0);l.push(d.insertNode({node:v,execAt:c.caretOutEnd(a),destCaretRange:c.caretInAuto(v)}))}return r.commandManager.push(...l),!0}),Ne=(e,t)=>{e.commandManager.commitNextHandle();const r=t.anchorParagraph;if(!r)return!1;const n=t.getPartialNode("paragraph");let a;if(!n||f.isBrElement(n)){const h=r.createForInsertParagraph(e,1,!0);return h&&e.commandManager.push(d.insertNode({node:h,execAt:c.caretOutEnd(r),destCaretRange:c.caretInAuto(h)})),!0}const i=r.createForInsertParagraph(e,0,!1);if(!i)return!0;let s=c.caretInStart(i),o=!1;t.container===r?a=n:t.isAtText()&&t.container.parentNode===r&&(t.startOffset===0||t.endOffset===t.container.length)?t.startOffset===0?(a=t.container,s=c.caret(t.container,0)):(a=t.container.nextSibling,a&&(s=c.caretStartAuto(a))):(a=n.nextSibling,o=!0);let l=z(e.commandManager,a,r.lastChild,c.caretInStart(i));if(o){e.commandManager.push(d.removeNode({node:n}));const[h,u]=ne(t,n,n);Pt(e.commandManager,h,u,c.caretOutStart(n),c.caretInStart(i)),u.firstChild&&(s=c.caretStartAuto(u.firstChild),l=!0)}return l||(e.appendBrToElement(i),s=c.caretInAuto(i)),e.commandManager.push(d.insertNode({node:i,execAt:c.caretOutEnd(r),destCaretRange:s})),!0},Pt=(e,t,r,n,a,i)=>{t.hasChildNodes()&&e.push(d.insertContent({content:t,execAt:n,destCaretRange:i})),r.hasChildNodes()&&e.push(d.insertContent({content:r,execAt:a,destCaretRange:i}))},X=(e,t,r)=>{if(!t)return!0;if(r.isAtText()){const n=r.offset;n>0&&r.container.data[n-1]==="​"?e.commandManager.push(d.replaceText({text:r.container,data:t,delLen:1,offset:n-1,setCaret:!0})):e.commandManager.push(d.insertText({text:r.container,data:t,offset:r.offset,setCaret:!0}))}else{const n=f.createText(t);e.commandManager.push(d.insertNode({node:n,execAt:r.etCaret,destCaretRange:c.caret(n,n.length)}))}return!0},Ge=(e,t,r)=>t?r.isTextCommonAncestor()?(e.commandManager.push(d.replaceText({text:r.commonAncestor,data:t,delLen:r.endOffset-r.startOffset,offset:r.startOffset,setCaret:!0})),!0):e.commonHandler.checkRemoveTargetRange(r,(n,a)=>(X(n,t,a),!0)):!0,Ae=(e,t,r,n)=>f.isBrElement(t)?r.anchorParagraph&&Rt(e,t,r.anchorParagraph,r,n)?(e.isPlainParagraph(r.anchorParagraph)&&r.anchorParagraph.lastChild&&!f.isBrElement(r.anchorParagraph.lastChild)&&e.commandManager.push(d.insertNode({node:f.el("br"),execAt:c.caretInEndFuture(r.anchorParagraph)})),!0):!1:e.isEtParagraph(t)?qn(e,t,r,n):T.check(t)?Vn(e,t,r,n):(e.assists.logger?.logWarn("deny inserting element","handler"),!1),Rt=(e,t,r,n,a)=>{const i=n.container;let s;if(i===r?s=n.etCaret:f.isText(i)&&i.parentNode===r&&(n.offset===0?s=c.caretOutStart(i):n.offset===i.length&&(s=c.caretOutEnd(i))),s)return e.commandManager.push(d.insertNode({node:t,execAt:s,destCaretRange:a})),!0;const o=e.body.outerNodeUnder(i,r);if(!o)return!1;const l=document.createDocumentFragment();return l.appendChild(t),Z(e,n,o,o,l,!0,!1,a)},qn=(e,t,r,n)=>e.commandManager.withTransactionFn(a=>{if(!Ne(e,r)||!a.handle()||!a.lastCaretRange)return!1;const i=e.selection.createTargetCaret(a.lastCaretRange);if(!i||!i.anchorParagraph||!i.anchorTopElement)return!1;let s;return t.localName===i.anchorParagraph.localName||T.checkIn(i.anchorTopElement,t)?s=c.caretOutStart(i.anchorParagraph):s=c.caretOutStart(i.anchorTopElement),a.push(d.insertNode({node:t,execAt:s,destCaretRange:n})),!0}),Vn=(e,t,r,n)=>{let a=r.anchorEtElement;for(;a&&!T.checkIn(a,t);)a=e.body.findInclusiveEtParent(a.parentNode);return a?Rt(e,t,a,r,n):(e.assists.logger?.logWarn("deny inserting effect element by etcode check","handler"),!1)},ke=(e,t,r)=>{if(!t.hasChildNodes())return!0;if(t.children.length===0)return X(e,t.textContent,r);if(t.childNodes.length===1&&t.childElementCount===1)return Ae(e,t.firstChild,r);const{hasParagraph:n,allPlainParagraph:a}=w.normalizeToEtFragment(t,e);return n?!r.anchorParagraph||!r.anchorTopElement?r.container===e.bodyEl?(e.commandManager.push(d.insertContent({content:t,execAt:r.etCaret})),!0):!1:a||r.anchorParagraph===r.anchorTopElement?tt(e,t,r,r.anchorParagraph,r.getPartialNode("paragraph")):tt(e,t,r,r.anchorTopElement,r.getPartialNode("topelement")):zn(e,t,r)},zn=(e,t,r)=>{let n=r.getPartialNode("paragraph");if(!n||f.isBrElement(n)){w.normalizeAndCleanEtFragment(t,r.anchorParagraph,!0);const o=t.lastChild;return o&&e.commandManager.push(d.insertContent({content:t,execAt:r.etCaret,destCaretRange:c.caretEndAuto(o)})),!0}const a=r.anchorEtElement;if(a===r.anchorParagraph)return w.normalizeAndCleanEtFragment(t,r.anchorParagraph,!0),Z(e,r,n,n,t,!0,!0);let i=!0;for(const o of t.childNodes)if(!T.checkIn(a,o)){i=!1;break}return i?(n=r.getPartialNode("etelement"),w.normalizeAndCleanEtFragment(t,r.anchorEtElement,!0),!n||f.isBrElement(n)?(e.commandManager.push(d.insertContent({content:t,execAt:r.etCaret})),!0):Z(e,r,n,n,t,!0,!0)):(e.body.findInclusiveEtParent(r.anchorEtElement)&&w.normalizeAndCleanEtFragment(t,r.anchorTopElement,!0),Z(e,r,a,a,t,!0,!0))},tt=(e,t,r,n,a)=>{const i=n,s=e.body.findInclusiveEtParent(i.parentNode);let o=!0;if(!e.isPlainParagraph(i)&&(o=!1,!s||!T.checkIn(s,e.schema.paragraph.etType))){const A=[];for(const D of t.childNodes){if(!e.isPlainParagraph(D)){A.push(D);continue}D.replaceWith(i.fromPlainParagraph(D,e,$=>w.getNormalizedNodeContents($,i)))}A.forEach(D=>D.remove())}const l=c.caretOutEnd(i),h=t.firstChild;if(!h)return!0;let u;if(i.isEqualTo(h)?(h.remove(),u=w.extractNodeContentsToEtFragment(h),!o&&i.localName!==h.localName&&w.normalizeAndCleanEtFragment(u,i,!0)):(u=document.createDocumentFragment(),i&&T.checkIn(i,h)&&(h.remove(),u.appendChild(h))),!a||f.isBrElement(a)&&a===i.lastChild){const A=u.lastChild;return A&&e.commandManager.push(d.insertContent({content:u,execAt:r.etCaret,destCaretRange:c.caretEndAuto(A)})),t.hasChildNodes()&&e.commandManager.push(d.insertContent({content:t,execAt:l})),!0}let g,[m,p]=qe(r,a,a,!0);e.commandManager.push(d.removeNode({node:a})),m=w.mergeEtFragments(m,u);const b=m.lastChild;b&&(e.commandManager.push(d.insertContent({content:m,execAt:c.caretOutStart(a)})),g=c.caretEndAuto(b));const v=e.cloneParagraph(i,!1),k=a.nextSibling;let E=!0;if(k){const A=c.spanRange(k,i.lastChild);A&&(E=!1,e.commandManager.push(d.moveNodes(A,c.caretInStart(v))))}g=void 0;const y=t.lastChild;let N;if(y){i.isEqualTo(y)?(y.remove(),N=w.extractNodeContentsToEtFragment(y),!o&&i.localName!==y.localName&&w.normalizeAndCleanEtFragment(N,v,!0)):(N=document.createDocumentFragment(),i&&T.checkIn(i,y)&&(y.remove(),N.appendChild(y)));const A=w.getMergedEtFragmentAndCaret(N,p,!1,!1,e.affinityPreference);A&&(p=A[0],g=A[1])}return p.hasChildNodes()&&(g||(g=c.caretStartAuto(p.firstChild)),E=!1,e.commandManager.push(d.insertContent({content:p,execAt:c.caretInStart(v),destCaretRange:g}))),E?(e.appendBrToElement(v),g=c.caretInAuto(v)):g=void 0,e.commandManager.push(d.insertNode({node:v,execAt:l,destCaretRange:g})),t.hasChildNodes()&&e.commandManager.push(d.insertContent({content:t,execAt:l})),!0},Mt=(e,t,r,n)=>{e.commandManager.closeTransaction(),e.commandManager.startTransaction();const a=document.createDocumentFragment();return a.appendChild(t),It(e,a,r,n)},Gn=(e,t,r,n)=>(e.commandManager.closeTransaction(),e.commandManager.startTransaction(),It(e,t,r,n)),It=(e,t,r,n)=>{if(!t.hasChildNodes())return!1;let a;const{container:i,offset:s}=r;if(n||(n=c.caretEndAuto(t.lastChild)),!f.isText(i))a=c.caret(i,s);else if(s===0)a=c.caretOutStart(i);else if(s===i.length)a=c.caretOutEnd(i);else{const o=i.data.slice(0,s),l=i.data.slice(s);t.prepend(o),t.append(l),a=c.caretOutStart(i),e.commandManager.push(d.removeNode({node:i}))}return e.commandManager.push(d.insertContent({content:t,execAt:a,destCaretRange:n})),!0},$n=class{_ctx;commander;constructor(e){this._ctx=e,this.commander=e.commandManager}handleWith(e,t){return e?t?this.commander.handleAndUpdate(t):this.commander.handle():!1}initEditorContents(e,t){const r=this._ctx;let n,a;const i=r.bodyEl,s=t?t(r):r.editor.callbacks.firstInsertedParagraph?.(r)??r.createPlainParagraph();return Array.isArray(s)?(n=s[0],a=s[1]):n=s,a||(a=c.caretInAuto(n)),e?(r.commandManager.commitAll(),i.textContent="",i.appendChild(n),r.setSelection(a),!0):(i.hasChildNodes()&&r.commandManager.push(d.removeContent({removeRange:c.spanRangeAllIn(i)})),r.commandManager.push(d.insertNode({node:n,execAt:c.caretInStart(i)})).handleAndUpdate(a),!0)}clearEditorContents(e){const r=this._ctx.bodyEl;if(r.childNodes.length===0)return!0;const n=c.spanRangeAllIn(r);return n?(this.commander.push(d.removeContent({removeRange:n})),e?this.commander.handleAndUpdate(c.caretIn(r,0)):this.commander.handle()):!0}#e(e){const t=this._ctx,r=t.bodyEl;return t.commandManager.stackLength===0?(r.textContent="",r.appendChild(e),!0):(r.hasChildNodes()?t.commandManager.withTransaction([d.removeContent({removeRange:c.spanRangeAllIn(r)}),d.insertContent({content:e,execAt:c.caretInStart(r)})]):t.commandManager.withTransaction([d.insertContent({content:e,execAt:c.caretInStart(r)})]),!0)}updateEditorContentsFromMarkdown(e,t){return this.#e(this._ctx.fromMarkdown(e,t))}updateEditorContentsFromHTML(e){const t=this._ctx.editor.htmlProcessor.fromHtml(this._ctx,e);return w.normalizeToEtFragment(t,this._ctx),this.#e(t)}insertText(e,t,r){return t?this._ctx.selection.tellEtCaret(t)&&(t=this._ctx.selection.createTargetCaret(t)):t=this._ctx.selection.getTargetCaret(),this._ctx.selection.checkSelectionTarget(t,{caretFn:n=>(X(this._ctx,e,n),this.commander.handleAndUpdate(r)),rangeFn:n=>(Ge(this._ctx,e,n),this.commander.handleAndUpdate(r))})}insertElement(e,t,r){return this._ctx.selection.checkInsertAt(t,n=>n.isCaret()?this.handleWith(Ae(this._ctx,e,n,r),r):!1)}insertElementTemporarily(e,t,r){return this._ctx.selection.checkInsertAt(t,n=>n.isCaret()?this.handleWith(Mt(this._ctx,e,n,r),r):!1)}replaceParagraphWithPlain(e,t){if(!e.parentNode||t&&T.check(e.parentNode)&&!T.checkIn(e.parentNode,this._ctx.schema.paragraph.etType))return;const r=this._ctx.createPlainParagraph();return this.commander.commitNextHandle(!0),this.commander.handleReplaceNode(e,r,c.caretInAuto(r))}removeNodeAndMerge(e,t){return U(this._ctx,e,e,null)?t?this.commander.handleAndUpdate(t===!0?void 0:t):this.commander.handle():!1}removeRangingContents(e){if(this._ctx.selection.rawEl)return this._ctx.commonEtElement&&this._ctx.getEtHandler(this._ctx.commonEtElement).DeleteInRawEl(this._ctx,{rawEl:this._ctx.selection.rawEl,isBackward:!0,focus:!0});const t=this._ctx.selection.getTargetRange();return!this._ctx.isUpdated()||!t?!1:t.collapsed?!0:x(this._ctx,t)?(this.commander.handleAndUpdate(e),e||this._ctx.forceUpdate(),!0):!1}checkRemoveTargetRange(e,t){return e.isValid()?this.commander.withTransactionFn(()=>St(this._ctx,e,r=>t(this._ctx,r))):!1}caretToTextStartWithZWS(e){return e.data[0]==="​"?(this._ctx.selection.collapseTo(e,1),!0):this.commander.handleUpdateText(e,0,0,"​",!0)}appendParagraph(e,{newP:t=void 0,topLevel:r=!1,destCaretRange:n=!0,dispatch:a=!0}={}){const i=this._ctx;return i.selection.checkInsertAt(e,s=>{if(!s.anchorParagraph||!s.anchorTopElement)return s=s.toTargetCaret(!1),s.anchorEtElement===i.bodyEl?(t=t||i.createPlainParagraph(),n===!0&&(n=c.caretInAuto(t)),this.commander.handleInsertNode(t,s.etCaret,n)):!1;let o;if(!t)t=r?i.createPlainParagraph():i.cloneParagraph(s.anchorParagraph),o=c.caretOutEnd(r?s.anchorTopElement:s.anchorParagraph);else if(r)o=c.caretOutEnd(s.anchorTopElement);else{const h=i.body.outerParagraphs(s.anchorParagraph);for(const u of h)if(T.checkIn(u,t)){o=c.caretOutEnd(u);break}o||(o=c.caretOutEnd(s.anchorTopElement))}let l;return n===!0?l=f.isText(t.firstChild)?c.caretInEnd(t.firstChild):c.caretInStart(t):n===!1?l=void 0:l=n,i.commandManager.push(d.insertNode({node:t,execAt:o})).handleAndUpdate(l)?(a&&i.body.dispatchInputEvent("input",{inputType:"insertParagraph"}),!0):!1})}insertContentsAtCaret(e,t,r){const n=this._ctx;return n.selection.checkInsertAt(t,a=>!a||!a.isCaret()?!1:(ke(n,e,a),r?n.commandManager.handleAndUpdate(r):n.commandManager.handle()))}emptyElAndInsert(e,t,r){if(!this._ctx.body.isNodeInBody(e))return!1;const n=[];if(e.hasChildNodes()){const a=c.spanRangeAllIn(e);if(!a)return this._ctx.assists.logger?.logError("create SpanRange failed while an el has child nodes","CommonHandler.emptyAndInsert"),!1;n.push(d.removeContent({removeRange:a}))}if(!f.isFragment(t))n.push(d.insertNode({node:t,execAt:c.caretInStart(e)}));else{if(!t.hasChildNodes())return!1;n.push(d.insertContent({content:t,execAt:c.caretInStart(e)}))}if(r===void 0){const a=t.lastChild;a?r=c.caretEndAuto(a):r=null}return this.commander.push(...n),r?this.commander.handleAndUpdate(r):this.commander.handle()}},Qn={getEtProto(e){return e.__proto__??Object.getPrototypeOf(e)},getEtElCtor(e){return this.getEtProto(e).constructor},invoke(...[e,t,r,n]){const a=this.getEtElCtor(e);if(a.effectBlocker&&a.effectBlocker(t,r,e))return!1;const i=a[t];return typeof i=="function"?i.call(a,r,n):!1}},B={None:0,Ctrl:8,Shift:4,AltOpt:2,MetaCmd:1,Ctrl_Shift:12,Ctrl_Alt:10,Ctrl_Meta:9,Shift_Alt:6,Shift_Meta:5,Alt_Meta:3,Ctrl_Shift_Alt:14,Ctrl_Shift_Meta:13,Ctrl_Alt_Meta:11,Shift_Alt_Meta:7,Ctrl_Shift_Alt_Meta:15},oe=L.isMac?{ctrl:"⌃",shift:"⇧",altopt:"⌥",metacmd:"⌘"}:{ctrl:"Ctrl",shift:"Shift",altopt:"Alt",metacmd:L.isWin?"Win":"Meta"},P=L.isMac?1:8,V=L.isMac?2:8,ae=L.isMac?1:2,Zn={KeyA:"A",KeyB:"B",KeyC:"C",KeyD:"D",KeyE:"E",KeyF:"F",KeyG:"G",KeyH:"H",KeyI:"I",KeyJ:"J",KeyK:"K",KeyL:"L",KeyM:"M",KeyN:"N",KeyO:"O",KeyP:"P",KeyQ:"Q",KeyR:"R",KeyS:"S",KeyT:"T",KeyU:"U",KeyV:"V",KeyW:"W",KeyX:"X",KeyY:"Y",KeyZ:"Z",Space:"␣",Backquote:"`",Minus:"-",Equal:"=",BracketLeft:"[",BracketRight:"]",Backslash:"\\",Semicolon:":",Quote:"'",Comma:",",Period:".",Slash:"/",ArrowUp:"↑",ArrowDown:"↓",ArrowLeft:"←",ArrowRight:"→"},_=(e,t)=>t.toString(2).padStart(4,"0")+e,xt=(e,t=0)=>_(e,P|t),Ft=e=>(e.ctrlKey?"1":"0")+(e.shiftKey?"1":"0")+(e.altKey?"1":"0")+(e.metaKey?"1":"0")+e.code,Bt=e=>{const t=e.slice(4),r=[];return e[0]==="1"&&r.push(oe.ctrl),e[1]==="1"&&r.push(oe.shift),e[2]==="1"&&r.push(oe.altopt),e[3]==="1"&&r.push(oe.metacmd),r.push(Zn[t]??t),r},Ot=(e,t,{hotkey:r="",descr:n="",canCustom:a=!1,run:i=void 0})=>({title:t,descr:n,group:e,hotkey:r,canCustom:a,run:i||(()=>!1)}),Lt=e=>{const t=e.bodyEl.lastChild;return!t||!t.isContentEditable||!e.isEtParagraph(t)?(e.commandManager.handleInsertParagraphToBodyEnd(),e.selection.scrollIntoView(),!0):(e.setCaretToAParagraph(t,!1,!0),e.forceUpdate(),e.selection.scrollIntoView(!1),!0)},Dt=e=>{const t=e.bodyEl.firstChild;return!t||!t.isContentEditable||!e.isEtParagraph(t)?(e.commandManager.handleInsertParagraphToBodyStart(),e.selection.scrollIntoView(),!0):(e.setCaretToAParagraph(t,!0,!0),e.forceUpdate(),e.selection.scrollIntoView(!0),!0)},Jn=e=>{const t=e.bodyEl.lastChild;if(!t||!e.isEtParagraph(t))return e.editor.blur(),!0;const r=t.innerEndEditingBoundary().toRange();return!r||!e.selection.range?(e.editor.blur(),!0):(r.setStart(e.selection.range.endContainer,e.selection.range.endOffset),e.selection.selectRange(r),e.forceUpdate(),e.selection.scrollIntoView(!1),!0)},Xn=e=>{const t=e.bodyEl.firstChild;if(!t||!e.isEtParagraph(t))return e.editor.blur(),!0;const r=t.innerStartEditingBoundary().toRange();return!r||!e.selection.range?(e.editor.blur(),!0):(r.setEnd(e.selection.range.startContainer,e.selection.range.startOffset),e.selection.selectRange(r),e.forceUpdate(),e.selection.scrollIntoView(!0),!0)},j=(e,t,r)=>e.selection.isRangingBody?t?Dt(e):Lt(e):e.selection.collapse(t,r),rt=e=>{let t;if((t=e.selection.rawEl)&&t.selectionEnd===0){let r=C.treePrevSibling(t);for(;r&&e.body.isNodeInBody(r);){if(f.isText(r)&&r.parentElement?.isContentEditable)return e.selection.collapseTo(r,r.length),!0;if(e.isEtParagraph(r))return e.setCaretToAParagraph(r,!1,!0),!0;r=C.treePrevSibling(r)}return!0}return!1},nt=e=>{let t;if((t=e.selection.rawEl)&&t.selectionEnd===t.value.length){let r=C.treeNextSibling(t);for(;r&&e.body.isNodeInBody(r);){if(f.isText(r)&&r.parentElement?.isContentEditable)return e.selection.collapseTo(r,0),!0;if(e.isEtParagraph(r))return e.setCaretToAParagraph(r,!0,!0),!0;r=C.treeNextSibling(r)}return!0}return!1},Yn=e=>{if(e.selection.rawEl)return!1;let t;if((t=e.selection.anchorText)&&e.selection.anchorOffset===0){const r=C.treePrevSibling(t);if(!r)return!0;if(f.isRawEditElement(r))return r.selectionStart=r.value.length,r.focus(),!0;if(e.selection.anchorOffset===0&&e.isEtParagraph(r))return e.setCaretToAParagraph(r,!1,!0),!0}else if(!t){const r=e.selection.focusNode?.previousSibling;if(r&&f.isRawEditElement(r))return r.selectionStart=r.value.length,r.focus(),!0}return!1},ea=e=>{if(e.selection.rawEl)return!1;let t;if((t=e.selection.anchorText)&&e.selection.anchorOffset===t.length){const r=C.treeNextSibling(t);if(!r)return!0;if(f.isRawEditElement(r))return r.selectionEnd=0,r.focus(),!0;if(e.isEtParagraph(r))return e.setCaretToAParagraph(r,!0,!0),!0}else if(!t){const r=e.selection.focusNode;if(r&&f.isRawEditElement(r))return r.selectionEnd=0,r.focus(),!0}return!1},ta={[_("Home",0)]:e=>e.selection.modify("move","backward","lineboundary"),[_("End",0)]:e=>e.selection.modify("move","forward","lineboundary"),[_("ArrowLeft",ae)]:e=>e.selection.modify("move","backward","lineboundary"),[_("ArrowRight",ae)]:e=>e.selection.modify("move","forward","lineboundary"),[_("ArrowUp",0)]:e=>e.selection.isCollapsed?rt(e)||e.selection.modify("move","backward","line"):j(e,!0,!0),[_("ArrowDown",0)]:e=>e.selection.isCollapsed?nt(e)||e.selection.modify("move","forward","line"):j(e,!1,!0),[_("ArrowLeft",0)]:e=>e.selection.isCollapsed?rt(e)||Yn(e)||e.selection.modify("move","backward","character"):j(e,!0,!0),[_("ArrowRight",0)]:e=>e.selection.isCollapsed?nt(e)||ea(e)||e.selection.modify("move","forward","character"):j(e,!1,!0),[_("ArrowUp",P)]:e=>Dt(e),[_("ArrowDown",P)]:e=>Lt(e),[_("ArrowLeft",V)]:e=>e.selection.isCollapsed?e.selection.modify("move","backward","word"):j(e,!0,!0),[_("ArrowRight",V)]:e=>e.selection.isCollapsed?e.selection.modify("move","forward","word"):j(e,!1,!0),[_("ArrowUp",4)]:e=>e.selection.modify("extend","backward","line"),[_("ArrowDown",4)]:e=>e.selection.modify("extend","forward","line"),[_("ArrowUp",P|4)]:e=>Xn(e),[_("ArrowDown",P|4)]:e=>Jn(e),[_("ArrowLeft",4)]:e=>e.selection.modify("extend","backward","character"),[_("ArrowRight",4)]:e=>e.selection.modify("extend","forward","character"),[_("ArrowLeft",V|4)]:e=>e.selection.modify("extend","backward","word"),[_("ArrowRight",V|4)]:e=>e.selection.modify("extend","forward","word"),[_("ArrowLeft",P|4)]:e=>j(e,!0,!1)&&e.selection.modify("extend","backward","lineboundary"),[_("ArrowRight",P|4)]:e=>j(e,!1,!1)&&e.selection.modify("extend","forward","lineboundary")},ra={},na={...ta,[_("KeyA",P)]:e=>(e.selection.selectAllGradually(),!0),[_("KeyZ",P)]:"historyUndo",[_("KeyZ",P|B.Shift)]:"historyRedo",...L.isMac?{}:{[_("KeyY",P)]:"historyRedo"}},le=(e,t)=>{const r=e.selection.isSelectionInSameParagraph();return r?e.effectInvoker.invoke(r,t,e,e.selection.getTargetRange()):!1},aa={[_("ArrowUp",B.AltOpt)]:e=>le(e,"ParagraphMoveUp"),[_("ArrowDown",B.AltOpt)]:e=>le(e,"ParagraphMoveDown"),[_("ArrowUp",B.AltOpt|B.Shift)]:e=>le(e,"ParagraphCopyUp"),[_("ArrowDown",B.AltOpt|B.Shift)]:e=>le(e,"ParagraphCopyDown"),[_("Backspace",B.None)]:"deleteContentBackward",[_("Backspace",B.Shift)]:"deleteContentBackward",[_("Backspace",V)]:"deleteWordBackward",[_("Delete",B.None)]:"deleteContentForward",[_("Delete",B.Shift)]:"deleteContentForward",[_("Delete",V)]:"deleteWordForward",[_("Backspace",ae)]:"deleteSoftLineBackward",[_("Delete",ae)]:"deleteSoftLineForward",[_("Enter",B.None)]:"insertParagraph",[_("Enter",B.Shift)]:"insertLineBreak",[_("Enter",P)]:e=>{const t=e.selection.getTargetCaret();return t?e.commonHandler.appendParagraph(t,{topLevel:!1}):!1},[_("Enter",P|B.Shift)]:e=>{const t=e.selection.getTargetCaret();return t?e.commonHandler.appendParagraph(t,{topLevel:!0}):!1}},ia={[_("KeyX",P)]:!0,[_("KeyC",P)]:!0,[_("KeyV",P)]:!0},Ht=class{constructor(e){this._ctx=e,this._configManager=e.editor.configManager,this._hotkeyActionMap={},this._actionMap={},this._hotkeyActionKeyMap=new Proxy({},{set:(n,a,i)=>{if(typeof i!="string"||typeof a!="string")return!0;const s=this._actionMap[i];return s?(s.hotkey=a,this._hotkeyActionMap[a]=s,Reflect.set(n,a,i)):!0}}),this.addActions(ra);const t=this._configManager.getConfig("hotkeyData");let r=!1;if(t&&t.hotkeyMapping)if(typeof t.hotkeyMapping!="object")r=!0;else for(const[n,a]of Object.entries(t.hotkeyMapping))a in this._actionMap?this._hotkeyActionKeyMap[n]=a:r=!0;else r=!0;r&&this.#e(),this._builtinModKeyEffect=na,this._defaultModKeyEffect=aa}_builtinModKeyEffect;_defaultModKeyEffect;_hotkeyActionKeyMap;_hotkeyActionMap;_actionMap;create=_;withMod=xt;parseHotkey=Bt;createAction=Ot;_modkey="";get modkey(){return this._modkey}setModkey(e){this._modkey=Ft(e)}checkWithMod(e,t=this._modkey){const r=(t[0]==="1"?8:0)+(t[1]==="1"?4:0)+(t[2]==="1"?2:0)+(t[3]==="1"?1:0);return e!==void 0?(r&e)===e:(r&P)===P}_configManager;#e(){this._configManager.updateConfig("hotkeyData",{hotkeyMapping:{...this._hotkeyActionKeyMap}})}listenEffect(e){const t=e[this._modkey];return t?typeof t=="function"?t(this._ctx):(this._ctx.body.dispatchInputEvent("beforeinput",{inputType:t}),!0):!1}listenBuiltin(){return this.listenEffect(this._builtinModKeyEffect)}listenDefault(){return this.listenEffect(this._defaultModKeyEffect)}listenBinding(){const e=this._hotkeyActionMap[this._modkey];return e&&e.run?e.run(this._ctx):!1}addActions(e){for(const[t,r]of Object.entries(e))r&&(this._actionMap[t]=r,r.hotkey&&(this._hotkeyActionKeyMap[r.hotkey]=t))}setHotkey(e,t,r,n=!1){const a=this._actionMap[e];return a?(r&&(a.run=r),a.hotkey===t?!0:!n&&t in this._hotkeyActionMap?!1:(this._hotkeyActionKeyMap[t]=e,this.#e(),!0)):!1}bindActionRun(e){for(const[t,r]of Object.entries(e)){const n=this._actionMap[t];n&&(n.run=r)}}allActions(){return Object.groupBy(Object.entries(this._actionMap).map(([e,t])=>({actionName:e,...t})),e=>e.group)}},at=(e,t,r="")=>{if(!e.selection.isCollapsed)return null;const n=e.selection.anchorText;if(!n)return null;const a=e.selection.anchorOffset-t.length;return n.data.slice(a,a+t.length)===t&&e.commandManager.handleUpdateText(n,a,t,r,!0)?n:null},ue=class{hotstring;title;descr;repl;__action;__chars;__pos;get pos(){return this.__pos}get chars(){return this.__chars.join("")}setAction(e){this.__action=e}constructor(e,t,{action:r=void 0,repl:n="",title:a="",descr:i=""}={}){this.hotstring=e+t.slice(0,-1),this.title=a,this.descr=i,this.repl=n,this.__action=r,this.__chars=(e+t).split(""),this.__pos=0}action(e){if(this.__action)return this.__action(e,this,(t=this.repl)=>at(e,this.hotstring,t));this.repl&&at(e,this.hotstring,this.repl)}judge(e,t=!1){return t&&(this.__pos=0),e===this.__chars[this.__pos]?this.__pos++:this.__pos=e===this.__chars[0]?1:0,this.__pos===this.__chars.length?(this.__pos=0,!0):!1}backflow(e=1){this.__pos&&(this.__pos=Math.max(0,this.__pos-e))}},sa={triggerChars:" "},oa=class{constructor(e,t){this._ctx=e;const r=t?.triggerChars??sa.triggerChars;this.triggerChars=r,this.trigger=r.slice(-1),this._configManager=e.editor.configManager;const n=this._configManager.getConfig("hotstringData")??{};n?n.hotstringMapping&&this.addReplHotstrings(n.hotstringMapping):this._configManager.updateConfig("hotstringData",{hotstringMapping:{}})}hotstringMapping={};hotstringMap=new Map;hsArray=[];_resetNeeded=!1;triggerChars;trigger;_configManager;#e(){this._configManager.updateConfig("hotstringData",{hotstringMapping:{...this.hotstringMapping}})}#t(){this.hsArray.length=0,this.hsArray.push(...this.hotstringMap.values())}#r(e,t=!0){this.hotstringMap.has(e.hotstring)&&this._ctx.assists.logger?.logWarn(`hotstring "${e.hotstring}" is already exist`,"Hotstring"),this.hotstringMap.set(e.hotstring,e),t&&this.#t()}get count(){return this.hotstringMap.size}create(e,t){this.#r(new ue(e,this.triggerChars,t))}needResetBeforeJudge(){return this._resetNeeded=!0}listen(e){for(const t of this.hsArray)if(t.judge(e,this._resetNeeded))return Promise.resolve().then(()=>{this._ctx.commandManager.startTransaction(),t.action(this._ctx),this._ctx.commandManager.closeTransaction()}),this._resetNeeded=!0;return this._resetNeeded&&(this._resetNeeded=!1)}backflow(e){if(e>0)for(const t of this.hsArray)t.backflow(e)}addHotStrings(e){for(const t of e)this.#r(t,!1);this.#t()}addHotStringsByOptions(e){Object.entries(e).forEach(([t,r])=>{this.#r(new ue(t,this.triggerChars,r),!1)}),this.#t()}addReplHotstrings(e){Object.entries(e).forEach(([t,r])=>{!t||!r||(this.#r(new ue(t,this.triggerChars,{repl:r}),!1),this.hotstringMapping[t]=r)}),this.#t(),this.#e()}allHotstrings(){return[...this.hotstringMap.values()]}},la=class{_locale;_graphemeSegmenter;_wordSegmenter;constructor(e="en-US"){this._locale=e;try{this._locale=e,this._graphemeSegmenter=new Intl.Segmenter(this._locale,{granularity:"grapheme"}),this._wordSegmenter=new Intl.Segmenter(this._locale,{granularity:"word"})}catch{this._locale="en-US",this._graphemeSegmenter=new Intl.Segmenter(this._locale,{granularity:"grapheme"}),this._wordSegmenter=new Intl.Segmenter(this._locale,{granularity:"word"})}}setLocale(e){try{return this._graphemeSegmenter=new Intl.Segmenter(e,{granularity:"grapheme"}),this._wordSegmenter=new Intl.Segmenter(e,{granularity:"word"}),this._locale=e,!0}catch{return!1}}segmentGraphemeItor(e){return this._graphemeSegmenter.segment(e)[Symbol.iterator]()}segmentWordItor(e){return this._wordSegmenter.segment(e)[Symbol.iterator]()}precedingChar(e,t){return t===0?void 0:this._graphemeSegmenter.segment(e.slice(0,t)).containing(t-1)?.segment}followingChar(e,t){return length===t?void 0:this._graphemeSegmenter.segment(e.slice(t)).containing(0)?.segment}precedingWord(e,t){if(t===0)return;const r=this._wordSegmenter.segment(e.slice(0,t));let n=r.containing(t-1);if(!n)return;let a=n.segment;for(n=r.containing(n.index-1);n;){if(/\s+/.test(n.segment)||n.segment===a){a=n.segment+a,n=r.containing(n.index-1);continue}/^\s+$/.test(a)&&(a=n.segment+a);break}return a}followingWord(e,t){if(length===t)return;const r=this._wordSegmenter.segment(e.slice(t));let n=r.containing(0);if(!n)return;let a=n.segment;for(n=r.containing(n.index+n.segment.length);n;){if(/\s+/.test(n.segment)||n.segment===a){a+=n.segment,n=r.containing(n.index+n.segment.length);continue}/^\s+$/.test(a)&&(a+=n.segment);break}return a}},ha=class{constructor(e,t){this.container=e,this.offset=t}_etCaret;_anchorEtElement;_anchorParagraph;_anchorTopElement;_isCaretAtParagraphStart;_isCaretAtParagraphEnd;_isCaretAtBodyStart;_isCaretAtBodyEnd;_isValid;get startContainer(){return this.container}get startOffset(){return this.offset}get endContainer(){return this.container}get endOffset(){return this.offset}get collapsed(){return!0}isCaret(){return!0}isValid(){return this._isValid!==void 0?this._isValid:(this._isValid=this.body.isNodeInBody(this.container)&&!!this.anchorEtElement,this._isValid)}isAtText(){return this.container.nodeType===3}isAtEnd(){return this.offset===(this.container.nodeType===3?this.container.length:this.container.childNodes.length)}toTargetCaret(){return this}get etCaret(){return this._etCaret||(this._etCaret=new S(this.container,this.offset)),this._etCaret}get prevNode(){return this.container.nodeType!==1?null:this.container.childNodes.item(this.offset-1)}get nextNode(){return this.container.nodeType!==1?null:this.container.childNodes.item(this.offset)}getPartialNode(e,t=0){let r;return e==="etelement"?r=this.anchorEtElement:e==="paragraph"?r=this.anchorParagraph:r=this.anchorTopElement,r?this.container===r?this.container.childNodes.item(this.offset+t):this.body.outerNodeUnder(this.container,r):null}get commonEtElement(){return this.anchorEtElement}get anchorEtElement(){return this._anchorEtElement!==void 0?this._anchorEtElement:(this._anchorEtElement=this.body.findInclusiveEtParent(this.container),this._anchorEtElement)}get anchorParagraph(){return this._anchorParagraph!==void 0?this._anchorParagraph:(this._anchorParagraph=this.body.findInclusiveParagraph(this.anchorEtElement??this.container),this._anchorParagraph)}get anchorTopElement(){return this._anchorTopElement!==void 0?this._anchorTopElement:(this._anchorTopElement=this.body.findTopElement(this.anchorParagraph??this.container),this._anchorTopElement)}isCaretAtParagraphStart(){return this._isCaretAtParagraphStart!==void 0?this._isCaretAtParagraphStart:(this._isCaretAtParagraphStart=(this.isAtText()?this.offset===0:!0)&&!!this.anchorParagraph&&this.anchorParagraph.innerStartEditingBoundary().isAffinityTo(this.etCaret),this._isCaretAtParagraphStart)}isCaretAtParagraphEnd(){return this._isCaretAtParagraphEnd!==void 0?this._isCaretAtParagraphEnd:(this._isCaretAtParagraphEnd=(this.isAtText()?this.offset===this.container.length:!0)&&!!this.anchorParagraph&&this.anchorParagraph.innerEndEditingBoundary().isAffinityTo(this.etCaret),this._isCaretAtParagraphEnd)}isCaretAtBodyStart(){return this._isCaretAtBodyStart!==void 0?this._isCaretAtBodyStart:this.container===this.body.el&&this.offset===0?this._isCaretAtBodyStart=!0:(this._isCaretAtBodyStart=this.isCaretAtParagraphStart()&&!!this.anchorTopElement&&this.anchorTopElement===this.body.firstParagraph&&(this.anchorTopElement===this.anchorParagraph||this.anchorTopElement.innerStartEditingBoundary().isAffinityTo(this.etCaret)),this._isCaretAtBodyStart)}isCaretAtBodyEnd(){return this._isCaretAtBodyEnd!==void 0?this._isCaretAtBodyEnd:this.container===this.body.el&&this.offset===this.body.el.childNodes.length?this._isCaretAtBodyEnd=!0:(this._isCaretAtBodyEnd=this.isCaretAtParagraphEnd()&&!!this.anchorTopElement&&this.anchorTopElement===this.body.lastParagraph&&(this.anchorTopElement===this.anchorParagraph||this.anchorTopElement.innerEndEditingBoundary().isAffinityTo(this.etCaret)),this._isCaretAtBodyEnd)}},ca=class{constructor(e,t,r,n,a,i){this.startNode=e,this.startOffset=t,this.endNode=r,this.endOffset=n,this.collapsed=a,this.commonAncestor=i}_range;_etRange;_startCaret;_endCaret;_startAncestor;_endAncestor;_commonEtElement;_startEtElement;_endEtElement;_startParagraph;_endParagraph;_startTopElement;_endTopElement;_isValid;get startContainer(){return this.startNode}get endContainer(){return this.endNode}static createCaret(e,t){return t=Math.max(0,Math.min(t,e.nodeType===3?e.length:e.childNodes.length)),new this.prototype._TargetCaret(e,t)}static createRange(e,t,r,n){const a=document.createRange(),i=e===r&&t===n;if(t=Math.max(0,Math.min(t,e.nodeType===3?e.length:e.childNodes.length)),i)return a.setStart(e,t),this.fromRange(a);if(n=Math.max(0,Math.min(n,r.nodeType===3?r.length:r.childNodes.length)),e===r){if(t>n){const s=t;t=n,n=s}}else if(a.setStart(e,t),a.comparePoint(r,n)<0){const s=e,o=t;e=r,t=n,r=s,n=o}return a.setStart(e,t),a.setEnd(r,n),this.fromRange(a)}static fromRange(e){if(!e.commonAncestorContainer)return null;const t=new this(e.startContainer,e.startOffset,e.endContainer,e.endOffset,e.collapsed,e.commonAncestorContainer);return t._range=e,t}isCaret(){return!1}isValid(){if(this._isValid!==void 0)return this._isValid;let e=this.startCaret.isValid();return e&&this.startNode!==this.endNode&&(e&&=this.endCaret.isValid()),this._isValid=e,this._isValid}isStartAtText(){return this.startNode.nodeType===3}isEndAtText(){return this.endNode.nodeType===3}toTargetCaret(e=!0){return e?this.startCaret:this.endCaret}get DOMRange(){if(this._range)return this._range;const e=document.createRange();return e.setStart(this.startNode,this.startOffset),e.setEnd(this.endNode,this.endOffset),e}get etRange(){return this._etRange||(this._etRange=new ce(this.startNode,this.startOffset,this.endNode,this.endOffset)),this._etRange}get startCaret(){return this._startCaret?this._startCaret:this.collapsed&&this._endCaret?this._endCaret:(this._startCaret=new this._TargetCaret(this.startNode,this.startOffset),this._startCaret)}get endCaret(){return this._endCaret?this._endCaret:this.collapsed&&this._startCaret?this._startCaret:(this._endCaret=new this._TargetCaret(this.endNode,this.endOffset),this._endCaret)}isTextCommonAncestor(){return this.commonAncestor.nodeType===3}isRangeCommonAncestorHasChildNodes(){return!this.collapsed&&this.commonAncestor.hasChildNodes()}getStartPartialNode(e){return this.startCaret.getPartialNode(e,0)}getEndPartialNode(e){return this.endCaret.getPartialNode(e,-1)}get startAncestor(){return this._startAncestor!==void 0?this._startAncestor:this.collapsed?(this._startAncestor=null,null):(this._startAncestor=this.isTextCommonAncestor()?this.commonAncestor:this.startNode===this.commonAncestor?this.commonAncestor.childNodes.item(this.startOffset):this.body.outerNodeUnder(this.startNode,this.commonAncestor),this._startAncestor)}get endAncestor(){return this._endAncestor!==void 0?this._endAncestor:this.collapsed?(this._endAncestor=null,null):(this._endAncestor=this.isTextCommonAncestor()?this.commonAncestor:this.endNode===this.commonAncestor?this.commonAncestor.childNodes.item(this.endOffset-1):this.body.outerNodeUnder(this.endNode,this.commonAncestor),this._endAncestor)}get anchorEtElement(){return this.startEtElement}get anchorParagraph(){return this.startParagraph}get anchorTopElement(){return this.startTopElement}get commonEtElement(){return this._commonEtElement!==void 0?this._commonEtElement:(this._commonEtElement=this.body.findInclusiveEtParent(this.commonAncestor),this._commonEtElement)}get startEtElement(){return this._startEtElement!==void 0?this._startEtElement:this.startNode===this.endNode&&this._endEtElement!==void 0?(this._startEtElement=this._endEtElement,this._startEtElement):(this._startEtElement=this.startCaret.anchorEtElement,this._startEtElement)}get endEtElement(){return this._endEtElement!==void 0?this._endEtElement:this.startNode===this.endNode&&this._startEtElement!==void 0?(this._endEtElement=this._startEtElement,this._endEtElement):(this._endEtElement=this.endCaret.anchorEtElement,this._endEtElement)}get startParagraph(){return this._startParagraph!==void 0?this._startParagraph:this.startNode===this.endNode&&this._endParagraph!==void 0?(this._startParagraph=this._endParagraph,this._startParagraph):(this._startParagraph=this.startCaret.anchorParagraph,this._startParagraph)}get endParagraph(){return this._endParagraph!==void 0?this._endParagraph:this.startNode===this.endNode&&this._startParagraph!==void 0?(this._endParagraph=this._startParagraph,this._endParagraph):(this._endParagraph=this.endCaret.anchorParagraph,this._endParagraph)}get startTopElement(){return this._startTopElement!==void 0?this._startTopElement:this.startNode===this.endNode&&this._endTopElement!==void 0?(this._startTopElement=this._endTopElement,this._startTopElement):(this._startTopElement=this.startCaret.anchorTopElement,this._startTopElement)}get endTopElement(){return this._endTopElement!==void 0?this._endTopElement:this.startNode===this.endNode&&this._startTopElement!==void 0?(this._endTopElement=this._startTopElement,this._endTopElement):(this._endTopElement=this.endCaret.anchorTopElement,this._endTopElement)}isCaretAtParagraphStart(){return this.collapsed&&this.startCaret.isCaretAtParagraphStart()}isCaretAtParagraphEnd(){return this.collapsed&&this.startCaret.isCaretAtParagraphEnd()}isCaretAtBodyStart(){return this.collapsed&&this.startCaret.isCaretAtBodyStart()}isCaretAtBodyEnd(){return this.collapsed&&this.startCaret.isCaretAtBodyEnd()}},da=e=>{class t extends ha{constructor(a,i){super(a,i),this.container=a,this.offset=i}}class r extends ca{constructor(a,i,s,o,l,h){super(a,i,s,o,l,h),this.startNode=a,this.startOffset=i,this.endNode=s,this.endOffset=o,this.collapsed=l,this.commonAncestor=h}}return Object.defineProperty(t.prototype,"body",{value:e}),Object.defineProperty(r.prototype,"body",{value:e}),Object.defineProperty(r.prototype,"_TargetCaret",{value:t}),r},Ut=class{constructor(e,t){this._ctx=e,this._body=t,this._inShadow=!1,this._getSelection=document.getSelection.bind(document),this.TargetRange=da(this._body)}isolated=!1;history=new ua(this);ranges=[];_inShadow;_selection=null;_getSelection;TargetRange;_rawEl=null;_range=null;_collapsed=!0;_caretRange=null;_targetRange=null;_validTargetRange=void 0;_isForward;_anchorText=null;_selectedNode=null;_commonEtElement;_focusEtElement;_focusParagraph;_focusTopElement;_scrollIntoViewTime=0;get type(){return this.selectedNode?"Node":this.isCollapsed?"Caret":"Range"}get range(){return this._range}get selection(){return this._selection||(this._selection=this._getSelection()),this._selection}get commonAncestor(){return this._range?this._range.commonAncestorContainer:null}get selectedNode(){return this._selectedNode}get anchorText(){return this._anchorText?this._anchorText:!this._rawEl&&this._targetRange&&this._targetRange.isTextCommonAncestor()?this._anchorText=this._targetRange.commonAncestor:null}get anchorOffset(){return this._range?this._range.startOffset:0}get focusNode(){return this.anchorText||this.selection?.focusNode?.childNodes.item(this.selection.focusOffset)}get inShadow(){return this._inShadow}get isCollapsed(){return this._rawEl?this._rawEl.selectionStart===this._rawEl.selectionEnd:this._collapsed}get isForward(){if(this._isForward!==void 0)return this._isForward;if(this.isCollapsed)return this._isForward=!0;const e=this._selection;if(!e||!e.direction)return this._isForward=!0;if(e.direction!=="none")return this._isForward=e.direction==="forward";const t=this._range;return this._isForward=!!t&&t.startContainer===e.anchorNode&&t.startOffset===e.anchorOffset}setSelectionGetter(e){if(!e.getSelection){this._inShadow=!1;return}this._getSelection=e.getSelection.bind(e),this._inShadow=!0}update(){if(this._rawEl){const e=document.createRange();return e.setStart(this._rawEl,0),e.setEnd(this._rawEl,0),this.updateSelCtx(e),!0}return this._update()}_update(){const e=this.selection;return!e||e.rangeCount===0?!1:(this.updateSelCtx(e.getRangeAt(0)),!0)}updateSelCtx(e){const t=this._anchorText;this._range=e,this._anchorText=null,this._caretRange=this._setCaretRange(),this._targetRange=this.TargetRange.fromRange(e),this._validTargetRange=void 0,this._collapsed=e.collapsed,this._isForward=void 0,(!t||t!==this.anchorText||!this._focusEtElement?.isConnected)&&(this._commonEtElement=void 0,this._focusEtElement=void 0,this._focusParagraph=void 0,this._focusTopElement=void 0),this._collapsed?(this._body.el.classList.remove("Et--selection-range","Et--selection-all"),this._updateSelectedNode()):(this._body.el.classList.add("Et--selection-range"),this.isRangingBody?this._body.el.classList.add("Et--selection-all"):this._updateSelectedNode())}_updateSelectedNode(){if(this._selectedNode&&(this._selectedNode.classList?.remove("Et--selection-node"),this._selectedNode=null),!this._range)return this._selectedNode=null;if(this._range.endOffset!==this._range.startOffset+1||this._range.startContainer!==this._range.endContainer||this._range.commonAncestorContainer.nodeType===3)return this._selectedNode=null;this._selectedNode=this._range.startContainer.childNodes.item(this._range.startOffset),this._selectedNode.classList?.add("Et--selection-node")}clear(){this._range=null,this._targetRange=null,this._validTargetRange=void 0,this._commonEtElement=void 0,this._focusEtElement=void 0,this._focusParagraph=void 0,this._focusTopElement=void 0}restore(){return this._caretRange?this.selectCaretRange(this._caretRange):!1}get selectedTextContent(){return this._rawEl?this._rawEl.value.slice(this._rawEl.selectionStart,this._rawEl.selectionEnd):this.isCollapsed||!this._range?"":this._range.toString()}get commonEffectElement(){return this._commonEtElement!==void 0?this._commonEtElement:this._commonEtElement=this._targetRange&&this._targetRange.commonEtElement}get focusEffectElement(){return this._focusEtElement!==void 0?this._focusEtElement:(this.isForward?this._focusEtElement=this._targetRange&&this._targetRange.endEtElement:this._focusEtElement=this._targetRange&&this._targetRange.startEtElement,this._focusEtElement)}get focusParagraph(){return this._focusParagraph!==void 0?this._focusParagraph:(this.isForward?this._focusParagraph=this._targetRange&&this._targetRange.endParagraph:this._focusParagraph=this._targetRange&&this._targetRange.startParagraph,this._focusParagraph)}get focusTopElement(){return this._focusTopElement!==void 0?this._focusTopElement:(this.isForward?this._focusTopElement=this._targetRange&&this._targetRange.endTopElement:this._focusTopElement=this._targetRange&&this._targetRange.startTopElement,this._focusTopElement)}get isCaretAtParagraphStart(){return this._targetRange&&this._targetRange.isCaretAtParagraphStart()}get isCaretAtParagraphEnd(){return this._targetRange&&this._targetRange.isCaretAtParagraphEnd()}get isCaretAtBodyStart(){return this._targetRange&&this._targetRange.isCaretAtBodyStart()}get isCaretAtBodyEnd(){return this._targetRange&&this._targetRange.isCaretAtBodyEnd()}get isRangingBody(){return!this.isCollapsed&&this._range&&this._range.startContainer===this._range.endContainer&&this._range.startContainer===this._body.el&&this._range.startOffset===0&&this._range.endOffset===this._body.el.childNodes.length}isSelectionAtFirstLineOf(e){if(!e.textContent)return!0;if(!this._targetRange)return!1;const t=this._targetRange.toTargetCaret(!this.isForward);return C.isPositionAtFirstLineOf(e,t)}isSelectionAtLastLineOf(e){if(!e.textContent)return!0;if(!this._targetRange)return!1;const t=this._targetRange.toTargetCaret(!this.isForward);return C.isPositionAtLastLineOf(e,t)}isSelectionInSameParagraph(e){return!e&&(e=this.getTargetRange(),!e)?null:e.isCaret()?e.anchorParagraph:e.startParagraph===e.endParagraph?e.startParagraph:null}_setCaretRange(){return this._rawEl?this._caretRange=c.inRaw(this._rawEl,this._rawEl.selectionStart,this._rawEl.selectionEnd).markConnected():this._caretRange=c.fromRange(this._range??{collapsed:!0,startContainer:this._body.el,startOffset:0,endContainer:this._body.el,endOffset:0}).markConnected()}getCaretRange(){return this._caretRange?this._caretRange:this._setCaretRange()}getTargetCaret(){const e=this.getTargetRange();return!e||!e.collapsed?null:e.toTargetCaret()}getTargetRange(){return this._validTargetRange!==void 0?this._validTargetRange:!this._targetRange||!this._targetRange.isValid()?this._validTargetRange=null:(this.isForward||(this._targetRange.isBackward=!0),this._validTargetRange=this._targetRange)}createTargetCaret(e,t){if(!e||(e.toRange&&(e=e.toRange()),!e))return null;let r;if(e instanceof Range){if(!e.collapsed)return null;r=this.TargetRange.createCaret(e.endContainer,e.endOffset)}else{if(!e.isConnected||t===void 0)return null;r=this.TargetRange.createCaret(e,t)}return r.isValid()?r:null}createTargetRange(e,t,r,n){if(!e)return null;let a;if(e.toRange&&(e=e.toRange()),!e)return null;if(e instanceof Range)a=this.TargetRange.fromRange(e);else{if(!t||!r||!n)return null;a=this.TargetRange.createRange(e,t,r,n)}return!a||!a.isValid()?null:a}tellEtCaret(e){return e.anchor!==void 0}checkInsertAt(e,t){return e?this.tellEtCaret(e)&&(e=this.createTargetCaret(e)):e=this.getTargetCaret(),!e||!e.isValid()?!1:t(e)}checkSelectionTarget(e,{caretFn:t,rangeFn:r}){return!e&&(e=this.getTargetRange(),!e)||!e.isValid()?!1:e.isCaret()?t(e):e.collapsed?t(e.toTargetCaret()):r(e)}setInRaw(e=null){this._rawEl=e}get rawEl(){return this._rawEl}selectNode(e){if(!this._body.isNodeInBody(e))return!1;const t=document.createRange();return t.selectNode(e),this.selectRange(t)}selectCaretRange(e){const t=e.toRange();return t?.startContainer.isConnected?(this.selectRange(t),e.isInRaw()?(this.isolated||e.rawEl.focus(),e.rawEl.setSelectionRange(e.start,e.end),this.setInRaw(e.rawEl)):this.setInRaw(null),this._ctx.forceUpdate(),!0):!1}selectRange(e){const t=this.selection;return t?(t.removeAllRanges(),t.addRange(e),this._ctx.forceUpdate(),!0):!1}_collapseInRawEl(e,t=!0){return t?e.selectionEnd=e.selectionStart:e.selectionStart=e.selectionEnd,!0}collapse(e=!0,t=!0){return this._rawEl?this._collapseInRawEl(this._rawEl,e):this.isCollapsed?!0:this.selection?(e?this.selection.collapseToStart():this.selection.collapseToEnd(),t&&this.scrollIntoView(),!0):!1}collapseTo(e,t){this.selection?.collapse(e,t)}isValidPosition(e,t){return e.isConnected?f.isText(e)?t>=0&&t<=e.length:t>=0&&t<=e.childNodes.length:!1}isValidRange(e){return this._body.isNodeInBody(e.startContainer)&&this._body.isNodeInBody(e.endContainer)}modify(e,t,r,n=!0){return this.selection&&this._selection.modify(e,t,r),n&&this.scrollIntoView(["backward","left"].includes(t)),!0}modifyMulti(e){const t=this.selection;if(!t)return!1;for(const r of e)t.modify(...r);return!0}scrollIntoView(e=!0,t="auto"){const r=Date.now();r-this._scrollIntoViewTime<200||(this._scrollIntoViewTime=r,this.scrollIntoViewSync(e,t))}scrollIntoViewSync(e=!0,t="auto",r){if(this._rawEl&&!r){this._scrollIntoViewInRawEl(this._rawEl,e,t);return}if(r&&!this._body.isNodeInBody(r.commonAncestorContainer)||!r&&(r=this._range,!r))return;const n=r.getClientRects();let a=n[e?0:n.length-1];if(!a){let i=r.endContainer.childNodes.item(r.endOffset);if(i||(i=r.endContainer.hasChildNodes()?r.endContainer.lastChild:r.endContainer),f.isElement(i)||(i=i.parentElement),!i)return;a=i.getBoundingClientRect()}this._body.scrollIntoView(a,{toStart:e,scrollBehavior:t})}_scrollIntoViewInRawEl(e,t=!0,r="auto"){let n=0,a=0,i,s;const o=e.value.slice(0,t?e.selectionStart:e.selectionEnd),l=(h,u,g)=>{const m=u.style.cssText;u.style.cssText="",Object.assign(h.style,{...u.style,whiteSpace:g?"pre-wrap":"pre",position:"fixed",top:"0px",left:"0px",visibility:"hidden"}),u.style.cssText=m,document.body.appendChild(h)};if(e.localName==="input")i=e,s=document.createElement("input"),s.value=o,l(s,i,!1),s.scrollLeft=99999,a=s.scrollLeft;else{i=e,s=document.createElement("textarea"),s.value=o;const h=getComputedStyle(i).textWrapMode;if(s.wrap=i.wrap,l(s,i,h==="wrap"),s.scrollTop=99999,n=s.scrollTop,h==="nowrap"){let u=o.lastIndexOf(`
`);u===-1&&(u=0),s.value=o.slice(u),s.scrollLeft=99999,a=s.scrollLeft}}e.scrollTo({left:a,top:n,behavior:r}),s.remove()}_selectSoftLineInRawEl(e){const{selectionStart:t,selectionEnd:r,value:n}=e,a=n.length;let i=t,s=r;for(;i>0&&n[i-1]!==`
`;i--);for(;s<a&&n[s]!==`
`;s++);return n[s]===`
`&&s++,e.setSelectionRange(i,s,"forward"),!0}selectSoftLine(){return this._rawEl?this._selectSoftLineInRawEl(this._rawEl):!!this._selection&&Wt(this._selection)}selectParagraph(){const e=this.getTargetRange();if(e&&e.startParagraph&&e.endParagraph){const t=document.createRange();return e.startParagraph.innerStartEditingBoundary().adoptToRange(t,!0,!1),e.endParagraph.innerEndEditingBoundary().adoptToRange(t,!1,!0),this.selectRange(t)}return!1}selectDocument(){if(this._body.el.childNodes.length===0)return!1;const e=document.createRange();return e.setStart(this._body.el,0),e.setEnd(this._body.el,this._body.el.childNodes.length),this.selectRange(e)}selectAllGradually(){if(this._rawEl)return this._selectAllInRawEl(this._rawEl);const e=this.getTargetRange();if(!e||this.isRangingBody)return!0;let t;if(e.collapsed)e.startParagraph&&f.isEmptyContentNode(e.startParagraph)?t=2:t=0;else if(e.commonAncestor===e.endParagraph&&e.startOffset===0&&e.endOffset===e.endParagraph.childNodes.length)t=2;else{const r=e.startParagraph,n=e.endParagraph;if(r===n&&n)if(f.isEmptyContentNode(n))t=2;else{const a=e.DOMRange.getClientRects();a.length<=1?n.getClientRects().length<=1?t=2:t=1:Math.abs(a[0].y-a[a.length-1].y)<10?t=1:t=2}else t=2}return t===0?this.selectSoftLine():t===1?this.selectParagraph():t===2?this.selectDocument():!1}_selectAllInRawEl(e){const{selectionStart:t,selectionEnd:r,value:n}=e,a=n.length;return t===0&&r===a?!1:n.slice(t,r).includes(`
`)||n[t-1]===`
`||n[r]===`
`?(e.setSelectionRange(0,a,"forward"),!0):this.selectSoftLine()}cloneContents(){return this.isCollapsed||!this._range?document.createDocumentFragment():this._range.cloneContents()}},Wt=L.isFirefox?e=>(e.modify("extend","backward","lineboundary"),e.collapseToStart(),e.modify("extend","forward","lineboundary"),!0):e=>(e.modify("extend","backward","lineboundary"),e.modify("extend","forward","lineboundary"),!0),ua=class{constructor(e){this._sel=e}pos=0;stack=[];record(e){this.stack[this.pos++]=e,this.stack.length=this.pos}backward(){if(!(this.pos<=0)&&!this._sel.selectCaretRange(this.stack[--this.pos])){this.stack.splice(this.pos,1);return}}forward(){if(!(this.pos>=this.stack.length)&&!this._sel.selectCaretRange(this.stack[this.pos++])){this.stack.splice(this.pos-1,1);return}}},fa=class extends Ut{isolated=!0;_nextRange=null;_selRange=null;_borrowSel(e=null){const t=this.selection;return!e||!t?!1:(t.rangeCount&&(this._selRange=t.getRangeAt(0)),t.removeAllRanges(),t.addRange(e),t.rangeCount?t:(this._returnSel(),!1))}_returnSel(){this._selRange&&this.selection&&(this.selection.removeAllRanges(),this.selection.addRange(this._selRange),this._selRange=null)}get isForward(){return!0}_update(){return this._nextRange?(this.updateSelCtx(this._nextRange),this._nextRange=null,!0):!!this._range}selectRange(e){return this._body.isNodeInBody(e.commonAncestorContainer)?(this._nextRange=e,this._ctx.forceUpdate(),!0):(this._nextRange=null,!1)}collapse(e=!0,t=!0){if(this._rawEl)return this._collapseInRawEl(this._rawEl,e);if(this._collapsed)return!0;if(!this._range)return!1;const r=document.createRange();return e?r.setStart(this._range.startContainer,this._range.startOffset):r.setStart(this._range.endContainer,this._range.endOffset),this._ctx.forceUpdate(),t&&this.scrollIntoView(),!0}collapseTo(e,t){if(!this._body.isNodeInBody(e))return;const r=document.createRange();r.setStart(e,Math.min(f.nodeLength(e),t)),this.selectRange(r)}modify(e,t,r,n=!0){const a=this._borrowSel(this._range);return a&&(a.modify(e,t,r),this.selectRange(a.getRangeAt(0)),this._returnSel()),n&&this.scrollIntoView(["backward","left"].includes(t)),!0}modifyMulti(e){const t=this._borrowSel(this._range);if(!t)return!1;for(const r of e)t.modify(...r);return t.rangeCount&&this.selectRange(t.getRangeAt(0)),this._returnSel(),!0}selectSoftLine(){if(this._rawEl)return this._selectSoftLineInRawEl(this._rawEl);const e=this._borrowSel(this._range);return e&&(Wt(e),e.rangeCount&&this.selectRange(e.getRangeAt(0)),this._returnSel()),!1}},ga=class{config;updateChecker={};onConfigUpdate;constructor(e,{onConfigUpdate:t}={}){if(this.onConfigUpdate=t,!e)this.config={};else try{this.config=JSON.parse(e)}catch(r){console.error("ConfigManager parse configJson error",r),this.config={}}this.setConfigChecker("editorConfig",r=>typeof r!="object"||r===null?he:Object.assign({...he},Object.fromEntries(Object.entries(he).map(([n,a])=>[n,typeof r[n]==typeof a?r[n]:a]))))}getConfig(e){return this.config[e]}setConfigChecker(e,t){this.updateChecker[e]=t}updateConfig(e,t){const r=this.updateChecker[e];this.config[e]=r?r(t):t,this.onConfigUpdate?.({updatedKey:e,config:this.config,get configJson(){try{return JSON.stringify(this.config)}catch(n){return console.error("ConfigManager updateConfig error",n),JSON.stringify({})}}})}},ma={"`":"·","~":"～","!":"！","@":"＠",$:"¥","^":"……","(":"（",")":"）","-":"－",_:"——","[":"【","]":"】","{":"「","}":"」","\\":"、","|":"｜",";":"；",":":"：","'":"‘",'"':"“",",":"，",".":"。","<":"《",">":"》","?":"？"},pa=class{constructor(e,t){this._ctx=e,this.isSupportInsertFromComposition=t,this._configManager=e.editor.configManager,this.setImeChars(ma);const r=this._configManager.getConfig("imeCharsMapping");let n=!1;if(r&&typeof r=="object")for(const[a,i]of Object.entries(r))typeof i=="string"?this._imeCharMap[a]=i:n=!0;else n=!0;n&&this._configManager.updateConfig("imeCharsMapping",this._imeCharMap)}_imeCharMap={};_imeCharToWritableKey={};_configManager;_isUsingIME=!1;get isUsingIME(){return this._isUsingIME}setUsingIME(e){return this._isUsingIME=e,e}getImeChar(e){return this._imeCharMap[e]}getWritableKey(e){return this._imeCharToWritableKey[e]}getImeCharsMap(){return{...this._imeCharMap}}setImeChars(e){for(const[t,r]of Object.entries(e))r&&(this._imeCharToWritableKey[this._imeCharMap[t]=r.slice(0,2)]=t)}_inSession=!1;get inSession(){return this._inSession}setInSession(e){return this._inSession=e,e}_updateCount=0;get updateCount(){return this._updateCount}_lastNode=void 0;onStart(){this._inSession=!0,this._isUsingIME=!0,this._updateCount=0,this._ctx.selection.rawEl||(this._lastNode=this._ctx.focusEtElement?.lastChild)}onUpdate(){this._updateCount++}onEnd(e){if(this._ctx.commandManager.commit(),setTimeout(()=>{this._inSession=!1},0),this._ctx.selection.rawEl?this.onEndInRawEl(this._ctx.selection.rawEl,e):this.onEndInEditable(e),this.isSupportInsertFromComposition)this._ctx.skipNextKeydown();else return this._ctx.forceUpdate(),this._ctx.nextKeydownSkipped}onEndInRawEl(e,t){}onEndInEditable(e){if(this._ctx.focusEtElement){const t=this._lastNode,r=this._ctx.focusEtElement.lastChild;r&&r.nodeName==="BR"&&r!==t&&(t?t.nodeName==="BR"&&r.replaceWith(t):r.remove()),!r&&t&&this._ctx.focusEtElement.appendChild(t)}if(this._lastNode=null,e){const t=this._ctx.selection.anchorText;t&&t.data[this._ctx.selection.anchorOffset-1]==="​"&&this._ctx.commandManager.handleUpdateText(t,this._ctx.selection.anchorOffset-1,1,"",!1),this._ctx.focusEtElement&&this._ctx.getEtHandler(this._ctx.focusEtElement).InsertCompositionTextSuccess?.(this._ctx,e)}}},it=(e,t,r,n)=>{if(!t.commonEtElement)return;e.preventDefault(),e.stopPropagation();const a=t.getEtHandler(t.commonEtElement),{selectionStart:i,selectionEnd:s}=r;switch(e.inputType){case"insertCompositionText":{if(!e.data)return;a.InsertCompositionTextInRawEl(t,{rawEl:r,data:e.data});break}case"insertFromComposition":e.data&&a.InsertCompositionTextInRawEl(t,{rawEl:r,data:e.data});break;case"insertFromDrop":case"insertFromPaste":case"insertText":{if(e.isTrusted)return;let o=e.data;if(!o&&(o=e.dataTransfer?.getData("text/plain")||"",!o))return;i===s?a.InsertTextInRawEl(t,{rawEl:r,data:o,offset:i}):a.ReplaceTextInRawEl(t,{rawEl:r,data:o,start:i,end:s});break}case"insertLineBreak":case"insertParagraph":{i===s?a.InsertTextInRawEl(t,{rawEl:r,data:`
`,offset:i}):a.ReplaceTextInRawEl(t,{rawEl:r,data:`
`,start:i,end:s});break}case"deleteContentBackward":case"deleteWordBackward":case"deleteContentForward":case"deleteWordForward":case"deleteSoftLineBackward":case"deleteSoftLineForward":{const o=e.inputType.at(-8)==="B",l=e.inputType[6]==="W",h=e.inputType[6]==="S";i===s?a.DeleteInRawEl(t,{rawEl:r,isBackward:o,deleteType:h?"line":l?"word":"char"}):a.DeleteTextInRawEl(t,{rawEl:r,start:i,end:s,selectMode:o?"end":"start"});break}case"deleteContent":case"deleteByCut":{if(i===s)return;a.DeleteTextInRawEl(t,{rawEl:r,start:i,end:s,selectMode:"end"});break}case"formatIndent":{a.FormatIndentInRawEl(t,{rawEl:r,start:i,end:s});break}case"formatOutdent":a.FormatOutdentInRawEl(t,{rawEl:r,start:i,end:s});break;case"historyRedo":case"historyUndo":{n?.[e.inputType]?.(e,t);break}default:e.preventDefault()}t.commandManager.handle()},st=(e,t)=>{let r;if(e.inputType)r="E"+e.inputType;else{if(!e.data)return;r=e.data[0].toUpperCase()===e.data[0]?e.data:"E"+e.data}let n,a;if((a=e.getTargetRanges?.()[0])&&(n=t.selection.createTargetRange(c.fromRange(a))),n||(n=t.selection.getTargetRange()),!n||!a&&t.commonEtElement!==n.commonEtElement)return!1;t.effectInvoker.invoke(t.commonEtElement,r,t,{data:e.data,dataTransfer:e.dataTransfer,targetRange:n})&&e.preventDefault(),t.commandManager.handleAndUpdate()},Ea={...L.isSafari?{insertText(e,t){if(e.isTrusted){e.preventDefault();return}st(e,t)}}:{},default:st},Kt=class{};Object.assign(Kt.prototype,Ea);var Oe=(e,t,r,n)=>{if(!t.isUpdated())return e.preventDefault(),!1;let a;return n&&(a=n[t.commonEtElement.localName]||n[e.inputType]||n.default,typeof a=="function"&&a(e,t)),t.defaultSkipped?!1:(a=r[e.inputType]||r.default,typeof a=="function"&&a(e,t),!0)},_a=(e,t,r)=>n=>{if(!e.isUpdated()){n.preventDefault();return}if(n.stopPropagation(),e.composition.inSession){if(["deleteContentBackward","deleteWordBackward","deleteContentForward","deleteWordForward"].includes(n.inputType))return;e.selection.rawEl?it(n,e,e.selection.rawEl):Oe(n,e,t,void 0);return}if(e.selection.rawEl?it(n,e,e.selection.rawEl,r):Oe(n,e,t,r),!n.defaultPrevented){n.preventDefault();return}["insertCompositionText","deleteCompositionText"].includes(n.inputType)||e.body.dispatchInputEvent("input",{inputType:n.inputType,data:n.data})},Ca=e=>{customElements.get(e.elName)||(customElements.define(e.elName,e),Object.defineProperty(e,"thisHandler",{value:e,configurable:!1,enumerable:!1,writable:!1}),Object.defineProperty(e,"superHandler",{value:e.__proto__??Object.getPrototypeOf(e),configurable:!1,enumerable:!1,writable:!1}))},$e=(e,t,r)=>{Object.assign(e,t),r&&(e.inEtType|=r,e.notInEtType-=e.notInEtType&r)},Ta=L.isSupportInsertFromComposition?()=>!0:I((e,t)=>(t.data&&e.commandManager.push(d.insertCompositionText({data:t.data})),!0)),va=I(()=>!0),ya=I((e,{data:t,targetRange:r})=>t?X(e,t,r.toTargetCaret()):!0),ba=I((e,t)=>t.targetRange.collapsed?!0:x(e,t.targetRange)),jt=function(e,t,r){if(!t.isAtText())return!1;const n=t.container;if(n.data==="​"&&t.anchorParagraph?.childNodes.length===1)return qt.call(this,e,t);const a=r?e.segmenter.precedingWord(n.data,t.offset):e.segmenter.precedingChar(n.data,t.offset);return!a||!n?!1:n.length===a.length?U(e,n,n,t.anchorParagraph):(e.commandManager.push(d.deleteText({text:n,data:a,offset:t.offset-a.length,isBackward:!0,setCaret:!0})),!0)};function qt(e,t){if(t.anchorParagraph===e.bodyEl.firstChild)return!0;const r=this.DeleteBackwardAtParagraphStart?.(e,t);return typeof r=="object"?(e.setCaretToAParagraph(r,!1),!0):!!r}var Vt=function(e,t){return t.isCaretAtParagraphStart()?qt.call(this,e,t):!1},zt=(e,t)=>{if(t.isAtText())return!1;let r=t.prevNode;return r||(r=t.container),r===e.bodyEl||e.isPlainParagraph(r)?!0:U(e,r,r,t.anchorParagraph)},Gt=(e,t)=>{if(e.selection.modifyMulti([["move","backward","character"],["extend","forward","character"]])){if(e.selection.selection?.isCollapsed)return!0;e.forceUpdate();const r=e.selection.getTargetRange();return r?x(e,r):!1}return!1},$t=function(e,t,r){if(!t.isAtText())return!1;const n=t.container;if(n.textContent==="​"&&t.anchorParagraph?.childNodes.length===1)return Qt.call(this,e,t);const a=r?e.segmenter.followingWord(n.data,t.offset):e.segmenter.followingChar(n.data,t.offset);return!a||!n?!1:n.length===a.length?U(e,n,n,t.anchorParagraph):(e.commandManager.push(d.deleteText({text:n,data:a,offset:t.offset,isBackward:!1,setCaret:!0})),!0)};function Qt(e,t){const r=this.DeleteForwardAtParagraphEnd?.(e,t);return typeof r=="object"?(e.setCaretToAParagraph(r,!0),!0):!!r}var Zt=function(e,t){return t.isCaretAtParagraphEnd()?Qt.call(this,e,t):!1},Jt=(e,t)=>{if(t.isAtText())return!1;let r=t.nextNode;return r||(r=t.container),r===e.bodyEl||e.isPlainParagraph(r)?!0:U(e,r,r,t.anchorParagraph)},Xt=(e,t)=>{if(e.selection.modifyMulti([["move","forward","character"],["extend","backward","character"]])){if(e.selection.selection?.isCollapsed)return!0;e.forceUpdate();const r=e.selection.getTargetRange();return r?x(e,r):!1}return!1},wa=I((e,t)=>t.targetRange.collapsed?!0:x(e,t.targetRange)),Sa=I(function(e,t){if(e.setCaretAffinityPreference(!0),!t.targetRange.collapsed)return x(e,t.targetRange);const r=t.targetRange.toTargetCaret();return jt.call(this,e,r,!1)||Vt.call(this,e,r)||zt(e,r)||Gt(e)}),Na=I(function(e,t){if(e.setCaretAffinityPreference(!1),!t.targetRange.collapsed)return x(e,t.targetRange);const r=t.targetRange.toTargetCaret();return $t.call(this,e,r,!1)||Zt.call(this,e,r)||Jt(e,r)||Xt(e)}),Aa=I(e=>{if(e.selection.isCollapsed)return!0;e.selection.modifyMulti([["extend","backward","lineboundary"],["extend","forward","lineboundary"]]),e.forceUpdate();const t=e.selection.getTargetRange();return!t||t.collapsed?!1:x(e,t)}),ka=I(e=>{if(e.selection.isCaretAtParagraphStart)return!0;e.selection.modify("extend","backward","lineboundary",!1),e.forceUpdate();const t=e.selection.getTargetRange();return!t||t.collapsed?!1:x(e,t)}),Pa=I(e=>{if(e.selection.isCaretAtParagraphEnd)return!0;e.selection.modify("extend","forward","lineboundary",!1),e.forceUpdate();const t=e.selection.getTargetRange();return!t||t.collapsed?!1:x(e,t)}),Ra=R("DeleteBackwardAtParagraphStart",(e,t)=>{const r=t.anchorParagraph;if(!r)return!1;const n=r.isEmpty();let a=r.previousSibling;if(a){if(n)return e.commandManager.push(d.removeNode({node:r,destCaretRange:null})),e.commandManager.pushHandleCallback(l=>{e.setCaretToAParagraph(l,!1,!0)},a),!0;if(a.isEmpty())return e.commandManager.push(d.removeNode({node:a,destCaretRange:null})),!0;if(pe(e,a,r))return!0;let o=a;return T.check(a,16)&&(o=a.lastParagraph),T.check(o,64)?(o.focusToInnerEditable(e,!1),!0):o!==a?(pe(e,o,r)||e.setSelection(o.innerEndEditingBoundary()),!0):Yt(e,a,r)}const i=e.body.outerParagraphs(r).next().value;if(!i)return!1;if(a=i.previousSibling,!a){if(!n)return!0;const o=r.nextSibling;if(o)return e.commandManager.push(d.removeNode({node:r,destCaretRange:null})),e.commandManager.pushHandleCallback(l=>{e.setCaretToAParagraph(l,!0,!0)},o),!0;if(e.isPlainParagraph(i))return!0;if(r.parentNode===i){const l=i.regressToPlainParagraph(e);return e.commandManager.push(d.replaceNode({oldNode:i,newNode:l,destCaretRange:c.caretInStart(l)})),!0}return!1}if(!n){if(a.isEqualTo(i)){const o=document.createRange();if(a.innerEndEditingBoundary().adoptToRange(o,!0,!1),o){o.setEnd(r,0);const l=e.selection.createTargetRange(o);if(e.setCaretAffinityPreference(!0),l&&x(e,l))return!0}}return e.commandManager.pushHandleCallback(o=>{e.setCaretToAParagraph(o,!1,!0)},a),!0}const s=r.nextSibling?r:i;return e.commandManager.push(d.removeNode({node:s,destCaretRange:null})),e.commandManager.pushHandleCallback(o=>{e.setCaretToAParagraph(o,!1,!0)},a),!0}),Ma=R("DeleteForwardAtParagraphEnd",(e,t)=>{const r=t.anchorParagraph;if(!r)return!1;const n=r.isEmpty();let a=r.nextSibling;if(a){if(a.isEmpty())return e.commandManager.push(d.removeNode({node:a,destCaretRange:null})),!0;if(n)return e.commandManager.push(d.removeNode({node:r,destCaretRange:null})),e.commandManager.pushHandleCallback(o=>{e.setCaretToAParagraph(o,!0,!0)},a),!0;if(pe(e,r,a))return!0;let s=a;return T.check(a,16)&&(s=a.firstParagraph),T.check(s,64)?(s.focusToInnerEditable(e,!0),!0):s!==a?(e.commandManager.push(d.null()),e.commandManager.pushHandleCallback(o=>{e.setCaretToAParagraph(o,!0,!0)},s),!0):Yt(e,r,a)}const i=e.body.outerParagraphs(r).next().value;if(!i)return!1;if(a=i.nextSibling,!a){if(!n)return!0;const s=r.previousSibling;if(s)return e.commandManager.push(d.removeNode({node:r,destCaretRange:null})),e.commandManager.pushHandleCallback(o=>{e.setCaretToAParagraph(o,!1,!0)},s),!0;if(e.isPlainParagraph(i))return!0;if(r.parentNode===i){const o=i.regressToPlainParagraph(e);return e.commandManager.push(d.replaceNode({oldNode:i,newNode:o,destCaretRange:c.caretInStart(o)})),!0}return!1}if(e.isPlainParagraph(a)){if(pe(e,r,a))return!0}else if(i.isEqualTo(a)){const s=document.createRange();t.etCaret.adoptToRange(s,!0,!1),a.innerStartEditingBoundary().adoptToRange(s,!1,!0);const o=e.selection.createTargetRange(s);if(e.setCaretAffinityPreference(!1),o&&x(e,o))return!0}return e.commandManager.push(d.null()),e.commandManager.pushHandleCallback(s=>{e.setCaretToAParagraph(s,!0,!0)},a),!0}),pe=(e,t,r)=>{if(!t.isEqualTo(r))return!1;if(!r.hasChildNodes())return e.commandManager.push(d.removeNode({node:r,destCaretRange:c.caretInEnd(t)})),!0;if(!t.hasChildNodes()){const o=r.lastChild,l=o?c.caretInEnd(o):void 0;return e.commandManager.push(d.removeNode({node:r})),ot(e.commandManager,t,r,l),!0}const n=[],a=r.firstChild;let i=t.lastChild,s;if(f.isBrElement(i)&&(n.push(d.removeNode({node:i})),i=i.previousSibling),i){const o=w.cloneAndMergeNodesToEtFragmentAndCaret(i,a,!1);if(!o)return!1;const l=c.caretOutStart(i);n.push(d.removeNode({node:i}),d.removeNode({node:a}),d.insertContent({content:o[0],execAt:l})),s=o[1]}else s=c.caretStartAuto(a);return ot(n,t,r),n.push(d.removeNode({node:r,destCaretRange:s})),e.commandManager.push(...n),!0},ot=(e,t,r,n)=>{e.push(d.functional({meta:{from:r,to:t,startChild:null},execCallback(){const{from:a,to:i}=this.meta;let s=a.firstChild;for(this.meta.startChild=s;s;)i.appendChild(s),s=a.firstChild},undoCallback(){const{from:a,startChild:i}=this.meta;if(!i)return;let s=i.nextSibling;for(;s;)a.appendChild(s),s=i.nextSibling;a.prepend(i)},destCaretRange:n}))},Yt=(e,t,r)=>{const n=document.createRange();n.selectNodeContents(r);const a=n.cloneContents();w.normalizeAndCleanEtFragment(a,t,!0);const i=t.lastChild,s=a.firstChild;if(!s)return e.commandManager.push(d.removeNode({node:r})),e.setCaretToAParagraph(t,!1),!0;if(!i)return e.commandManager.push(d.removeNode({node:r})),e.commandManager.push(d.insertContent({content:a,execAt:c.caretOutEnd(t)})),!0;if(f.isEqualNode(i,s)){const o=document.createDocumentFragment();o.appendChild(i.cloneNode(!0));const l=w.getMergedEtFragmentAndCaret(o,a);if(!l)return!1;e.commandManager.push(d.removeNode({node:i}),d.insertContent({content:l[0],execAt:c.caretOutStart(i),destCaretRange:l[1]}))}return!0},Ia=I(function(e,t){if(e.setCaretAffinityPreference(!0),!t.targetRange.collapsed)return x(e,t.targetRange);const r=t.targetRange.toTargetCaret();return jt.call(this,e,r,!0)||Vt.call(this,e,r)||zt(e,r)||Gt(e)}),xa=I(function(e,t){if(e.setCaretAffinityPreference(!1),!t.targetRange.collapsed)return x(e,t.targetRange);const r=t.targetRange.toTargetCaret();return $t.call(this,e,r,!0)||Zt.call(this,e,r)||Jt(e,r)||Xt(e)}),Fa=I(function(e,t){const r=t.dataTransfer;return r?e.commonHandler.checkRemoveTargetRange(t.targetRange,(n,a)=>{const i=r.getData("text/html");if(i){let o=n.editor.htmlProcessor.fromHtml(n,i);if(this.TransformInsertContents&&(o=this.TransformInsertContents(n,{fragment:o,toEtElement:a.anchorEtElement})),o.hasChildNodes())return ke(n,o,a),!0}const s=r.getData("text/plain");return s?X(n,s,a):!1}):!0}),Ba=R("InsertFromEtHtml",function(e,t){const r=e.selection.getTargetRange();return!r||typeof t!="string"?!1:e.commonHandler.checkRemoveTargetRange(r,(n,a)=>{let i=w.parseEtHtmlFromPaste(n,t);return this.TransformInsertContents&&(i=this.TransformInsertContents(n,{fragment:i,toEtElement:a.anchorEtElement})),i.hasChildNodes()?ke(n,i,a):!1})}),Oa=I((e,t)=>{if(!t.targetRange.collapsed)return e.selection.collapse(!e.selection.isForward),!0;if(e.editor.config.INSERT_BR_FOR_LINE_BREAK){const r=f.el("br");Ae(e,r,t.targetRange.toTargetCaret(),c.caretOutEnd(r))}else e.commonHandler.insertText(`
​`,t.targetRange.toTargetCaret());return!0}),La=I((e,{data:t,targetRange:r})=>t?r.collapsed?Da(e,t,r.toTargetCaret()):Ge(e,t,r):!0),Da=(e,t,r)=>{if(!t)return!0;if(!r.isAtText()){const s=f.createText(t);return e.commandManager.push(d.insertNode({node:s,execAt:r.etCaret,destCaretRange:c.caret(s,s.length)})),!0}const n=r.container,a=r.offset;if(t!==" "||a===0||!e.editor.config.AUTO_REPLACE_FULL_WIDTH_PUNC_WITH_HALF_AFTER_SPACE){if(a>0&&n.data[a-1]==="​"){let s=a-1;for(;s>0&&n.data[s-1]==="​";)s--;return e.commandManager.push(d.replaceText({text:n,data:t,delLen:a-s,offset:s,setCaret:!0})),!0}if(a===0&&n.data[a]==="​"){let s=a+1;for(;s<n.length&&n.data[s]==="​";)s++;return e.commandManager.push(d.replaceText({text:n,data:t,delLen:s,offset:a,setCaret:!0})),!0}return e.commandManager.push(d.insertText({text:n,data:t,offset:a,setCaret:!0})),!0}const i=e.composition.getWritableKey(n.data[a-1]);return i?e.commandManager.push(d.replaceText({text:n,data:i,delLen:i.length,offset:a-1,setCaret:!0})):e.commandManager.push(d.insertText({text:n,data:" ",offset:a,setCaret:!0})),!0},er=(e,t)=>{const r=e.nextSibling;if(r&&f.isText(r))return!r.data.startsWith("​")&&t.commandManager.handleUpdateText(r,0,0,"​",!1),t.setSelection(c.caret(r,1));const n=f.zwsText();return t.commandManager.push(d.insertNode({node:n,execAt:c.caretOutEnd(e)})),t.commandManager.handleAndUpdate(c.caret(n,1))},Ha=R("tabout",(e,t)=>T.check(t.anchorEtElement,66)?er(t.anchorEtElement,e):t.isAtText()?(e.commonHandler.insertText("	",t),!0):!1),Ua=R("dblSpace",(e,t)=>{if(e.selection.rawEl){const a=t.anchorParagraph;if(a&&T.check(a,64)){const i=a.nextSibling;if(i)return e.setCaretToAParagraph(i,!0,!0);{const s=e.createPlainParagraph(),o=c.caretInAuto(s);return e.commandManager.push(d.insertNode({node:s,execAt:c.caretOutEnd(a),destCaretRange:o})).handleAndUpdate()}}else{const i=C.treeNextSibling(e.selection.rawEl);if(f.isText(i)&&i.parentElement?.isContentEditable)return e.commonHandler.caretToTextStartWithZWS(i)}return!1}if(!T.check(t.anchorEtElement,66))return!1;if(t.isAtText()){const a=t.container;a.data.slice(t.offset-2,t.offset)==="  "&&e.commandManager.handleUpdateText(a,t.offset-2,"  ","",!1)}const r=e.body.outerEtElements(t.anchorEtElement);let n=t.anchorEtElement;for(const a of r)if(T.check(a,66))n=a;else break;return er(n,e)}),Wa=R("TransformInsertContents",(e,t)=>t.fragment),Ka=R("InsertParagraphAtParagraphStart",(e,t)=>{const r=t.anchorParagraph.createForInsertParagraph(e,-1,!0);return r===null||e.commandManager.push(d.insertNode({node:r,execAt:c.caretOutStart(t.anchorParagraph),destCaretRange:null})),!0}),ja=R("InsertParagraphAtParagraphEnd",(e,t)=>{const r=t.anchorParagraph.createForInsertParagraph(e,1,!0);return r===null||e.commandManager.push(d.insertNode({node:r,execAt:c.caretOutEnd(t.anchorParagraph),destCaretRange:c.caretInAuto(r)})),!0}),qa=R("ParagraphMoveUp",(e,t)=>{const r=t.anchorParagraph.previousSibling;return r?e.commandManager.withRememberScrollTop(e,()=>(e.commandManager.pushHandleCallback(()=>e.selection.scrollIntoViewSync()),e.commandManager.handleMoveNode(r,c.caretOutEnd(r)))):!1}),Va=R("ParagraphMoveDown",(e,t)=>{const r=t.anchorParagraph.nextSibling;return r?e.commandManager.withRememberScrollTop(e,()=>(e.commandManager.pushHandleCallback(()=>e.selection.scrollIntoViewSync()),e.commandManager.handleMoveNode(r,c.caretOutStart(r).moved(-1)))):!1}),za=R("ParagraphCopyUp",(e,t)=>{const r=f.cloneEtElement(t.anchorParagraph,!0);return e.commandManager.handleInsertNode(r,c.caretOutEnd(t.anchorParagraph))}),Ga=R("ParagraphCopyDown",(e,t)=>{const r=f.cloneEtElement(t.anchorParagraph,!0);return e.commandManager.handleInsertNode(r,c.caretOutStart(t.anchorParagraph))}),$a=L.isSupportInsertFromComposition?(e,t)=>(e?.exec(t),!0):(e,t,r,n,a)=>{t.commandManager.push(d.functional({meta:{el:r,_data:n,_start:a,isFirstRun:!0,_tailCmd:e},merge(i){return i.meta&&i.meta.isFirstRun!==void 0?(this.meta._data=i.meta._data,!0):!1},execCallback(){if(this.meta.isFirstRun){this.meta.isFirstRun=!1,this.meta._tailCmd?.exec(t);return}const{el:i,_data:s,_start:o,_tailCmd:l}=this.meta;i.focus(),i.setRangeText(s,o,o,"end"),l?.exec(t)},undoCallback(){const{el:i,_data:s,_start:o,_tailCmd:l}=this.meta;i.focus(),i.setRangeText("",o,o+s.length,"end"),l?.undo(t)},srcCaretRange:null}))},Qa=R("InsertCompositionTextInRawEl",(e,{rawEl:t,data:r,tailCmd:n})=>($a(n,e,t,r,t.selectionStart),!0)),Za=R("InsertTextInRawEl",(e,{rawEl:t,data:r,offset:n,focus:a=!0,tailCmd:i})=>r?(r===`
`&&e.commandManager.commitNextHandle(!0),e.commandManager.push(d.functional({meta:{el:t,_data:r,_offset:n,_focus:a,_tailCmd:i},merge(s){return this.meta.el!==s.meta?.el||!s.meta._data||this.meta._offset+this.meta._data.length!==s.meta._offset?!1:(this.meta._data+=s.meta._data,!0)},execCallback(s){const{el:o,_data:l,_offset:h,_focus:u,_tailCmd:g}=this.meta;u&&o.focus(),o.setRangeText(l,h,h,u?"end":void 0),g?.exec(s)},undoCallback(s){const{el:o,_data:l,_offset:h,_focus:u,_tailCmd:g}=this.meta;u&&o.focus(),o.setRangeText("",h,h+l.length,u?"end":void 0),g?.undo(s)},srcCaretRange:null})),!0):!1),Ja=R("DeleteInRawEl",function(e,{rawEl:t,isBackward:r,deleteType:n,focus:a=!0}){const i=t.selectionStart,s=t.selectionEnd;if(i!==s)return this.DeleteTextInRawEl(e,{rawEl:t,start:i,end:s,selectMode:a?"end":void 0});if(r&&i===0||!r&&s===t.value.length)return!0;const o=t.value;if(n==="word")if(r){let l=o.slice(Math.max(0,i-50),i);if(l=e.segmenter.precedingWord(l,l.length),l){const h=l.split(`
`);return h[h.length-1]?l=h[h.length-1]:l=`
`,this.DeleteTextInRawEl(e,{rawEl:t,start:i-l.length,end:s,selectMode:a?"end":void 0})}}else{let l=o.slice(s,s+50);if(l=e.segmenter.followingWord(l,0),l){const h=l.split(`
`);return h[0]?l=h[0]:l=`
`,this.DeleteTextInRawEl(e,{rawEl:t,start:i,end:s+l.length,selectMode:a?"start":void 0})}}else if(n==="line")if(r){if(o[i-1]===`
`)return this.DeleteTextInRawEl(e,{rawEl:t,start:i-1,end:s,selectMode:a?"end":void 0});for(let l=i-2;l>=0;l--)if(o[l]===`
`)return this.DeleteTextInRawEl(e,{rawEl:t,start:l+1,end:s,selectMode:a?"end":void 0});return this.DeleteTextInRawEl(e,{rawEl:t,start:0,end:s,selectMode:a?"end":void 0})}else{if(o[s]===`
`)return this.DeleteTextInRawEl(e,{rawEl:t,start:i,end:s+1,selectMode:a?"start":void 0});for(let l=s+1;l<o.length;l++)if(o[l]===`
`)return this.DeleteTextInRawEl(e,{rawEl:t,start:i,end:l,selectMode:a?"start":void 0});return this.DeleteTextInRawEl(e,{rawEl:t,start:i,end:o.length,selectMode:a?"start":void 0})}return r?this.DeleteTextInRawEl(e,{rawEl:t,start:i-1,end:s,selectMode:a?"end":void 0}):this.DeleteTextInRawEl(e,{rawEl:t,start:i,end:s+1,selectMode:a?"start":void 0})}),Xa=R("DeleteTextInRawEl",(e,{rawEl:t,start:r,end:n,selectMode:a,tailCmd:i})=>{if(r===n)return!1;const s=t.value.slice(r,n);return e.commandManager.push(d.functional({meta:{el:t,_offset:r,_data:s,_selectMode:a,_tailCmd:i},merge(o){return this.meta.el!==o.meta?.el||!o.meta._data?!1:this.meta._offset===o.meta._offset+o.meta._data.length?(this.meta._data=o.meta._data+this.meta._data,this.meta._offset=o.meta._offset,!0):this.meta._offset===o.meta._offset?(this.meta._data+=o.meta._data,!0):!1},execCallback(o){const{el:l,_offset:h,_data:u,_selectMode:g,_tailCmd:m}=this.meta;g&&l.focus(),l.setRangeText("",h,h+u.length,g),m?.exec(o)},undoCallback(o){const{el:l,_offset:h,_data:u,_selectMode:g,_tailCmd:m}=this.meta;g&&l.focus(),l.setRangeText(u,h,h,g),m?.undo(o)},srcCaretRange:null})),!0}),Ya=R("ReplaceTextInRawEl",(e,{rawEl:t,start:r,end:n,data:a,focus:i=!0,tailCmd:s})=>!a&&r===n?!1:(e.commandManager.push(d.functional({meta:{el:t,_data:a,_start:r,_end:n,_focus:i?"end":void 0,_tailCmd:s},execCallback(o){const{el:l,_data:h,_start:u,_end:g,_focus:m,_tailCmd:p}=this.meta;this.meta._end=u+h.length,this.meta._data=l.value.slice(u,g),m&&l.focus(),l.setRangeText(h,u,g,m?"end":"preserve"),p?.exec(o)},undoCallback(o){const{el:l,_data:h,_start:u,_end:g,_focus:m,_tailCmd:p}=this.meta;this.meta._end=u+h.length,this.meta._data=l.value.slice(u,g),m&&l.focus(),l.setRangeText(h,u,g,m?"select":"preserve"),p?.undo(o)},srcCaretRange:null})),!0)),ei={EinsertCompositionText:Ta,EdeleteCompositionText:va,EinsertFromComposition:ya,EinsertText:La,EinsertLineBreak:Oa,EinsertParagraph:jn,EinsertFromPaste:Fa,EdeleteByCut:ba,EdeleteContent:wa,EdeleteContentBackward:Sa,EdeleteContentForward:Na,EdeleteWordBackward:Ia,EdeleteWordForward:xa,EdeleteEntireSoftLine:Aa,EdeleteSoftLineBackward:ka,EdeleteSoftLineForward:Pa,InsertFromEtHtml:Ba,TransformInsertContents:Wa,InsertParagraphAtParagraphStart:Ka,InsertParagraphAtParagraphEnd:ja,DeleteBackwardAtParagraphStart:Ra,DeleteForwardAtParagraphEnd:Ma,tabout:Ha,dblSpace:Ua,InsertCompositionTextInRawEl:Qa,InsertTextInRawEl:Za,DeleteInRawEl:Ja,DeleteTextInRawEl:Xa,ReplaceTextInRawEl:Ya},ti={ParagraphMoveUp:qa,ParagraphMoveDown:Va,ParagraphCopyUp:za,ParagraphCopyDown:Ga};$e(G,ei);$e(ie,ti);var ri=(e,t)=>r=>{if(!e.editor.status.readonly&&!(!r.isTrusted||!r.clipboardData||!e.isUpdated())){if(r.preventDefault(),t?.(r,e),e.defaultSkipped)return!1;tr(e,r.clipboardData)}},ni=(e,t)=>r=>{if(!(!r.isTrusted||!r.clipboardData||!e.isUpdated())){if(r.preventDefault(),e.selection.isCollapsed&&(e.selection.selectSoftLine(),e.selection.rawEl||e.forceUpdate()),t?.(r,e),e.defaultSkipped)return!1;tr(e,r.clipboardData),e.body.dispatchInputEvent("beforeinput",{inputType:"deleteByCut"})}},ai=(e,t)=>r=>{if(e.editor.status.readonly){r.preventDefault();return}if(!r.isTrusted||!r.clipboardData||!e.isUpdated())return;r.preventDefault();const n=r.clipboardData.getData("text/et-html");if(n&&!e.selection.rawEl){e.effectInvoker.invoke(e.commonEtElement,"InsertFromEtHtml",e,n)&&e.body.dispatchInputEvent("input",{inputType:"insertFromPaste"});return}if(t?.(r,e),e.defaultSkipped)return!1;e.body.dispatchInputEvent("beforeinput",{inputType:"insertFromPaste",data:r.clipboardData.getData("text/plain")})},tr=(e,t)=>{if(e.selection.isCollapsed||(t.setData("text/plain",e.selection.selectedTextContent.replace("​","")),e.selection.rawEl))return;const r=e.selection.cloneContents(),n=r.cloneNode(!0),a=w.parseEtFragmentToEtHtml(e,r),i=w.parseEtFragmentToNativeHTML(e,n);t.setData("text/et-html",a),t.setData("text/html",i)},ii=e=>()=>{e.forceUpdate(),e.selection.isCollapsed||(e.commonHandler.removeRangingContents(),e.selection.scrollIntoViewSync()),e.commandManager.commit(),e.composition.onStart()},si=e=>()=>{e.composition.onUpdate(),e.skipNextKeydown()},oi=e=>t=>{e.composition.onEnd(t.data)},li=class{},hi=(e,t,r)=>n=>{if(!e.isUpdated())return n.preventDefault(),!1;Oe(n,e,t,r)&&e.selection.scrollIntoView(!1,n.inputType==="insertText"?"smooth":"instant"),!e.selection.rawEl&&(n.data&&n.inputType==="insertText"?e.isPlainParagraph(e.focusEtElement)&&e.hotstringManager.listen(n.data):n.inputType==="deleteContentBackward"?e.hotstringManager.backflow(1):e.hotstringManager.needResetBeforeJudge())},ci={Tab:(e,t)=>{if(e.ctrlKey||e.altKey)return;if(t.selection.rawEl)return t.body.dispatchInputEvent("beforeinput",{inputType:e.shiftKey?"formatOutdent":"formatIndent"});if(!t.selection.isCollapsed){t.selection.collapse(!1);return}const r=t.selection.getTargetRange();if(r){if(r.collapsed)return t.getEtHandler(r.startEtElement).tabout?.(t,r.toTargetCaret());t.selection.collapse(!1,!0)}}},rr=class{};Object.assign(rr.prototype,ci);var nr=(e,t,r,n)=>{const a=e.key.length===1?e.key.toUpperCase():e.key;let i;return n&&(i=n[t.commonEtElement.localName]||n[a]||n.default,typeof i=="function"&&i(e,t)),t.defaultSkipped?!1:(i=r[a]||r.default,typeof i=="function"&&i(e,t),!0)},di=(e,t)=>r=>{if(!e.isUpdated()){r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation(),e.editor.blur();return}if(e.composition.setInSession(r.isComposing)){r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation();return}if(e.nextKeydownSkipped||r.key==="Process"){r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation();return}if(r.repeat||e.hotkeyManager.setModkey(r),t){const n=r.key.length===1?r.key.toUpperCase():r.key;let a=t[e.commonEtElement.localName],i=a&&a(r,e);if(i||(a=t[n]||t.default,i=a&&a(r,e)),i)return r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation(),e.defaultSkipped,void 0}},ui=(e,t,r)=>n=>{if(e.hotkeyManager.listenBuiltin()){n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation();return}requestAnimationFrame(()=>{if(!e.composition.inSession){if(n.key.length===1&&!n.ctrlKey&&!n.altKey&&!n.metaKey){if(n.key===e.hotstringManager.trigger&&e.hotstringManager.listen(n.key))return;let a;e.composition.isUsingIME?(a=e.composition.getImeChar(n.key),a||(a=n.key,e.composition.setUsingIME(!1))):a=n.key,e.body.dispatchInputEvent("beforeinput",{data:a,inputType:"insertText"});return}!n.repeat&&e.hotkeyManager.listenBinding()||nr(n,e,t,r)&&e.hotkeyManager.listenDefault()}}),n.stopPropagation(),e.keepDefaultModkeyMap[e.hotkeyManager.modkey]||n.preventDefault(),e.currDownKey=n.key,e.selection.isCollapsed||(e.prevUpKey=null)},fi={Escape:(e,t)=>{t.editor.blur()}," ":(e,t)=>{if(t.prevUpKey===" "){const r=t.selection.getTargetCaret();if(!r||t.selIsolated)return;t.getEtHandler(r.anchorEtElement).dblSpace?.(t,r)}}},ar=class{};Object.assign(ar.prototype,fi);var Ie=void 0,gi=(e,t,r)=>n=>{if(!e.isUpdated())return n.preventDefault(),!1;nr(n,e,t,r),e.affinityPreference=void 0,e.prevUpKey=e.prevUpKey===null?void 0:n.key,Ie&&clearTimeout(Ie),Ie=window.setTimeout(()=>{e.prevUpKey=void 0},211)},mi=(e,t)=>r=>{if(t?.(r,e),!e.defaultSkipped)return r.stopPropagation()},pi=(e,t)=>r=>{if(t?.(r,e),!e.defaultSkipped)return r.stopPropagation()},Ei=(e,t)=>r=>{if(t?.(r,e),!e.defaultSkipped)return r.stopPropagation()},_i=(e,t)=>r=>{if(t?.(r,e),!e.defaultSkipped)return r.stopPropagation()},Ci=(e,t)=>r=>{if(t?.(r,e),!e.defaultSkipped)return e.editor.isShadow&&r.preventDefault(),r.preventDefault()},Ti=(e,t)=>r=>{t?.(r,e),e.defaultSkipped},vi=(e,t)=>r=>{t?.(r,e),!e.defaultSkipped&&r.preventDefault()},yi=(e,t)=>r=>{t?.(r,e),!e.defaultSkipped&&(r.dataTransfer&&(r.dataTransfer.dropEffect="none"),r.preventDefault())},bi=(e,t)=>r=>{t?.(r,e),e.defaultSkipped},wi=(e,t)=>r=>{t?.(r,e),!e.defaultSkipped&&r.preventDefault()},Si=(e,t)=>r=>{e.selChangeSkipped||e.composition.inSession||e.selection.rawEl||!e.editor.isFocused||(e.hotstringManager.needResetBeforeJudge(),e.update(),t?.(r,e))},Ni=(e,t,r)=>({beforekeydown:di(e,r.beforeKeydownSolver),keydown:ui(e,t.keydownSolver,r.keydownSolver),keyup:gi(e,t.keyupSolver,r.keyupSolver),beforeinput:_a(e,t.beforeInputSolver,r.beforeInputSolver),input:hi(e,t.afterInputSolver,r.afterInputSolver),compositionstart:ii(e),compositionupdate:si(e),compositionend:oi(e),copy:ri(e,r.copyCutCallback),cut:ni(e,r.copyCutCallback),paste:ai(e,r.pasteCallback),mousedown:mi(e,r.mousedownCallback),mouseup:pi(e,r.mouseupCallback),click:Ei(e,r.clickCallback),dblclick:_i(e,r.dblclickCallback),dragstart:Ci(e,r.dragstartCallback),dragend:Ti(e,r.dragendCallback),dragenter:vi(e,r.dragenterCallback),dragover:yi(e,r.dragoverCallback),dragleave:bi(e,r.dragleaveCallback),drop:wi(e,r.dropCallback),selectionchange:Si(e,r.selChangeCallback),focusin:n=>r.focusinCallback?.(n,e),focusout:n=>r.focusoutCallback?.(n,e)}),Ai=(e,t,r,n,a,i)=>{if(i)for(const[s,o]of Object.entries(i))e.addEventListener(s,l=>o(l,r),{signal:t.signal,capture:!0});if(a)for(const[s,o]of Object.entries(a))e.addEventListener(s,l=>o(l,r),{signal:t.signal});e.addEventListener("focusin",s=>{e.childElementCount===0?r.editor.initBody(void 0,!1):f.isRawEditElement(s.target)&&!r.selIsolated&&(r.selection.setInRaw(s.target),r.forceUpdate()),(!s.relatedTarget||!r.body.isNodeInBody(s.relatedTarget))&&(r.editor._markFocused(),setTimeout(()=>{r.editor.isFocused&&(r.update(),requestAnimationFrame(()=>{document.addEventListener("selectionchange",n.selectionchange,{signal:t.signal})}),n.focusin(s))},10))},{signal:t.signal}),e.addEventListener("focusout",s=>{f.isRawEditElement(s.target)&&!r.selIsolated&&r.selection.setInRaw(null),(!s.relatedTarget||!r.body.isNodeInBody(s.relatedTarget))&&(r.editor._markBlurred(),setTimeout(()=>{r.editor.isFocused||(n.focusout(s),document.removeEventListener("selectionchange",n.selectionchange),r._blurCallback())},10))},{signal:t.signal}),e.addEventListener("keydown",n.beforekeydown,{signal:t.signal,capture:!0}),e.addEventListener("keydown",n.keydown,{signal:t.signal}),e.addEventListener("keyup",n.keyup,{signal:t.signal}),e.addEventListener("beforeinput",n.beforeinput,{signal:t.signal}),e.addEventListener("input",n.input,{signal:t.signal}),e.addEventListener("compositionstart",n.compositionstart,{signal:t.signal}),e.addEventListener("compositionupdate",n.compositionupdate,{signal:t.signal}),e.addEventListener("compositionend",n.compositionend,{signal:t.signal}),e.addEventListener("copy",n.copy,{signal:t.signal}),e.addEventListener("cut",n.cut,{signal:t.signal}),e.addEventListener("paste",n.paste,{signal:t.signal}),e.addEventListener("mousedown",n.mousedown,{signal:t.signal}),e.addEventListener("mouseup",n.mouseup,{signal:t.signal}),e.addEventListener("click",n.click,{signal:t.signal}),e.addEventListener("dblclick",n.dblclick,{signal:t.signal}),e.addEventListener("dragstart",n.dragstart,{signal:t.signal}),e.addEventListener("dragend",n.dragend,{signal:t.signal}),e.addEventListener("dragenter",n.dragenter,{signal:t.signal}),e.addEventListener("dragover",n.dragover,{signal:t.signal}),e.addEventListener("dragleave",n.dragleave,{signal:t.signal}),e.addEventListener("drop",n.drop,{signal:t.signal})},ki=class{constructor(e,t,{scrollContainer:r=document.documentElement,autoScrollPaddingX:n=50,autoScrollPaddingY:a=50}={}){this.el=e,this._listeners=t,this._scrollContainer=r,this._autoScrollPaddingX=n,this._autoScrollPaddingY=a}_scrollContainer;_autoScrollPaddingX;_autoScrollPaddingY;get textContent(){return this.el.textContent}get contentText(){return this.el.contentText}get scrollContainer(){return this._scrollContainer}get scrollTarget(){return this._scrollContainer===document.documentElement?document:this._scrollContainer}isBlank(e){return this.el.childNodes.length===1&&e.isPlainParagraph(this.el.firstChild)&&(!this.el.firstChild.textContent||this.el.firstChild.textContent==="​")}handleEvent(e){const t=this._listeners[e.type];if(t)return t(e)}dispatchInputEvent(e,t){this.el.dispatchEvent(new InputEvent(e,{bubbles:!1,cancelable:!0,...t}))}scrollIntoView(e,{toStart:t=!0,paddingX:r=this._autoScrollPaddingX,paddingY:n=this._autoScrollPaddingY,scrollBehavior:a="auto",scrollContainer:i=this._scrollContainer}={}){const s=window.innerHeight,o=window.innerWidth;let l=0,h=0,u=0,g=0;const m=(E,y,N,A,D,$)=>{let W=r,K=n;W>0&&W<1&&(W=W*y),K>0&&K<1&&(K=K*E),l=N+K,h=A-K,u=D+W,g=$-W};if(i!==document.documentElement){const E=i.getBoundingClientRect();if(E.bottom-n<0)return-1;if(E.top+n>window.innerHeight)return 1;m(E.height,E.width,Math.max(0,E.top),Math.min(window.innerHeight,E.bottom),Math.max(0,E.left),Math.min(window.innerWidth,E.right)),(t&&e.left>u&&e.left<g&&e.top>l&&e.top<h||!t&&e.right<g&&e.right>u&&e.bottom<h&&e.bottom>l)&&(i=document.documentElement)}if(i===document.documentElement&&(!this.el.isContentEditable||(m(s,o,0,s,0,o),e.top>l&&e.top<h&&e.bottom<h&&e.bottom>l)))return 0;const{scrollLeft:p,scrollTop:b}=i;let v=p,k=b;return t?(e.top<l?k+=e.top-l:e.top>h&&(k+=e.top-h),e.left<u?v+=e.left-u:e.left>g&&(v+=e.left-g)):(e.bottom>h?k+=e.bottom-h:e.bottom<l&&(k+=e.bottom-l),e.right>g?v+=e.right-g:e.right<u&&(v+=e.right-u)),v===p&&k===b||i.scroll({left:v,top:k,behavior:a}),0}get firstParagraph(){const e=this.el.firstChild;return e&&T.check(e,8)?e:null}get lastParagraph(){const e=this.el.lastChild;return e&&T.check(e,8)?e:null}isNodeInBody(e){return!!e?.isConnected&&this.isNodeContainsOther(this.el,e)}isNodeContainsOther(e,t){if(e===t)return!0;if(e.isConnected!==t.isConnected)return!1;for(;t;){if(e===t)return!0;if(t===this.el)return!1;t=t.parentNode}return!1}outerNodeUnder(e,t){t||(t=this.el);let r=e.parentNode;for(;r&&r!==t;)e=r,r=r.parentNode;return r!==t?null:e}findInclusiveParentByName(e,t){for(;e&&e!==this.el;){if(e.localName===t)return e;e=e.parentNode}return null}findInclusiveEtParent(e){for(;e;){if(e.etCode!==void 0)return e;e=e.parentNode}return null}findInclusiveParagraph(e){for(;e;){if(e===this.el)return null;if(e.etCode&&e.etCode&8)return e;e=e.parentNode}return null}findTopElement(e){return this.outerNodeUnder(e,this.el)}findCommonAncestor(e,t,r=this.el){if(e===t)return this.isNodeInBody(e)?e:null;let n=e,a=0;for(;n&&n!==r;){if(n===t)return n;n=n.parentNode,a++}if(!n)return null;n=t;let i=0;for(;n&&n!==r;){if(n===e)return n;n=n.parentNode,i++}if(!n)return null;if(a>i)for(let s=a;s>i;s--)e=e.parentNode;else if(i>a)for(let s=i;s>a;s--)t=t.parentNode;for(;e&&e!==r;){if(e===t)return e;e=e.parentNode,t=t.parentNode}return r}*outerElements(e,t=Boolean){let r=e.parentElement;for(;r&&r!==this.el;)t(r)&&(yield r),r=r.parentElement}*outerEtElements(e,t=Boolean){let r=this.findInclusiveEtParent(e.parentElement);for(;r&&r!==this.el;)t(r)&&(yield r),r=this.findInclusiveEtParent(r.parentElement)}*outerParagraphs(e){let t=this.findInclusiveParagraph(e.parentElement);for(;t&&t!==this.el;)yield t,t=this.findInclusiveParagraph(t.parentElement)}},Pi=class{_logs=[];logInfo(e,t=""){this._logs.push(`[LOG]${t}\0: ${e}`)}logWarn(e,t=""){this._logs.push(`[WARN]${t}\0: ${e}`)}logError(e,t=""){this._logs.push(`[ERROR]${t}\0: ${e}`)}head(e){return this._logs.slice(0,e)}tail(e){return this._logs.slice(-e)}clear(){this._logs.length=0}flush(e,t){const r=this._logs;t(function*(){for(let a=0;a<r.length;a+=e)if(yield r.slice(a,a+e))return}())&&this.clear()}},Ri=class{constructor(e){this._ctx=e}control(){}edit(){}readonly(){}select(){}},Mi=class{editor;root;schema;assists;actions;pctx;keepDefaultModkeyMap;body;mode;_selection;_connectedSel;_isolatedSel;segmenter;composition;effectInvoker;commandManager;commonHandler;hotkeyManager;hotstringManager;_oldNode=null;_updated=!1;_commonEtElement=null;_focusEtElement=null;_focusParagraph=null;_focusTopElement=null;_skipDefault=!1;_skipNextKeydown=!1;_skipSelChange=!1;_selectionTypeChanged=!1;currDownKey=void 0;prevUpKey;hasInsertText=!1;affinityPreference;__onEffectElementChanged;__onParagraphChanged;__onTopElementChanged;constructor(e){const t=e.contextMeta;this.editor=t.editor,this.schema=t.schema,this.assists=t.assists,this.actions=t.actions,this.pctx=t.pctx,this.keepDefaultModkeyMap={...t.keepDefaultModkeyMap,...ia};const r=Ni(this,e.mainEffector,e.pluginConfigs);Ai(e.bodyEl,e.ac,this,r,e.pluginConfigs.htmlEventSolver,e.pluginConfigs.htmlEventCapturedSolver),this.root=e.root,this.body=new ki(e.bodyEl,r,e.editorBodyOptions),this.mode=new Ri(this),this._selection=new Ut(this,this.body),this._connectedSel=this._selection,this.segmenter=new la(e.locale),this.composition=new pa(this,L.isSupportInsertFromComposition),this.effectInvoker=Qn,this.commandManager=new Pn(this),this.commonHandler=new $n(this),this.hotkeyManager=new Ht(this),this.hotstringManager=new oa(this,e.hotstringOptions),this.__onEffectElementChanged=e.onEffectElementChanged,this.__onParagraphChanged=e.onParagraphChanged,this.__onTopElementChanged=e.onTopElementChanged,this.editor.config.WITH_EDITOR_DEFAULT_LOGGER&&(this.assists.logger=new Pi)}update(){const e=this._selection.type;return this._selection.update()?this._oldNode&&this._oldNode===this._selection.anchorText&&this._focusEtElement?.isConnected?this._updated=!0:(this._oldNode=this._selection.anchorText,this._selection.commonEffectElement?(this._selectionTypeChanged=e!==this._selection.type,this._commonEtElement=this._selection.commonEffectElement,this.focusEtElement=this._selection.focusEffectElement,this.focusParagraph=this._selection.focusParagraph,this.focusTopElement=this._selection.focusTopElement,this._updated=!0):(this.assists.logger?.logError("ctx update failed: common effect element not found. ","EditorContext"),this.editor.blur(),this._updated=!1)):(this.editor.blur(),this._updated=!1)}forceUpdate(){return this.update()?this.skipNextSelChange():!1}isUpdated(){return this._updated}get bodyEl(){return this.body.el}get commonEtElement(){return this._commonEtElement}get focusEtElement(){return this._focusEtElement}set focusEtElement(e){if(this._focusEtElement===e&&!this._selectionTypeChanged)return;const t=this._focusEtElement;this._focusEtElement=e,this.__onEffectElementChanged&&this.__onEffectElementChanged(e,t,this),t&&(t.classList.remove("Et--caret-in"),t!==this._focusParagraph&&t.focusoutCallback?.(this)),e&&(e.classList.add("Et--caret-in"),e.focusinCallback?.(this))}get focusParagraph(){return this._focusParagraph}set focusParagraph(e){if(this._focusParagraph===e&&!this._selectionTypeChanged)return;const t=this._focusParagraph;this._focusParagraph=e,this.__onParagraphChanged&&this.__onParagraphChanged(e,t,this),t&&t!==this._focusTopElement&&t.focusoutCallback?.(this),e&&e!==this._focusEtElement&&e.focusinCallback?.(this)}get focusTopElement(){return this._selection.focusTopElement}set focusTopElement(e){if(this._focusTopElement===e&&!this._selectionTypeChanged)return;const t=this._focusTopElement;this._focusTopElement=e,this.__onTopElementChanged&&this.__onTopElementChanged(e,t,this),t&&t.focusoutCallback&&t.focusoutCallback(this),e&&e!==this._focusParagraph&&e.focusinCallback?.(this)}_blurCallback(){this.selIsolated||(this._updated=!1,this._oldNode=null,this.focusEtElement=null,this.focusParagraph=null,this.focusTopElement=null,this._commonEtElement=null,this._selection.clear(),this.commandManager.closeTransaction())}get selection(){return this._selection}get selIsolated(){return this._selection.isolated}isolateSelection(e){e!==(this._selection===this._isolatedSel)&&(e?(this._isolatedSel||(this._isolatedSel=new fa(this,this.body)),Object.assign(this._isolatedSel,this._connectedSel,{isolated:!0}),this._isolatedSel.range&&this._isolatedSel.selectCaretRange(c.caretIn(this.bodyEl,0)),this._selection=this._isolatedSel):(Object.assign(this._connectedSel,this._isolatedSel,{isolated:!1}),this._selection=this._connectedSel),this.forceUpdate())}get selChangeSkipped(){return this._skipSelChange?(this._skipSelChange=!1,!0):!1}skipNextSelChange(){return this._skipSelChange=!0}get nextKeydownSkipped(){return this._skipNextKeydown?(this._skipNextKeydown=!1,!0):!1}skipNextKeydown(){return this._skipNextKeydown=!0}get defaultSkipped(){return this._skipDefault?(this._skipDefault=!1,!0):!1}skipDefault(){return this._skipDefault=!0}preventAndSkipDefault(e){return e.preventDefault(),this.skipDefault()}setSelection(e){return e&&this._selection.selectCaretRange(e),this.editor.isShadow?(document.dispatchEvent(new Event("selectionchange")),this._selection.update(),!0):this.forceUpdate()}setCaretAffinityPreference(e){this.affinityPreference=e}setCaretToAParagraph(e,t,r=!1){if(T.check(e,64)){r?e.focusToInnerEditable(this,t):requestAnimationFrame(()=>{e.focusToInnerEditable(this,t)});return}if(r)return this.setSelection(t?e.innerStartEditingBoundary().toTextAffinity():e.innerEndEditingBoundary().toTextAffinity());requestAnimationFrame(()=>{this.setSelection(t?e.innerStartEditingBoundary().toTextAffinity():e.innerEndEditingBoundary().toTextAffinity())})}focusToPrevParagraph(e=!1){if(!this._focusParagraph)return;let t=C.treePrevSibling(this._focusParagraph);!this.isEtParagraph(t)&&(t=this._focusTopElement?.previousSibling,!t)||this.setCaretToAParagraph(t,e,!0)}focusToNextParagraph(e=!0){if(!this._focusParagraph)return;let t=C.treeNextSibling(this._focusParagraph);!this.isEtParagraph(t)&&(t=this._focusTopElement?.nextSibling,!t)||this.setCaretToAParagraph(t,e,!0)}focusToBodyStart(){const e=this.bodyEl.firstChild;!e||!this.isEtParagraph(e)?this.commandManager.handleInsertParagraphToBodyStart():this.setCaretToAParagraph(e,!0,!0)}focusToBodyEnd(){const e=this.bodyEl.lastChild;!e||!this.isEtParagraph(e)?this.commandManager.handleInsertParagraphToBodyEnd():this.setCaretToAParagraph(e,!1,!0)}isCaretIn(e){return this._selection.isCollapsed&&this._focusEtElement===e}isEtElement(e){return!!e&&T.check(e)}isEtParagraph(e){return!!e&&T.check(e,8)}isEtComponent(e){return!!e&&T.check(e,64)}isPlainParagraph(e){return!!e&&e.localName===this.schema.paragraph.elName}createPlainParagraph(e=!0){const t=this.schema.paragraph.create();return e?this.appendBrToElement(t):t}appendBrToElement(e){let t;return typeof e=="string"?t=document.createElement(e):t=e,this.editor.config.INSERT_BR_FOR_LINE_BREAK?t.appendChild(document.createElement("br")):t.appendChild(document.createTextNode("​")),t}cloneParagraph(e=this._focusParagraph,t=!0){if(!e)return this.createPlainParagraph(t);if(e.localName===this.schema.paragraph.elName||e.etCode&32||e.etCode&64)return this.createPlainParagraph(t);const r=e.cloneNode(!1);return r.removeAttribute("id"),r.classList.remove("Et--active","Et--caret-in","Et--selected"),r}createEtElementAs(e,t=1){const r=Object.getPrototypeOf(e).constructor.create;return t===1?r():new Array(t).fill(0).map(r)}createText(e){return document.createTextNode(e)}createFragment(e){return e?document.createRange().createContextualFragment(e):document.createDocumentFragment()}getEtHandler(e){return this.effectInvoker.getEtElCtor(e)}toMarkdown(e,t){return this.editor.mdProcessor.toMarkdown(this,e,t)}fromMarkdown(e,t){return this.editor.mdProcessor.fromMarkdown(this,e,t)}},Ii="et-editor.Et--dark,.et-editor.Et--dark,:host(.Et--dark){color-scheme:dark;--et-color-theme: #9971e7;--et-color-bg: oklch(15% 0 0);--et-color-bg-soft: oklch(25% 0 0);--et-color-bg-mute: oklch(30% 0 0);--et-color-bg--hover: oklch(35% 0 0);--et-color-bg--active: oklch(40% 0 0);--et-color-bg__card: var(--et-color-bg-soft);--et-color-bg__item: var(--et-color-bg-mute);--et-color-bg__backdrop: rgb(0 0 0 / .5);--et-color-text: oklch(98% 0 0);--et-color-text-soft: oklab(88% 0 0);--et-color-text-mute: oklch(78% 0 0);--et-color-text-disabled: oklch(68% 0 0);--et-color-caret: #e1e2e3;--et-color-border-1: #222;--et-color-border-2: #333;--et-color-border-3: #444;--et-color-hinting: #9bd;--et-color-selection-all: #3b516f;--et-color-selection-all--blur: #202428}et-editor,.et-editor,:host{color-scheme:light;--et-color-theme: #6621e7;--et-color-bg: oklch(100% 0 0);--et-color-bg-soft: oklch(97% 0 0);--et-color-bg-mute: oklch(95% 0 0);--et-color-bg--hover: oklch(93% 0 0);--et-color-bg--active: oklch(91% 0 0);--et-color-bg__card: var(--et-color-bg);--et-color-bg__item: var(--et-color-bg);--et-color-bg__backdrop: rgb(0 0 0 / .2);--et-color-text: oklch(10% 0 0);--et-color-text-soft: oklab(20% 0 0);--et-color-text-mute: oklch(50% 0 0);--et-color-text-disabled: oklch(60% 0 0);--et-color-caret: #111213;--et-color-border-1: #eee;--et-color-border-2: #ddd;--et-color-border-3: #ccc;--et-color-hinting: #79d;--et-color-selection-all: #b9d4fa;--et-color-selection-all--blur: #dcdcdc;--et-shadow-s: inset 0 1px 1px #ffffff30, 1px 2px 4px rgb(0 0 0 / .2), 1px 4px 6px rgb(0 0 0 / .1), 0 6px 8px rgb(0 0 0 / .1);--et-shadow-m: inset 0 1px 1px #ffffff50, 2px 2px 6px rgb(0 0 0 / .24), 2px 4px 10px rgb(0 0 0 / .12), 0 8px 16px rgb(0 0 0 / .12);--et-shadow-l: inset 0 1px 1px #ffffff70, 3px 3px 6px rgb(0 0 0 / .24), 6px 8px 12px rgb(0 0 0 / .24), 0 12px 16px rgb(0 0 0 / .12);--et-font-size: 15px;--et-font-weight: 449;--et-letter-space: .02em;--et-transition-property: background-color, outline-color, border-color, color;--et-transition-duration: .3s;--et-transition-timing-function: ease-in}et-editor,.et-editor,:host{*,:before,:after{outline:none;box-sizing:border-box}}et-editor,.et-editor,:host{display:flow-root;caret-color:var(--et-color-caret);color:var(--et-color-text-soft);background-color:var(--et-color-bg);font-size:var(--et-font-size);font-weight:var(--et-font-weight);letter-spacing:var(--et-letter-space);transition-property:var(--et-transition-property);transition-duration:var(--et-transition-duration);transition-timing-function:var(--et-transition-timing-function)}",xi=':where(.et-editor,et-editor){padding:16px}et-body,.et-body{display:block!important;outline:none;hyphens:auto;container:et-body / inline-size}et-body.Et--selection-all{background-color:var(--et-color-selection-all--blur);transition:none;&:focus{background-color:var(--et-color-selection-all)}&::selection{background:none}}.Et--selection-node{outline:1px dashed var(--et-color-theme);&::selection{background:none}}.etp{display:block;min-height:1.5em;line-height:1.5}:where(.et-p,et-p).etp{padding-block:.25em;min-height:2em}.Et--hidden{display:none!important}:where([et-title]){position:relative;&:before{content:attr(et-title);display:none;position:absolute;top:-8px;left:50%;translate:-50% -100%;padding:4px;border:1px solid var(--et-color-border-2);border-radius:3px;background-color:var(--et-color-bg__item);color:var(--et-color-text);font-size:9px;white-space:pre;box-shadow:var(--et-shadow-s)}&.Et--selected:before,&:hover:before{display:block;animation:fade-in .3s ease-out}}[et-placeholder]{&:empty:before{content:attr(et-placeholder);color:var(--et-color-text-disabled);font-size:.95em}&:active:before,&:focus:before{content:""}}.Et__bg-item{background-color:var(--et-color-bg__item);&:hover{background-color:var(--et-color-bg--hover)}&:active,&.Et--selected{background-color:var(--et-color-bg--active)}}.Et__card{background-color:var(--et-color-bg__card);box-shadow:var(--et-shadow-l);transition-property:var(--et-transition-property);transition-duration:var(--et-transition-duration);transition-timing-function:var(--et-transition-timing-function)}.Et__trans-cs{--default-property: background-color, outline-color, border-color, color;--default-duration: .3s;--default-timing-function: ease-in;transition-property:var(--et-transition-property, var(--default-property));transition-duration:var(--et-transition-duration, var(--default-duration));transition-timing-function:var(--et-transition-timing-function, var(--default-timing-function))}@keyframes fade-in{0%{opacity:0}to{opacity:1}}@keyframes dropdown-in{0%{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:none}}@keyframes bounce-in{0%{transform:scale(.9)}60%{transform:scale(1.15)}to{transform:none}}',Fi=e=>({keydownSolver:e?.keydownSolver??new rr,keyupSolver:e?.keyupSolver??new ar,beforeInputSolver:e?.beforeInputSolver??new Kt,afterInputSolver:e?.afterInputSolver??new li});function Bi(e){let t={};const r={};for(const n of e)for(const[a,i]of Object.entries(n))if(typeof i=="function")a in r?r[a].push(i):r[a]=[i];else if(typeof i=="object"){let s;(s=t[a])||(s=t[a]={solvers:[],keys:new Set}),s.solvers.push(i),Object.keys(i).forEach(o=>s.keys.add(o))}for(const[n,a]of Object.entries(r))r[n]=n.startsWith("on")?(...i)=>{for(const s of a)s(...i)}:(i,s)=>{for(const o of a)if(o(i,s))return!0};for(const[n,a]of Object.entries(t)){const i=a.solvers.reduce((s,o)=>{for(const l of a.keys){let h=o[l];!h&&!l.startsWith("et-")&&(h=o.default),h&&(l in s?s[l].push(h):s[l]=[h])}return s},{});r[n]=Object.keys(i).reduce((s,o)=>{const l=i[o];return s[o]=(h,u)=>{for(const g of l)if(g(h,u))return!0},s},{})}return e=void 0,t=void 0,r}var Oi=class{_prefers="style";transformersMap;sanitizer;constructor(e,t){this.sanitizer=t?.sanitizer,this.transformersMap={};for(const r of e)if(r)for(const[n,a]of Object.entries(r)){if(!a)continue;const i=this.transformersMap[n];i?i.push(a):this.transformersMap[n]=[a]}}fromHtml(e,t){this.sanitizer&&(t=this.sanitizer(t));const r=document.createDocumentFragment(),n=document.createElement("div");return n.innerHTML=t,this.#t(e,n.childNodes,null,r),r}#e(e,t,r){if(t.localName==="svg")return t;if(!f.isElementOrText(t)||!this.sanitizer&&["script","html","head","meta","link","title","style"].includes(t.localName))return null;if(t instanceof HTMLElement){const n=this.transformersMap[t.localName];if(n)for(const a of n){const i=a(t,e,r);if(i)return typeof i=="function"?i():f.isFragment(i)?this.#t(e,t.childNodes,r):(i.appendChild(this.#t(e,t.childNodes,i)),i)}return this.#t(e,t.childNodes,r)}return null}#t(e,t,r,n){n=n??document.createDocumentFragment();let a=t.item(0);for(;a;){if(a.remove(),f.isText(a))a.data&&a.data!==`
`&&n.appendChild(a);else if(f.isElement(a)){const i=this.#e(e,a,r);i&&n.appendChild(i)}a=t.item(0)}return n}toHtml(e,t,r){r&&(this._prefers=r);let n;return t===void 0||t instanceof G?n=this.#a(e,t??e.bodyEl):t instanceof DocumentFragment?n=this.#i(e,t):n=this.#s(e,t),typeof n=="string"?n:f.isFragment(n)?f.fragmentToHTML(n):n.outerHTML.replaceAll("​","")}#r(e,t){if(e.isEtElement(t))return this.#a(e,t);if(!f.isElementOrText(t)||["script"].includes(t.localName))return null;const r=t.cloneNode(!1);return r.appendChild(this.#n(e,t.childNodes)),r}#a(e,t){const r=t.toNativeElement(e,this._prefers);return r?typeof r=="function"?r():(r.appendChild(this.#n(e,t.childNodes)),r):document.createDocumentFragment()}#n(e,t){const r=document.createDocumentFragment();let n=t.item(0);for(;n;){if(f.isElement(n)){const a=this.#r(e,n);a&&r.appendChild(a)}else f.isText(n)&&r.appendChild(n.cloneNode(!1));n=n.nextSibling}return r}#i(e,t){return this.#n(e,t.childNodes)}#s(e,t){if(t){if(!e.selection.isValidRange(t))return""}else if(t=e.selection.range,!t)return"";return this.#o(e,t)}#o(e,t){const r=e.selection.createTargetRange(t.startContainer,t.startOffset,t.endContainer,t.endOffset);if(!r)return"";const n=document.createDocumentFragment(),{startAncestor:a,endAncestor:i}=r;if(!a||!i)return"";if(a!==i){let u=a.nextSibling;for(;u&&u!==i;){if(f.isElement(u)){const g=this.#r(e,u);g&&n.appendChild(g)}else f.isText(u)&&n.appendChild(u.cloneNode(!1));u=u.nextSibling}}const s=e.schema.body.create();Object.assign(s.style,{position:"fixed",left:"0px",top:"0px",transform:"translate(-110%, -110%)"}),e.root.appendChild(s);const o=document.createRange();o.setStart(r.startNode,r.startOffset),o.setEndAfter(a);const l=o.cloneContents();o.setStartBefore(i),o.setEnd(r.endNode,r.endOffset);const h=o.cloneContents();return s.appendChild(l),n.prepend(this.#n(e,s.childNodes)),s.textContent="",s.appendChild(h),n.appendChild(this.#n(e,s.childNodes)),s.remove(),f.fragmentToHTML(n)}},Li={break:!0,delete:!0,emphasis:!0,footnoteReference:!0,image:!0,imageReference:!0,inlineCode:!0,link:!0,linkReference:!0,strong:!0,text:!0},M=(()=>{let e=1;return{skipHandlers:()=>(e|=2,M),skipSiblings:()=>(e|=4,M),skipChildren:()=>(e|=8,M),skipTheRest:()=>(e|=0,M),revisitCurrentIndex:()=>(e|=32,M),reset:t=>(e=t?t&e?e-t:e:1,M),replaceCurrentNode(t,r,n,a=1){r.children.splice(t,a,...n),this.revisitCurrentIndex()},newNode:t=>t,get handlerSkipped(){return e&2},get siblingsSkipped(){return e&4},get childrenSkipped(){return e&8},get currentRevisited(){return e&32}}})(),Di=(e,t,r,n=document.createDocumentFragment())=>(ir(e,t,n,r),n),Hi=e=>Array.isArray(e.children),Ui=(e,t,r,n,a)=>{const i=a[t.type];if(!i)return t.type==="text"?document.createTextNode(t.value):t.type==="break"?e.editor.config.INSERT_BR_FOR_LINE_BREAK?document.createElement("br"):r.children[n+1]?.type==="text"?document.createTextNode(`
`):document.createTextNode(`
​`):null;for(const s of i){const o=s(t,e,n,r,M);if(M.handlerSkipped)return M.reset(2),o;if(o)return typeof o=="function"?o():M.childrenSkipped?(M.reset(8),o):((o.nodeType===1||o.nodeType===11)&&Hi(t)?ir(e,t,o,a):M.reset(),o)}return null},ir=(e,t,r,n)=>{for(let a=0;a<t.children.length;a++){const i=t.children[a],s=Ui(e,i,t,a,n);if(s&&r.appendChild(typeof s=="function"?s():s),M.currentRevisited){a--,M.reset(32);continue}if(M.siblingsSkipped){M.reset(4);return}}},lt={fromMarkdown:(e,t)=>{const r=dr(e,{extensions:[fr(),...t?.extensions??[]],mdastExtensions:[ur(),...t?.mdastExtensions??[]]});return gr(r),r},toMarkdown:(e,t)=>hr(e,{...t,extensions:[cr(),...t?.extensions??[]]})},sr=(e,t,r)=>typeof e=="object"?e:{type:e,...r,children:ji(t??[],e)},Wi=()=>({type:"break"}),Ki=e=>({type:"text",value:e.data}),ji=(e,t)=>{const r=[];let n=-1,a=-1;for(const i of e)if(n++,T.check(i)){const s=i.toMdast(sr);if(!s)continue;Array.isArray(s)?r.push(...s):r.push(s)}else i.nodeName==="BR"?(r.push(Wi()),(a<0||a!==n-1)&&(a=n)):f.isText(i)&&r.push(Ki(i));return a>=0&&t==="paragraph"&&r.splice(a,r.length-a),r},qi=e=>({type:"root",children:Array.isArray(e)?e:[e]}),Vi=({fromMdHandlerMapList:e,toMdTransformerMapList:t,toMdHandlerMap:r={}})=>{const n=Be(e),a=Be(t);return{toMarkdown(i,s,o){let l=s.toMdast(sr);if(!l)return"";(Array.isArray(l)||l.type!=="root")&&(l=qi(l));const h=[];for(const g of l.children)Li[g.type]||h.push(g);l.children=h,Object.keys(a).length&&lr(l,(g,m,p)=>{const b=a[g.type];if(b){for(const v of b)if(v(g,i,m,p))break}});const u={...r,...o?.handlers};return lt.toMarkdown(l,{...o,handlers:u})},fromMarkdown(i,s,o){const l=lt.fromMarkdown(s,o),h=Di(i,l,n);return w.normalizeToEtFragment(h,i),h}}},zi={" ":(e,t)=>(!e.repeat&&e.key!==t.currDownKey&&t.commandManager.commit(),!1),Enter:(e,t)=>(!e.repeat&&e.key!==t.currDownKey&&t.commandManager.commit(),!1),Tab:(e,t)=>(!e.repeat&&e.key!==t.currDownKey&&t.commandManager.commit(),!1),Backspace:(e,t)=>(!e.repeat&&e.key!==t.currDownKey&&t.commandManager.commit(),!1),Delete:(e,t)=>(!e.repeat&&e.key!==t.currDownKey&&t.commandManager.commit(),!1)},Gi={ArrowDown:(e,t)=>(t.commandManager.commit(),!1),ArrowLeft:(e,t)=>(t.commandManager.commit(),!1),ArrowRight:(e,t)=>(t.commandManager.commit(),!1),ArrowUp:(e,t)=>(t.commandManager.commit(),!1),Home:(e,t)=>(t.commandManager.commit(),!1),End:(e,t)=>(t.commandManager.commit(),!1),PageUp:(e,t)=>(t.commandManager.commit(),!1),PageDown:(e,t)=>(t.commandManager.commit(),!1)},$i={insertParagraph:(e,t)=>(t.commandManager.commit(),!1),insertLineBreak:(e,t)=>(t.commandManager.commit(),!1),insertFromPaste:(e,t)=>(t.commandManager.commit(),!1),deleteWordBackward:(e,t)=>(t.commandManager.commit(),!1),deleteWordForward:(e,t)=>(t.commandManager.commit(),!1)},Qi={historyUndo:(e,t)=>(t.commandManager.undoTransaction(),e.preventDefault(),!0),historyRedo:(e,t)=>(t.commandManager.redoTransaction(),e.preventDefault(),!0)},Zi={compositionstart:(e,t)=>{t.commandManager.commit()},focusout:(e,t)=>{t.commandManager.commit()},mousedown:(e,t)=>{t.commandManager.commit()}},Ji={enforce:"pre",beforeKeydownSolver:zi,keyupSolver:Gi,beforeInputSolver:Qi,afterInputSolver:$i,htmlEventSolver:Zi,onBeforeUnmount(e){e.commandManager.commitAll()}},Xi=()=>({name:"__et_plugin_$undo",effector:Ji}),Q=class extends Error{constructor(){super("EffitorNotMountedError: Editor not yet mounted, mount it first.")}},Yi=(e,t,r,n)=>{const a=new Set,i=[],s=[],o=[],l=[],h=m=>{Object.assign(n.schema,Object.fromEntries(Object.entries(m).filter(([,p])=>p!==void 0)))};function u(m){for(const p of m){if(a.has(p.name))throw Error(`Duplicate plug-in named '${p.name}'.`);a.add(p.name),p.cssText&&l.push(p.cssText),p.elements&&p.elements.forEach(v=>r.push(v));const b=Array.isArray(p.effector)?p.effector:[p.effector];for(const v of b)v.enforce===void 0?i.push(v):v.enforce==="pre"?s.push(v):o.push(v);p.register?.(n,h,$e)}}u(e),u(t);const g=Bi([...s,...i,...o]);return{cssText:l.join(`
`),...g}},us=class or{__host=void 0;__root=void 0;__editorEl=void 0;__body=void 0;__context=void 0;__ac=void 0;__styledDocuments=new WeakSet;__observerDisconnecters=new Map;__meta;status;isShadow;theme;config;htmlProcessor;mdProcessor;callbacks;configManager;_isFocused=!1;get isFocused(){return this._isFocused}get isMounted(){return this.__host!==void 0}get host(){if(!this.__host)throw new Q;return this.__host}get root(){if(!this.__root)throw new Q;return this.__root}get context(){if(!this.__context)throw new Q;return this.__context}get bodyEl(){if(!this.__body)throw new Q;return this.__body}get editorEl(){if(!this.__editorEl)throw new Q;return this.__editorEl}get cssText(){return this.__meta.cssText}constructor({shadow:t=!1,theme:r="",readonly:n=!1,schemaInit:a={editor:un,body:dn,paragraph:fn},mainEffector:i=Fi(),assists:s=[],plugins:o=[],config:l={},configManager:h=new ga,editorStyle:u="",customStyleText:g="",customStyleLinks:m=[],callbacks:p={},hotstringOptions:b=void 0,htmlOptions:v=void 0}={}){t=!1,this.isShadow=t,this.theme=r,this.configManager=h;const k=h.getConfig("editorConfig");this.config={...he,...l,...k},this.config.toString()!==k?.toString()&&h.updateConfig("editorConfig",this.config);const E={editor:this,schema:a,assists:{},actions:{},pctx:{},keepDefaultModkeyMap:{}},y=[];Object.keys(p).length>0&&o.push({name:"$editor-callbacks",effector:{...(()=>{const F={},Qe={};for(const Y in p)Y.startsWith("on")?F[Y]=p[Y]:Qe[Y]=p[Y];return p=Qe,F})()}});const N=Yi([Xi(),...s],o,y,E),A=[],D=[],$=[],W={},K=new WeakSet;y.concat(Object.values(E.schema)).forEach(F=>{K.has(F)||(Ca(F),K.add(F),F.fromNativeElementTransformerMap&&A.push(F.fromNativeElementTransformerMap),F.fromMarkdownHandlerMap&&$.push(F.fromMarkdownHandlerMap),F.toMarkdownTransformerMap&&D.push(F.toMarkdownTransformerMap),Object.assign(W,F.toMarkdownHandlerMap))}),this.status={readonly:n,isDark:!1},this.__meta={editorStyle:u,contextMeta:E,mainEffector:i,cssText:Ii+xi+N.cssText+g,pluginConfigs:N,customStyleLinks:m,hotstringOptions:b},this.htmlProcessor=new Oi(A,v),this.mdProcessor=Vi({fromMdHandlerMapList:$,toMdTransformerMapList:D,toMdHandlerMap:W}),this.callbacks=Object.assign({},Object.fromEntries(Object.entries(N).filter(([F])=>F.startsWith("on"))),p)}clone(t){const r=new or({schemaInit:{}}),{config:n,configManager:a,isShadow:i,status:s,theme:o,htmlProcessor:l,mdProcessor:h,__meta:u,__styledDocuments:g}=this,m=Object.assign({},Object.fromEntries(Object.entries(u.pluginConfigs).filter(([p])=>p.startsWith("on"))),t?.callbacks);return Object.assign(r,{callbacks:m,config:{...n,...t?.config},configManager:t?.configManager??a,isShadow:t?.shadow??i,status:{...s,readonly:t?.readonly},theme:t?.theme??o,htmlProcessor:l,mdProcessor:h,__styledDocuments:g,__meta:{...u,contextMeta:{...u.contextMeta,editor:r,pctx:{}},hotstringOptions:t?.hotstringOptions??u.hotstringOptions}}),r}mount(t,{editorBodyOptions:r,locale:n=L.locale,customStyleLinks:a=[...this.__meta.customStyleLinks]}={}){if(this.__host)if(this.config.ALLOW_MOUNT_WHILE_MOUNTED)this.unmount();else throw Error("Editor already mounted");this.config.USE_HOST_AS_SCROLL_CONTAINER&&(r||(r={}),r.scrollContainer=t);const{contextMeta:i,mainEffector:s,pluginConfigs:o,hotstringOptions:l}=this.__meta,h=new AbortController,[u,g,m]=this.#e(t,a,h.signal),p=new Mi({ac:h,contextMeta:i,root:u,bodyEl:g,locale:n,editorBodyOptions:r,hotstringOptions:l,mainEffector:s,pluginConfigs:o,onEffectElementChanged:this.callbacks.onEffectElementChanged,onParagraphChanged:this.callbacks.onParagraphChanged,onTopElementChanged:this.callbacks.onTopElementChanged});return this.__ac=h,this.__root=u,this.__host=t,this.__editorEl=m,this.__body=g,this.__context=p,this.isShadow&&p.selection.setSelectionGetter(u),this.status.readonly&&this.setReadonly(!0),this.config.AUTO_CREATE_FIRST_PARAGRAPH&&this.initBody(void 0,!0),this.callbacks.onMounted?.(this.context,h.signal),this}unmount(){this.__host&&(this.callbacks.onBeforeUnmount?.(this.context),this.__ac?.abort(),this.__host.innerHTML="",this.__host=void 0,this.__context=void 0,this.cancelObserve())}setColorScheme(t){const r=this.isShadow?this.__root.host:this.__root;if(!r||r.classList.contains("Et--dark")===t){this.status.isDark!==t&&Object.assign(this.status,{isDark:t});return}t?r.classList.add("Et--dark"):r.classList.remove("Et--dark"),Object.assign(this.status,{isDark:t}),this.callbacks.onStatusChanged?.(this.context,"isDark",!t)}setLocale(t){this.context.segmenter.setLocale(t)}setReadonly(t){t!==!this.bodyEl.isContentEditable&&(t?(this.bodyEl.setAttribute("contenteditable","false"),this.context.isolateSelection(!0)):(this.bodyEl.setAttribute("contenteditable","true"),this.context.isolateSelection(!1)),Object.assign(this.status,{readonly:t}),this.callbacks.onStatusChanged?.(this.context,"readonly",!t))}focus(t){if(this._isFocused)return;this._markFocused();const r=this.context;if(this.bodyEl.focus(t),r.selection.restore())r.forceUpdate();else{const n=r.body.lastParagraph;n&&r.setSelection(n.innerEndEditingBoundary())}}_markFocused(){this._isFocused=!0}_markBlurred(){this._isFocused=!1}blur(){this._markBlurred(),this.__body?.blur()}toHTML(t="style",r=!1){const n=this.htmlProcessor.toHtml(this.context,this.bodyEl,t);return r?this.editorEl.toNativeHTML(this.context,t,n):n}fromHTML(t){this.context.commonHandler.updateEditorContentsFromHTML(t)}toMarkdown(t){return this.mdProcessor.toMarkdown(this.context,this.bodyEl,t)}fromMarkdown(t,r){this.context.commonHandler.updateEditorContentsFromMarkdown(t,r)}initBody(t,r=!0){return this.context.commonHandler.initEditorContents(r,t)}clearBody(){return this.context.commonHandler.clearEditorContents(!0)}observeEditor(t,r,n="body"){const a=n==="body"?this.__body:this.root;if(!a)throw new Q;const i=new MutationObserver(t);i.observe(a,r);const s=Symbol();return this.__observerDisconnecters.set(s,o=>{const l=i.takeRecords();l.length&&t(l,i),i.disconnect(),this.__observerDisconnecters.delete(o)}),s}cancelObserve(t){t?this.__observerDisconnecters.get(t)?.(t):this.__observerDisconnecters.entries().forEach(([r,n])=>n(r)),this.__observerDisconnecters.clear()}#e(t,r,n){const a=document.createElement("et-editor"),i=document.createElement("et-body");this.__meta.editorStyle&&(a.style.cssText=this.__meta.editorStyle),this.config.INSERT_BR_FOR_LINE_BREAK||(i.style.whiteSpace="pre-wrap");const s=()=>{for(const h of r){const u=document.createElement("link");u.href=h.href,u.type="text/css",h.preload&&(u.rel="preload",u.as=h.as??"style"),h.onload&&u.addEventListener("load",h.onload,{signal:n}),o.appendChild(u)}};let o;const l=new CSSStyleSheet;return l.replaceSync(this.__meta.cssText),this.isShadow?(o=a.attachShadow({mode:"open"}),o.adoptedStyleSheets=[l],s()):(o=a,this.__styledDocuments.has(document)||(document.adoptedStyleSheets=[...document.adoptedStyleSheets,l],s(),this.__styledDocuments.add(document))),t.innerHTML="",t.append(a),t.classList.add("effitor"),this.theme&&a.setAttribute("et-theme",this.theme),a.append(i),o!==a&&o.append(...a.childNodes),[o,i,a]}},es={};J(es,{CtrlCmd:()=>P,LineModifier:()=>ae,Manager:()=>Ht,Mod:()=>B,WordModifier:()=>V,create:()=>_,createAction:()=>Ot,modKey:()=>Ft,parseHotkey:()=>Bt,withMod:()=>xt});var ts={};J(ts,{create:()=>rs});var rs=(e,t,r)=>new ue(e,t||" ",r);export{G as E,ie as a,ls as b,c,d,T as e,f,C as g,es as h,os as i,cs as j,R as k,ds as l,as as m,fn as n,Rn as o,L as p,hs as q,us as r,ts as s,is as t,ss as u};
