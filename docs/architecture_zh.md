# Effitor 架构设计

## 1. 核心设计理念

Effitor 是一个基于原生 Web 技术构建的现代化富文本编辑器，其核心设计理念是：

- **原生性能优先**：直接操作 DOM，避免抽象数据模型带来的性能开销
- **模块化架构**：清晰的模块划分，便于扩展和维护
- **插件化设计**：核心仅提供基础功能，富文本特性通过插件实现
- **响应式编辑体验**：低延迟的编辑操作，确保流畅的用户体验

## 2. 整体架构

Effitor 采用分层架构设计，主要包含以下核心模块：

```
┌─────────────────────────────────────────────────────────────┐
│                     应用层 (Application)                    │
├─────────────────────────────────────────────────────────────┤
│                     插件系统 (Plugins)                     │
├─────────────────────────────────────────────────────────────┤
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐  │
│  │  编辑器   │  │  效应器   │  │  元素系统 │  │  处理器   │  │
│  │  核心     │  │  (Effector)│  │ (Elements)│  │(Handlers)│  │
│  └───────────┘  └───────────┘  └───────────┘  └───────────┘  │
├─────────────────────────────────────────────────────────────┤
│                     命令系统 (Command)                     │
├─────────────────────────────────────────────────────────────┤
│                     选区系统 (Selection)                    │
├─────────────────────────────────────────────────────────────┤
│                     DOM 操作层 (DOM Layer)                  │
└─────────────────────────────────────────────────────────────┘
```

## 3. 核心模块详解

### 3.1 编辑器核心 (Effitor Class)

`Effitor` 类是编辑器的主入口，负责编辑器的初始化、挂载、卸载以及核心功能的协调。

```typescript
import { Effitor } from "@effitor/core";

const editor = new Effitor({
  shadow: false,
  theme: "default",
  plugins: [
    /* 插件列表 */
  ],
  callbacks: {
    /* 回调函数 */
  },
});

// 挂载编辑器
editor.mount(document.getElementById("editor-container"));

// 卸载编辑器
editor.unmount();
```

**核心职责**：

- 初始化编辑器上下文
- 管理编辑器生命周期
- 协调各模块工作
- 提供对外 API

### 3.2 效应器系统 (Effector)

效应器是编辑器的事件处理核心，负责解析和处理各种用户输入事件。

**工作原理**：

1. 监听 DOM 事件（如 `keydown`、`beforeinput`、`input` 等）
2. 根据事件类型激活对应的效应处理函数
3. 支持插件自定义效应处理
4. 遵循特定的执行顺序（插件效应器 → 主效应器）

**核心组件**：

- `keydownSolver`：处理键盘按下事件
- `beforeInputSolver`：处理输入前事件
- `inputSolver`：处理输入事件
- `clipboardSolver`：处理剪贴板事件
- `mouseSolver`：处理鼠标事件

### 3.3 元素系统 (Elements)

元素系统是 Effitor 的核心创新点，通过 `EffectElement`（效应元素）封装了编辑器中的各种节点。

**核心概念**：

- **EffectElement**：自定义元素基类，所有编辑器节点都继承自它
- **EtEditorElement**：编辑器根元素
- **EtBodyElement**：编辑区主体元素
- **EtParagraphElement**：段落元素
- **EtHeadingElement**：标题元素
- **EtMarkElement**：标记元素（如加粗、斜体等）

**工作原理**：

- 每个效应元素都有唯一的 `etCode` 标识
- 元素内部封装了状态和更新逻辑
- 支持继承和扩展
- 自动处理 DOM 事件委托

### 3.4 处理器系统 (Handlers)

处理器系统负责执行具体的编辑操作，是编辑器的实际执行者。

**核心分类**：

- **命令处理器**：执行基础的 DOM 操作
- **插入处理器**：处理内容插入
- **删除处理器**：处理内容删除
- **格式化处理器**：处理文本格式化

**工作流程**：

1. 效应器激活对应的效应
2. 效应激活器从效应元素上查找对应的处理函数
3. 执行处理函数，生成命令
4. 命令管理器执行并记录命令

### 3.5 命令系统 (Command)

命令系统是编辑器的底层操作引擎，提供了安全、可撤销的 DOM 操作能力。

**核心命令**：

- `Insert_Text`：插入文本
- `Delete_Text`：删除文本
- `Replace_Text`：替换文本
- `Insert_Node`：插入节点
- `Remove_Node`：删除节点
- `Replace_Node`：替换节点
- `Insert_Content`：插入内容片段
- `Remove_Content`：删除内容片段

**命令生命周期**：

1. 创建命令
2. 推入命令栈
3. 执行命令
4. 确认/提交命令
5. 可撤销/重做命令

### 3.6 选区系统 (Selection)

选区系统基于原生 `Selection API` 和 `Range API` 封装，提供了更易用的选区操作接口。

**核心组件**：

- `EtSelection`：选区管理
- `EtRange`：范围管理
- `EtCaret`：光标管理
- `CaretPath`：光标路径

**主要功能**：

- 获取当前选区信息
- 设置选区位置
- 保存和恢复选区
- 选区转换和计算

## 4. 编辑器上下文 (EditorContext)

编辑器上下文是连接各模块的核心枢纽，提供了编辑器运行时的各种状态和工具。

**核心属性**：

- `selection`：选区模块
- `composition`：输入法模块
- `effectInvoker`：效应激活器
- `commandManager`：命令管理器
- `pctx`：插件上下文
- `assists`：助手模块

**工作原理**：

- 每个编辑器实例都有一个独立的上下文
- 上下文在编辑器挂载时创建
- 贯穿编辑器整个生命周期
- 提供模块间通信的桥梁

## 5. 插件系统

Effitor 采用插件化设计，核心仅提供基础功能，富文本特性通过插件实现。

**插件类型**：

- **助手插件**：提供辅助功能，如工具栏、悬浮菜单等
- **内容插件**：扩展编辑器的内容类型，如标题、列表、链接等

**插件结构**：

```typescript
export const usePlugin = (options?: PluginOptions): Et.EditorPlugin => {
  return {
    name: "plugin-name",
    cssText: "", // 插件样式
    effector: {}, // 效应器
    elements: [], // 效应元素
    register(ctxMeta, setSchema, extendEtElement) {
      // 插件注册逻辑
    },
  };
};
```

**插件生命周期**：

1. 编辑器初始化时注册插件
2. 插件注册效应器和效应元素
3. 编辑器挂载时执行插件的 `onMounted` 钩子
4. 编辑器卸载时执行插件的 `onBeforeUnmount` 钩子

## 6. 数据流与事件处理

Effitor 采用事件驱动的数据流设计，主要流程如下：

1. 用户执行编辑操作（如按键、输入文本等）
2. 浏览器触发相应的 DOM 事件
3. 效应器监听并捕获这些事件
4. 效应器根据事件类型激活对应的效应
5. 效应激活器执行效应处理函数
6. 处理函数生成并执行命令
7. 命令修改 DOM 结构
8. 选区系统更新选区状态
9. 触发相应的回调函数

## 7. 性能优化策略

Effitor 采用了多种性能优化策略，确保编辑器在各种场景下都能保持流畅：

- **最小化 DOM 操作**：每次编辑仅修改必要的 DOM 节点
- **事件委托**：减少事件监听器数量
- **命令合并**：合并短时间内的多个相关命令
- **延迟执行**：非关键操作延迟执行
- **高效的选区计算**：优化选区获取和更新算法
- **避免重排/重绘**：合理使用 CSS 和 DOM API

## 8. 未来发展方向

Effitor 仍在不断发展和完善，未来将重点关注以下方向：

- **更好的插件生态**：提供更丰富的官方插件和更好的插件开发体验
- **增强的协作编辑支持**：支持多人实时协作编辑
- **更好的移动端体验**：优化移动端编辑体验
- **更丰富的富文本特性**：支持更多的内容类型和格式化选项
- **更好的可访问性**：符合 WCAG 标准，支持辅助技术

## 9. 总结

Effitor 采用了现代化的架构设计，通过直接操作 DOM 实现了高性能的编辑体验，同时保持了良好的扩展性和可维护性。其核心创新点在于效应元素和效应器系统，为富文本编辑提供了一种全新的思路。

通过清晰的模块划分和插件化设计，Effitor 能够适应各种复杂的编辑场景，从简单的文本编辑到复杂的富文本应用，都能提供出色的性能和用户体验。
